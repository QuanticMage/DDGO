@inherits LayoutComponentBase
@inject ITooltipService TooltipService
@implements IDisposable

<div class="page">
    <main class="content">
        @Body
    </main>
</div>

@if (_isVisible)
{
    <div class="tooltip-box" style="top:@($"{_y}px"); left:@($"{_x}px");">
        @_text
    </div>
}

@code {
    private bool _isVisible;
    private MarkupString _text = default;
    private double _x, _y;

    private bool _subscribed;

    protected override void OnInitialized()
    {
        if (_subscribed) return;
        _subscribed = true;

        TooltipService.OnShow += ShowTooltip;
        TooltipService.OnHide += HideTooltip;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
            await TooltipService.InitializeAsync();
    }

    private void ShowTooltip(string text, double x, double y)
    {
        // Position from getBoundingClientRect() is viewport-relative,
        // so tooltip should be position: fixed in CSS.
        const double dx = 0;
        const double dy = -5; // slight lift above the element

        _ = InvokeAsync(() =>
        {
            _text = new MarkupString(text);
            _x = x + dx;
            _y = y + dy;
            _isVisible = true;
            StateHasChanged();
        });
    }

    private void HideTooltip()
    {
        _ = InvokeAsync(() =>
        {
            _isVisible = false;
            _text = default; // optional, but helps avoid stale flashes
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        if (_subscribed)
        {
            TooltipService.OnShow -= ShowTooltip;
            TooltipService.OnHide -= HideTooltip;
            _subscribed = false;
        }
    }
}
