@* VbSelectMenu.razor *@
@typeparam T

<div class="vbsm" @onkeydown="OnRootKeyDown">
    <div class="vbsm-inline">
        @if (!string.IsNullOrWhiteSpace(Label))
        {
            <span class="vbsm-label">@Label:</span>
        }

        <button type="button"
                class="vbsm-btn"
                aria-haspopup="listbox"
                aria-expanded="@_open"
                @onclick="ToggleOpen"
                @ref="_buttonRef">
            <span class="vbsm-btntext">@SelectedText</span>
            <span class="vbsm-caret" aria-hidden="true">▾</span>
        </button>
    </div>

    @if (_open)
    {
        <div class="vbsm-scrim" @onclick="Close" aria-hidden="true"></div>

        <div class="vbsm-menu"
             role="listbox"
             aria-label="@MenuAriaLabel"
             tabindex="-1"
             @ref="_menuRef"
             @onkeydown="OnMenuKeyDown"
             @onkeydown:preventDefault>
            @for (int i = 0; i < Items.Count; i++)
            {
                var index = i;
                var it = Items[i];
                var isSelected = EqualityComparer<T>.Default.Equals(Value, it.Value);
                var isActive = i == _activeIndex;

                <button type="button"
                        class="vbsm-item @(isSelected ? "active" : "") @(isActive ? "kbd" : "")"
                        role="option"
                        aria-selected="@isSelected"
                        @onclick="() => SelectIndex(index)">

                    <span class="vbsm-text">@it.Text</span>

                    @if (!string.IsNullOrWhiteSpace(it.SubText))
                    {
                        <span class="vbsm-sub">@it.SubText</span>
                    }
                </button>
            }
        </div>
    }
</div>

@code {
    public sealed record Item(T Value, string Text, string? SubText = null);

    [Parameter] public string? Label { get; set; }
    [Parameter] public string AriaLabel { get; set; } = "Select";
    [Parameter] public string MenuAriaLabel { get; set; } = "Options";

    [Parameter, EditorRequired] public IReadOnlyList<Item> Items { get; set; } = Array.Empty<Item>();

    [Parameter] public T Value { get; set; } = default!;
    [Parameter] public EventCallback<T> ValueChanged { get; set; }

    private bool _open;
    private int _activeIndex = 0;

    private ElementReference _menuRef;
    private ElementReference _buttonRef;

    private string SelectedText =>
        Items.FirstOrDefault(x => EqualityComparer<T>.Default.Equals(x.Value, Value))?.Text
        ?? Items.FirstOrDefault()?.Text
        ?? "—";

    protected override void OnParametersSet()
    {
        var idx = Items.ToList().FindIndex(x => EqualityComparer<T>.Default.Equals(x.Value, Value));
        if (idx >= 0) _activeIndex = idx;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_open)
        {
            try { await _menuRef.FocusAsync(); } catch { /* ignore */ }
        }
    }

    private void ToggleOpen()
    {
        _open = !_open;
        if (_open) SnapActiveToSelected();
    }

    private void Close()
    {
        _open = false;
        _ = Task.Run(async () =>
        {
            await Task.Yield();
            try { await _buttonRef.FocusAsync(); } catch { /* ignore */ }
        });
    }

    private void SnapActiveToSelected()
    {
        var idx = Items.ToList().FindIndex(x => EqualityComparer<T>.Default.Equals(x.Value, Value));
        _activeIndex = idx >= 0 ? idx : 0;
    }

    private async Task SelectIndex(int i)
    {
        if (i < 0 || i >= Items.Count) return;
        var next = Items[i].Value;

        Value = next;
        _activeIndex = i;

        if (ValueChanged.HasDelegate)
            await ValueChanged.InvokeAsync(next);

        Close();
    }

    private void MoveActive(int delta)
    {
        if (Items.Count == 0) return;
        _activeIndex = (_activeIndex + delta) % Items.Count;
        if (_activeIndex < 0) _activeIndex += Items.Count;
    }

    private void OnRootKeyDown(KeyboardEventArgs e)
    {
        if (!_open)
        {
            if (e.Key is "Enter" or " " or "ArrowDown")
            {
                ToggleOpen();
            }
        }
        else if (e.Key is "Escape")
        {
            Close();
        }
    }

    private async Task OnMenuKeyDown(KeyboardEventArgs e)
    {
        if (!_open) return;
        switch (e.Key)
        {
            case "Escape":
                Close();
                break;
            case "ArrowDown":
                MoveActive(+1);
                break;
            case "ArrowUp":
                MoveActive(-1);
                break;
            case "Home":
                _activeIndex = 0;
                break;
            case "End":
                _activeIndex = Items.Count - 1;
                break;
            case "Enter":
                await SelectIndex(_activeIndex);
                break;
        }
    }
}