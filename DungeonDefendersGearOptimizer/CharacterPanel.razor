@using System.Text.RegularExpressions
@using DDUP
@using System.Linq
<div class="character-panel">
    <header class="character-panel-header">
        <h3>Character</h3>
    </header>

    <img class="hero-stat-bg" src="png/heroItemBG.png" />
    <img class="hero-equip-bg" src="png/inventoryBG.png" />

    <div class="stat" style="left:148px; top:155px;"><img class="icon" src='png/Hero Health.png' /><span class='stat-val'>+9999</span></div>
    <div class="stat" style="left:236px; top:155px;"><img class="icon" src='png/Hero Damage.png' /><span class='stat-val'>+9999</span></div>
    <div class="stat" style="left:324px; top:155px;"><img class="icon" src='png/Move Speed.png' /><span class='stat-val'>+9999</span></div>
    <div class="stat" style="left:412px; top:155px;"><img class="icon" src='png/Cast Rate.png' /><span class='stat-val'>+9999</span></div>

    <div class="stat" style="left:236px; top:255px;"><img class="icon" src='png/AB1/Monk AB1.png' /><span class='stat-val'>+9999</span></div>
    <div class="stat" style="left:324px; top:255px;"><img class="icon" src='png/AB2/Hero Boost Monk AB2.png' /><span class='stat-val'>+9999</span></div>

    <div class="stat" style="left:148px; top:355px;"><img class="icon" src='png/Tower Health.png' /><span class='stat-val'>+9999</span></div>
    <div class="stat" style="left:236px; top:355px;"><img class="icon" src='png/Tower Damage.png' /><span class='stat-val'>+9999</span></div>
    <div class="stat" style="left:324px; top:355px;"><img class="icon" src='png/Tower Range.png' /><span class='stat-val'>+9999</span></div>
    <div class="stat" style="left:412px; top:355px;"><img class="icon" src='png/Tower Rate.png' /><span class='stat-val'>+9999</span></div>

    <div class="stat" style="left:148px; top:455px;"><img class="icon" src='png/Generic Resistance.png' /><span class='stat-val'>90%</span></div>
    <div class="stat" style="left:236px; top:455px;"><img class="icon" src='png/Poison Resistance.png' /><span class='stat-val'>90%</span></div>
    <div class="stat" style="left:324px; top:455px;"><img class="icon" src='png/Fire Resistance.png' /><span class='stat-val'>90%</span></div>
    <div class="stat" style="left:412px; top:455px;"><img class="icon" src='png/Lightning Resistance.png' /><span class='stat-val'>90%</span></div>


    <div class="equip equip--small" style="left:755px; top:185px;">@(GetEquipmentVisuals("Bracers"))</div>
    <div class="equip equip--small" style="left:555px; top:100px;">@(GetEquipmentVisuals("Brooch"))</div>
    <div class="equip equip--small" style="left:755px; top:100px;">@(GetEquipmentVisuals("Mask"))</div>
    <div class="equip equip--big" style="left:656px; top:125px;">@(GetEquipmentVisuals("Helmet"))</div>
    <div class="equip equip--big" style="left:666px; top:275px;">@(GetEquipmentVisuals("Torso"))</div>
    <div class="equip equip--big" style="left:766px; top:300px;">@(GetEquipmentVisuals("Gauntlet"))</div>
    <div class="equip equip--big" style="left:566px; top:225px;">@(GetEquipmentVisuals("Weapon"))</div>
    <div class="equip equip--big" style="left:640px; top:440px;">@(GetEquipmentVisuals("Boots"))</div>
    <div class="equip equip--big" style="left:766px; top:420px;">@(GetEquipmentVisuals("Extra"))</div>
    <div class="equip equip--big" style="left:540px; top:360px;">@(GetEquipmentVisuals("Pet"))</div>

    <img class="selected-hero-icon"
         src="@SelectedHeroIconUrl"
         alt="Selected hero" />
    <div class="hero-actions">
        <button type="button" class="btn" @onclick ="SelectFromDunClicked">Equip from File</button>
        <button type="button" class="btn" @onclick ="SelectBestClicked">Equip Best</button>
    </div>
    <div style="position: absolute; left:150px; top:65px; ">
        
        <RadioSelect Items="@HeroChoices"
                     Value="@SelectedHero"
                     ValueChanged="OnHeroChanged"
                     Columns="4"
                     Placeholder="Select Hero"
                     IconByClass="@HeroIcons"
                     DefaultIconUrl="png/empty.png" />
    </div>

    <div style="position: absolute; left:310px; top:65px; ">

        <RadioSelect Items="@(Ratings.RatingModes.Select(row => $"{row.Name} ({row.Name})").ToList())"
                     Value="@SelectedRatingMode"
                     ValueChanged="OnRatingModeChanged"
                     Columns="3"
                     Placeholder="Rating Mode"
                     IconByClass="@(Ratings.RatingModes.ToDictionary(row => row.Name, row => row.Icon))"
                     DefaultIconUrl="png/empty.png" 
                     MenuWidth = "clamp(360px, 50vw, 400px)"/>
    </div>


    @inject IJSRuntime JS
    @code {

        public string GetRatingMode() { return SelectedRatingMode ?? ""; }
        private string? SelectedRatingMode;
        private string? SelectedHero;
        public DDHeroInfo? SelectedHeroInfo { get; set; }

        // Raw strings shown in the RadioSelect. Format matters:
        //   "Name (ClassName)" where ClassName is used to pick icons.
        private List<string> HeroChoices { get; set; } = new();
        [Parameter] public EventCallback<string?> OnEquipFromFile { get; set; }
        [Parameter] public EventCallback<string?> OnEquipBest { get; set; }
        [Parameter] public EventCallback<ItemViewRow?> OnClickEquipment { get; set; }
        [Parameter] public EventCallback<ItemViewRow?> OnChangedRatingMode { get; set; }

        private const string DefaultHeroName = "Test Jester";
        private const string DefaultHeroClass = "Jester";
        private Dictionary<int, DDHeroInfo> HeroInfoByIndex = new();

        // key: class name inside parentheses, eg "Apprentice"
        // value: icon url/path, eg "png/Apprentice_TinyIcon.png"
        private Dictionary<string, string> HeroIcons { get; set; }
        = new(StringComparer.OrdinalIgnoreCase);

        private string SelectedHeroIconUrl
        {
            get
            {
                if (string.IsNullOrWhiteSpace(SelectedHero))
                    return "png/empty.png";

                // Expected format: "Name (ClassName)"
                var start = SelectedHero.LastIndexOf('(');
                var end = SelectedHero.LastIndexOf(')');

                if (start < 0 || end <= start)
                    return "png/empty.png";

                var className = SelectedHero.Substring(start + 1, end - start - 1);

                return HeroIcons.TryGetValue(className, out var icon)
                ? icon
                : "png/empty.png";
            }
        }


        public void Reload(List<DDHeroInfo> heroes)
        {
            heroes ??= new();
            HeroInfoByIndex.Clear();
            var choices = new List<string>(heroes.Count + 15);
            var icons = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);

            // Existing heroes
            foreach (var hero in heroes)
            {
                if (hero is null) continue;

                HeroTemplateData? tpl = null;
                if (!string.IsNullOrWhiteSpace(hero.Template))
                    HeroTemplateData.Map.TryGetValue(hero.Template, out tpl);

                HeroInfoByIndex[choices.Count] = hero;
                var className = tpl?.ClassName ?? "Unknown";
                choices.Add($"{hero.Name} ({className})");

                if (tpl is not null && !string.IsNullOrWhiteSpace(tpl.ClassIcon))
                    icons[className] = tpl.ClassIcon;
            }

            // New hero entries, ordered by template Index.
            foreach (var tpl in HeroTemplateData.Map.Values.OrderBy(t => t.Index).Take(15))
            {
                var className = string.IsNullOrWhiteSpace(tpl.ClassName) ? "Unknown" : tpl.ClassName;
                choices.Add($"Test {className} ({className})");

                if (!string.IsNullOrWhiteSpace(tpl.ClassIcon))
                    icons[className] = tpl.ClassIcon;
            }

            HeroChoices = choices;
            HeroIcons = icons;

            // Default selection
            if (string.IsNullOrWhiteSpace(SelectedHero) || !HeroChoices.Contains(SelectedHero))
            {
                SelectedHero = HeroChoices.FirstOrDefault();
                SelectedHeroInfo = HeroInfoByIndex[0];
                _ = InvokeAsync(async () =>
                {
                    if (OnEquipFromFile.HasDelegate)
                        await OnEquipFromFile.InvokeAsync();
                    SetRatingModeFromEquipment();
                });

            }

            // If the current selection no longer exists, clear it.
            if (SelectedHero is not null && !HeroChoices.Contains(SelectedHero))
                SelectedHero = null;           

            StateHasChanged();       

        }

        private void SetRatingModeFromEquipment()
        {
            if (SelectedHeroInfo == null)
                return;

            string bestMode = SelectedHeroInfo.Equipment
                .Where(v => v.cachedItemRow != null &&
                !string.IsNullOrWhiteSpace(v.cachedItemRow.BestFor))
                .GroupBy(v => v.cachedItemRow.BestFor)
                .OrderByDescending(g => g.Count())
                .Select(g => g.Key)
                .FirstOrDefault() ?? "";


            SelectedRatingMode = $"{bestMode} ({bestMode})";
            // since we dson't use the index on this one, just pass it through
            OnRatingModeChanged((SelectedRatingMode, 0));
        }


        private Task OnRatingModeChanged((string?, int) args)
        {
            SelectedRatingMode = args.Item1;
            _ = InvokeAsync(async () =>
            {
                if (OnChangedRatingMode.HasDelegate)
                    await OnChangedRatingMode.InvokeAsync();
            });

            return Task.CompletedTask;
        }

        private Task OnHeroChanged((string?, int ) args)
        {
            string name = args.Item1 ??"";
            int index = args.Item2;
            SelectedHero = name;
            if ((index >= 0) && (index < HeroInfoByIndex.Count))
                SelectedHeroInfo = HeroInfoByIndex[index];
            else
                SelectedHeroInfo = null;

            // Let the UI update immediately (label, etc.) before doing extra work.
            _ = InvokeAsync(async () =>
            {
                if (OnEquipFromFile.HasDelegate)
                    await OnEquipFromFile.InvokeAsync();
                SetRatingModeFromEquipment();
            });

            return Task.CompletedTask;
        }


        private async Task SelectFromDunClicked()
        {
            if (OnEquipFromFile.HasDelegate)
                await OnEquipFromFile.InvokeAsync(SelectedHero);
        }

        private async Task SelectBestClicked()
        {
            if (OnEquipBest.HasDelegate)
                await OnEquipBest.InvokeAsync(SelectedHero);
        }

        
        protected override async Task OnAfterRenderAsync(bool firstRender)
        {
            await JS.InvokeVoidAsync("atlasIcons.renderAllCached");
        }

        // the main index.razor pokes and changes this - encapsulate at some point
        public Dictionary<string, ItemViewRow> EquippedItems = new();

        private static RenderFragment EmptyFragment => builder => { };

        public RenderFragment GetEquipmentVisuals(string slot)
        {
            if (EquippedItems.ContainsKey(slot))
            {
                ItemViewRow row = EquippedItems[slot];
                string tierTag = "tier-" + row.Quality.Replace("+", "plus").ToLowerInvariant();
                string name = Regex.Replace(row.Name, @"\s*\([^()]*\)", "");
                return GetEquipmentRenderVisual(row, tierTag, name);
            }

            return EmptyFragment;
        }

        private RenderFragment GetEquipmentRenderVisual(ItemViewRow r, string tierTag, string name) =>
        @<div @onclick="() => ClickEquipment(r)">
        <img class="frame" src="png/equipFrame.png" alt=""/>
        <img class="atlas-icon overlay"             
             alt=""
             data-size="64"
             data-l1x="@r.IconX" data-l1y="@r.IconY"
             data-l2x="@r.IconX1" data-l2y="@r.IconY1" data-l2t="@r.Color1"
             data-l3x="@r.IconX2" data-l3y="@r.IconY2" data-l3t="@r.Color2" />
        <div class="tag @tierTag">    
            <div class="tag-rating">@r.Rating</div>
            <div class="tag-name">@name</div>
        </div>
        </div>
        ;

        public async Task ClickEquipment(ItemViewRow row )
        {
            if (OnClickEquipment.HasDelegate)
                await OnClickEquipment.InvokeAsync(row);
        }


        //<img class='overlay" @GetEquipmentProps("Torso") alt="">
        public async Task ChangeEquipment(string slot, ItemViewRow? r)
        {
            if (r == null)
                EquippedItems.Remove(slot);
            else
                EquippedItems[slot] = r;
            StateHasChanged();
            await JS.InvokeVoidAsync("atlasIcons.renderAllCached");
        }
    }
   
</div>
@code {
}
