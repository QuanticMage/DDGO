<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dungeon Defenders Gear Optimizer</title>
    <base href="/" />
    <link href="css/app.css" rel="stylesheet" />
    <link href="DDUP.styles.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Belanosima:wght@400&display=swap" rel="stylesheet">

</head>

<body width="100%" >

    <div id="app">Loading...</div>


    <script src="dropzone.js"></script>
    <script src="colresize.js"></script>
    <script src="_framework/blazor.webassembly.js"></script>

    <script>
        window.setupGlobalTooltips = (dotNetHelper) => {
            let helpKeyDown = false;
            let hoveredTarget = null;
            let lastTooltipText = null;   // ⭐ track current tooltip text
            let copiedThisPress = false;  // ⭐ avoid repeat copies while holding H

            const hasNormal = (el) => el?.hasAttribute("data-tooltip");
            const hasHelp = (el) => el?.hasAttribute("h-tooltip");

            const getActiveTooltipText = (el) => {
                if (!el) return null;

                if (helpKeyDown && hasHelp(el)) return el.getAttribute("h-tooltip");
                if (hasNormal(el)) return el.getAttribute("data-tooltip");
                if (helpKeyDown && hasHelp(el)) return el.getAttribute("h-tooltip");

                return null;
            };

            const showFor = (el) => {
                const text = getActiveTooltipText(el);
                if (!text) return;

                lastTooltipText = text; // ⭐ remember it

                const rect = el.getBoundingClientRect();
                dotNetHelper.invokeMethodAsync(
                    "ShowGlobalTooltip",
                    text,
                    rect.left + rect.width / 2,
                    rect.top
                );
            };

            const hide = () => {
                lastTooltipText = null;
                dotNetHelper.invokeMethodAsync("HideGlobalTooltip");
            };

            document.addEventListener("mouseover", (e) => {
                const el = e.target.closest("[data-tooltip],[h-tooltip]");
                if (!el) return;

                hoveredTarget = el;
                showFor(el);
            }, true);

            document.addEventListener("mouseout", (e) => {
                const from = e.target.closest("[data-tooltip],[h-tooltip]");
                if (!from) return;

                if (hoveredTarget && e.relatedTarget && hoveredTarget.contains(e.relatedTarget))
                    return;

                hoveredTarget = null;
                hide();
            }, true);

            window.addEventListener("keydown", async (e) => {
                if (e.key !== "h" && e.key !== "H") return;
                if (helpKeyDown) return;

                helpKeyDown = true;
                copiedThisPress = false;

                if (hoveredTarget && hasHelp(hoveredTarget)) {
                    showFor(hoveredTarget);
                }

                // ⭐ COPY TO CLIPBOARD ON H PRESS
                if (lastTooltipText && !copiedThisPress) {
                    try {
                        await navigator.clipboard.writeText(lastTooltipText);
                        copiedThisPress = true;
                    } catch {
                        // ignore clipboard failures silently
                    }
                }
            }, true);

            window.addEventListener("keyup", (e) => {
                if (e.key !== "h" && e.key !== "H") return;

                helpKeyDown = false;
                copiedThisPress = false;

                if (hoveredTarget) {
                    const text = getActiveTooltipText(hoveredTarget);
                    if (text) showFor(hoveredTarget);
                    else hide();
                } else {
                    hide();
                }
            }, true);
        };

		window.appState = {
			get: (key) => localStorage.getItem(key),
			set: (key, value) => localStorage.setItem(key, value),
			remove: (key) => localStorage.removeItem(key)
		};
    </script>



</body>

</html>
