@implements IDisposable

<div class="searchwrapper">
    <div class="searchbar">
        <span class="searchbar_icon" aria-hidden="true">🔎</span>

        <input class="searchbar_input"
               type="search"
               placeholder="Custom search…"
               @bind="Value"
               @bind:event="oninput"
               @bind:after="HandleAfterInput"
               aria-label="Search items" />      
    </div>
</div>

@code {
    [Parameter] public string Value { get; set; } = "";
    [Parameter] public EventCallback<string> ValueChanged { get; set; }

    // Called after typing stops
    [Parameter] public EventCallback<string> OnDebounced { get; set; }

    private CancellationTokenSource? _cts;

    private async Task HandleAfterInput()
    {
        // 1. Cancel any previous pending search tasks
        _cts?.Cancel();
        _cts?.Dispose();
        _cts = new CancellationTokenSource();

        try
        {
            // 2. Wait for the user to stop typing (300ms is the "sweet spot")
            await Task.Delay(500, _cts.Token);

            // 3. Notify the parent only once typing has paused
            await ValueChanged.InvokeAsync(Value);
            await OnDebounced.InvokeAsync(Value);
        }
        catch (TaskCanceledException)
        {
            // Do nothing, a newer keystroke has started a new timer
        }
    }

    public void Dispose()
    {
        _cts?.Cancel();
        _cts?.Dispose();
    }
}