<div class="searchwrapper">
    <div class="searchbar">
        <span class="searchbar_icon" aria-hidden="true">🔎</span>

        <input class="searchbar_input"
               type="search"
               placeholder="Custom search…"
               value="@_current"
               @oninput="HandleInput"
               @onkeydown="HandleKeyDown" />
    </div>
</div>

@code {
    [Parameter] public string Value { get; set; } = "";
    [Parameter] public EventCallback<string> ValueChanged { get; set; }

    private string _current = "";
    private string _lastSubmitted = "";

    protected override void OnParametersSet()
    {
        var v = Value ?? "";
        if (!string.Equals(v, _current, StringComparison.Ordinal))
        {
            _current = v;
            // Treat external set as the current submitted value to avoid a duplicate enter.
            _lastSubmitted = v;
        }
    }

    private async Task HandleInput(ChangeEventArgs e)
    {
        var newValue = e.Value?.ToString() ?? "";

        // Only fire when transitioning from non-empty -> empty (X / clear)
        if (_current.Length > 0 && newValue.Length == 0)
        {
            _current = "";

            // Optional: avoid duplicate submissions of the same value
            if (_lastSubmitted != "")
            {
                _lastSubmitted = "";
                await ValueChanged.InvokeAsync("");
            }

            return;
        }

        // Normal typing: just update local state, no callback
        _current = newValue;
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            // Submit current value, but do NOT clear the box
            if (_lastSubmitted != _current)
            {
                _lastSubmitted = _current;
                await ValueChanged.InvokeAsync(_current);
            }
        }
    }
}
