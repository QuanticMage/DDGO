<div class="searchwrapper">
    <div class="searchbar">
        <span class="searchbar_icon" aria-hidden="true">🔎</span>

        <input @ref="_inputRef"
               class="searchbar_input"
               type="search"
               placeholder="Custom search…"
               value="@_current"
               @oninput="HandleInput"
               @onkeydown="HandleKeyDown" />
       
    </div>
</div>

@code {
    [Parameter] public string Value { get; set; } = "";
    [Parameter] public EventCallback<string> ValueChanged { get; set; }

    private string _current = "";
    private string _lastParentValue = ""; // Tracks parent's last known value
    private ElementReference _inputRef;

    protected override void OnParametersSet()
    {
        var incomingValue = Value ?? "";

        // Only overwrite local state if the PARENT sent a new value
        if (incomingValue != _lastParentValue)
        {
            _current = incomingValue;
            _lastParentValue = incomingValue;
        }
    }

    private void HandleInput(ChangeEventArgs e)
    {
        _current = e.Value?.ToString() ?? "";
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SubmitSearch();
        }
    }

    private async Task ClearSearch()
    {
        _current = "";
        await SubmitSearch();
        await _inputRef.FocusAsync(); // Focus back on input so they can type immediately
    }

    private async Task SubmitSearch()
    {
        // Update tracker to prevent OnParametersSet from reverting this change
        _lastParentValue = _current;
        await ValueChanged.InvokeAsync(_current);
    }
}