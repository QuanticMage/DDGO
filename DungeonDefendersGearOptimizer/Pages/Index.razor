@page "/"
@implements IAsyncDisposable
@using Microsoft.JSInterop
@using System.Text
@using System.Text.Json
@using System.Text.RegularExpressions
@using System.Globalization
@using System.Collections.Immutable
@using System.IO.Compression
@inject HttpClient Http

<div class="top-pane">
    <div class="left-pane">
        <h1>Dungeon Defenders Gear Optimizer</h1>
        <div class="build"><i>Feb 19 2026 - Version 1.8</i></div>
        <div id="@_dropZoneId" class="dropzone dz2 @( _isDragOver ? "over" : "" )">

            @* ============== EMPTY FILE TILE, BEFORE WE'VE LOADED ============== *@            
            @if (!_showContent)
            {
                <div class="dz2-card">

                    <div class="dz2-sub">
                        Select your data file to get started.
                    </div>

                    <div class="dz2-drop">
                        <div class="dz2-drop-inner">
                            <div class="dz2-drop-icon" aria-hidden="true">📁</div>
                            <div class="dz2-drop-text">Drag &amp; Drop File Here</div>
                            <div class="dz2-drop-hint">
                                Drag your <b>DunDefHeroes.dun</b> file into this box
                            </div>
                        </div>
                    </div>

                    <div class="dz2-or">
                        <span class="dz2-or-line"></span>
                        <span class="dz2-or-text">Or</span>
                        <span class="dz2-or-line"></span>
                    </div>

                    <button type="button" class="dz2-btn dz2-btn-primary" @onclick="OpenFileDialog">
                        <span class="dz2-btn-icon" aria-hidden="true">📁</span>
                        <span>Browse for file…</span>
                    </button>

                    <button type="button"
                            class="dz2-help"
                            aria-expanded="@(!_hideDropzoneHelp)"
                            @onclick="TogglePrepHelp">
                        <span class="dz2-help-caret" aria-hidden="true">@(_hideDropzoneHelp ? "▸" : "▾")</span>
                        <span>How do I find or prepare the file?</span>
                    </button>

                    <div class="dz2-help-body @( _hideDropzoneHelp ? "hidden" : "" )">
                        <ul>
                            <li>Run Dungeon Defenders, log into Ranked, then click Export to Open</li>
                            <li>Go to Dungeon Defenders in your Steam library, right-click, Manage &gt; Browse Local Files</li>
                            <li>Then open the Binaries\Win32 or Win64 folder (whichever you run), and drag <b>DunDefHeroes.dun</b> here.</li>
                            <li>This runs locally. @*Only aggregate armor ratings are sent to Shiro’s API for live prices, and only if you enable live prices.*@</li>
                        </ul>

                        @if (_canLoadLast)
                        {
                            <div class="dz2-actions">
                                <button type="button" class="dz2-btn dz2-btn-dark" @onclick="LoadLastFile">
                                    <span class="dz2-btn-icon" aria-hidden="true">⟳</span>
                                    <span>Reload last file from disk (Chrome/Edge)</span>
                                </button>
                            </div>
                        }
                    </div>
                </div>
            }
            else
  @* ============== LOADED FILE TILE ============== *@          
            {
                <div class="dz2-card-loaded">
                    <div class="dz2-filename">@_loadedFileName</div>
                    @* status *@
                    @if (_isLoading)
                    {
                        <div class="status">Loading… @_status</div>
                    }
                    else if (!string.IsNullOrEmpty(_error))
                    {
                        <div class="status error">@_error</div>
                    }
                    else if (!string.IsNullOrEmpty(_status))
                    {
                        <div class="status">@_status</div>
                        @_status2
                    }
                    <div class="dz2-actions">
                        @if (_canLoadLast)
                        {
                            <button type="button" class="dz2-btn dz2-btn-ghost" @onclick="LoadLastFile">
                                <span class="dz2-btn-icon" aria-hidden="true">⟳</span>
                                <span>Reload</span>
                            </button>
                        }

                        <button type="button" class="dz2-btn dz2-btn-ghost" @onclick="OpenFileDialog">
                            <span>Load new</span>
                        </button>
                        <button type="button" class="dz2-btn dz2-btn-ghost" @onclick="ExportToCSV">
                            <span>Export to .csv</span>
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>

    @* ============== CREDITS AND LINK PANE ============== *@     
    <aside class="info-pane">
        <div class="credits">
            <div class="credits-top-row">
                <div class="credits-by">Created by <i>Mage (&#64;entangledmage)</i></div>
                <button type="button"
                        class="theme-toggle @(_ui.Theme == "dark" ? "theme-toggle--active" : "")"
                        title="Toggle dark mode"
                        @onclick="@(() => SetUi(u => u with { Theme = u.Theme == "dark" ? "light" : "dark" }))">
                    <svg class="theme-toggle-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/>
                    </svg>
                </button>
            </div>
            <div class="credits-thanks">Based on item DB by <i>Tbolt</i>, using price estimates by <i>Shiro and Sesar</i></div>
            <div class="credits-thanks">Special Thanks to <i>Cerium, Chiku, Favon, Renim, Scryllix, Shiro,</i></div>
            <div class="credits-thanks"><span style="margin-left:110px;"></span><i>Sesar, SteveTrevor, Tbolt, Thales, and Theoran</i></div>
        </div>

        <h3 class="links-title">Quick Links</h3>
        <ul class="link-list">
            <li><a href="https://dungeondefenders.wiki.gg" rel="noopener">Dungeon Defender's Wiki</a></li>
            <li><a href="https://steamcommunity.com/sharedfiles/filedetails/?id=2968079729" rel="noopener">Chiku’s Guide</a></li>
            <li><a href="https://docs.google.com/spreadsheets/d/11v0h3LLUDYEkTxvkLVWUzYv8wXvjZ1cPTJJ-o1QqVDM/edit?gid=1598543540#gid=1598543540" rel="noopener">Best-in-Slot Doc</a></li>
            <li><a href="https://www.dundefplanner.com" target="_blank" rel="noopener">DunDefPlanner for sharing layouts</a></li>
            <li><a href="https://docs.google.com/spreadsheets/d/1XzYuWB4I9RoNe8x-DD2M1koWs72tW8sTgyQ_n-d7l-E/edit?pli=1&gid=2059687993#gid=2059687993" rel="noopener">Event price sheet</a></li>
        </ul>
    </aside>
</div>

@if (@_showContent)
{
    <div class="main-content">
        <div class="character-row" style="@(_compactDisplay?"zoom:0.8;":"")">
            @for (int _si = 0; _si < _panelSlots.Count; _si++)
            {
                var slot = _panelSlots[_si];
                var slotIndex = _si;
                <div class="panel-slot @(slotIndex == _activePanelIndex ? "panel-active" : "")" @key="slot.Id" @onclick="() => SetActivePanel(slotIndex)">
                    <CharacterPanel @ref="slot.Panel"
                                    OnEquipFromFile="() => HandleEquipFromFile(slot)"
                                    OnEquipBest="() => HandleEquipBest(slot)"
                                    OnEquipClear="() => HandleEquipClear(slot)"
                                    OnClickEquipment="HandleEquipmentClick"
                                    OnRightClickEquipment="HandleEquipmentRightClick"
                                    OnChangedRatingMode="HandleChangedRatingMode"
                                    OnChangedHero="HandleChangedHero"
                                    GetLocationFunc="GetLocation" />
                    <div class="panel-controls">
                        <label class="panel-lock" @onclick:stopPropagation="true" data-tooltip="Lock: equipped items won't be reassigned by Equip Best on other panels">
                            <input type="checkbox" checked="@slot.IsLocked"
                                   @onchange="@((e) => { slot.IsLocked = (bool)e.Value!; StateHasChanged(); })" />
                            <span>Lock</span>
                        </label>
                        @if (_panelSlots.Count > 1)
                        {
                            <button type="button" class="panel-remove-btn" title="Remove this hero panel" @onclick:stopPropagation="true" @onclick="() => RemoveCharacterPanel(slot.Id)">×</button>
                        }
                    </div>
                </div>
            }
            <button type="button" class="panel-add-btn" @onclick="AddCharacterPanel">+ Add Hero</button>
        </div>

        <div class="filters-bar" style="@(_compactDisplay?"zoom:0.9;":"")">
            <div class="utility-row">
                <span class="utility-label"><font face="Arial">⚙️</font></span>

                <label class="utility-toggle" data-tooltip=@Tips["Censor"]>
                    <input type="checkbox"
                           class="tool-filter"
                           checked="@_ui.Censor"
                           @onchange="@((e) => SetUi(u => u with { Censor = (bool)e.Value!}))" />
                    <span>Censor Ult++</span>
                </label>

                <label class="utility-toggle" data-tooltip=@Tips["ShowUpgraded"]>
                    <input type="checkbox"
                           class="tool-filter"
                           checked="@_ui.ShowUpgradedStats"
                           @onchange="@((e) => SetUi(u => u with { ShowUpgradedStats = (bool)e.Value!}))" />
                    <span>Show as upgraded</span>
                </label>
                <label class="utility-toggle" data-tooltip=@Tips["AssumeSetBonuses"]>
                    <input type="checkbox"
                           class="tool-filter"
                           checked="@_ui.AssumeSetBonuses"
                           @onchange="@((e) => SetUi(u => u with { AssumeSetBonuses = (bool)e.Value!}))" />
                    <span>Show with set bonus</span>
                </label>
                
                <label class="utility-toggle" data-tooltip=@Tips["CompactDisplay"]>
                    <input type="checkbox"
                           class="tool-filter"
                           checked="@_compactDisplay"
                           @onchange="@((e) => { _compactDisplay = (bool)e.Value!; QueueSaveUiState(); StateHasChanged(); })" />
                    <span>Compact Display</span>
                </label>
                <label class="utility-toggle" data-tooltip=@Tips["SidesAreImportant"]>
                    <input type="checkbox"
                           class="tool-filter"
                           checked="@_ui.SidesAreImportant"
                           @onchange="@((e) => SetUi(u => u with { SidesAreImportant = (bool)e.Value!}))" />
                    <span>Best includes sides</span>
                </label>


                <label class="utility-select" data-tooltip=@Tips["ItemBoxSize"]>
                    <span>Itembox size</span>
                    <select value="@_ui.ItemBoxLayout" @onchange="@((e)=>SetUi(u => u with { ItemBoxLayout = e.Value?.ToString() ?? u.ItemBoxLayout}))" font="inherit">
                        <option value="5x3">5x3</option>
                        <option value="4x3">4x3</option>
                        <option value="6x4">6x4</option>
                    </select>
                </label>
                
                @* <label class="utility-toggle" data-tooltip=@Tips["LivePrices"]>
                    <input type="checkbox"
                           class="tool-filter"
                           checked="@_livePrices"
                           @onchange="@((e) => { _livePrices = e.Value is bool b && b; QueueSaveUiState(); if (_livePrices) GetLivePrices(); })" />
                    <span>Get Live Prices</span>
                </label> *@
                @*
                <label class="utility-select" data-tooltip=@Tips["DPSMode"]>
                    <span>DPS Mode</span>
                    <select value="@_dpsMode" @onchange="OnDPSModeChanged" font="inherit">
                        <option value="Single Target">Single Target</option>
                        <option value="AoE">AoE</option>                        
                    </select>
                </label>*@
            </div>

            <div class="filters-row">
                <FilterChips Title="Type" Theme="type"
                             Options="_typeOptions"
                             Placeholder="Any"
                             ShowNoneAll="true"
                             MenuMaxHeightPx="520"
                             @bind-Selected="SelectedTypes"
                             Presets="@(new[]
                                                  {
                                                  new FilterChips.Preset("Armor", new [] { "Helmet", "Gauntlet", "Boots", "Torso"}),
                                                  new FilterChips.Preset("Accessories", new [] { "Brooch", "Mask", "Bracers", "Shield" }),                                                                                             
                                            })" />

            <FilterChips Title="Set" Theme="set"
                         Options="_setOptions"
                         Placeholder="Any"
                         ShowNoneAll="true"
                         MenuMaxHeightPx="520"
                         @bind-Selected="SelectedSets"
                         Presets="@(new[]
                                              {
                                                  new FilterChips.Preset("Armor", new [] { "Pristine", "Plate", "Chain", "Mail", "Leather", "Zamira"}),
                                                  new FilterChips.Preset("Weapons", new [] { "Squire", "Apprentice", "Monk", "Huntress"}),
                                              })" />

            <FilterChips Title="Other" Theme="other"
                         Options="_otherOptions"
                         Placeholder="None"
                         @bind-Selected="SelectedOther" />
            @if (_showFilterHelp)
                {
                    <div class="tooltip-backdrop" @onclick="CloseFilterHelp"></div>
                }

                <div class="filter-search-row">
                    <div class="filter-history" @onclick:stopPropagation="true">
                        <button type="button"
                                class="filter-search-label"
                                aria-haspopup="true"
                                aria-expanded="@_searchHistoryOpen"
                                @onclick="ToggleSearchHistory">
                            Custom <span class="fg-caret" aria-hidden="true">▾</span>
                        </button>

                        @if (_searchHistoryOpen)
                        {
                            <div class="fg-backdrop" @onclick="CloseSearchHistory"></div>

                            <div class="fg-menu"
                                 style="--menuMaxHeight:320px;"
                                 @onclick:stopPropagation="true">
                                <div class="fg-menu-header">
                                    <div class="fg-menu-title">Recent</div>
                                    <div class="fg-menu-actions">
                                        <button type="button" class="fg-action" @onclick="ClearSearchHistoryAsync">Clear</button>
                                    </div>
                                </div>

                                @if (_searchHistory.Count == 0)
                                {
                                    <div class="fg-placeholder">No recent searches</div>
                                }
                                else
                                {
                                    @foreach (var item in _searchHistory)
                                    {
                                        <button type="button"
                                                class="fg-menuitem"
                                                @onclick="() => ApplySearchHistory(item)">
                                            @item
                                        </button>
                                    }
                                }
                            </div>
                        }
                    </div>

                    <div class="filter-search-control" @onclick:stopPropagation="true">

                        <SearchBar Value="@_searchText" ValueChanged="ApplySearch" />

                        <span class="help-wrap">
                            <button type="button"
                                    class="help-icon @(_showFilterHelp ? "toggled" : "")"
                                    aria-label="Search help"
                                    aria-expanded="@_showFilterHelp"
                                    aria-controls="custom-filter-tooltip"
                                    @onclick="ToggleFilterHelp">
                                ?
                            </button>

                            @if (_showFilterHelp)
                            {
                                <div id="custom-filter-tooltip"
                                     class="tt"
                                     role="tooltip"
                                     @onclick:stopPropagation="true">
                                    <div class="tt-title">Custom Filter</div>
                                    <div class="tt-row">
                                        Filter with one or more constraints (you can combine terms and expressions)
                                    </div>

                                    <div class="tt-divider"></div>

                                    <div class="tt-sub">Examples</div>

                                    <div class="tt-row">
                                        <span class="k">Text</span>
                                        <span class="v"><code>Dragon</code> → Name contains 'Dragon'</span>
                                    </div>

                                    <div class="tt-row">
                                        <span class="k">Field</span>
                                        <span class="v"><code>Location:ItemBox</code> → Location contains 'ItemBox'</span>
                                    </div>

                                    <div class="tt-row">
                                        <span class="k">Compare</span>
                                        <span class="v"><code>Ab1&gt;=500</code> → Ability 1 is greater or equal to 500</span>
                                    </div>

                                    <div class="tt-row">
                                        <span class="k">Math</span>
                                        <span class="v"><code>(TDmg+TRate)&gt;=1000</code> → supports arithmetic</span>
                                    </div>

                                    <div class="tt-row">
                                        <span class="k">Logic</span>
                                        <span class="v"><code>Quality=ult++ and (Sides&gt;500 or Rating&gt;1000)</code></span>
                                    </div>

                                    <div class="tt-row">
                                        <span class="k">Exclude</span>
                                        <span class="v"><code>Best!:Hermit</code> → Best does NOT contain 'Hermit'</span>
                                    </div>

                                    <div class="tt-divider"></div>

                                    <div class="tt-sub">Operators</div>
                                    <div class="tt-inline">
                                        <code>:</code> contains&nbsp;&nbsp;
                                        <code>=</code> equals&nbsp;&nbsp;
                                        <code>!=</code> not equals&nbsp;&nbsp;
                                        <code>&gt; &gt;= &lt; &lt;=</code> compare&nbsp;&nbsp;
                                        <code>!:</code> does not contain
                                    </div>
                                    <div class="tt-inline" style="margin-top:4px;">
                                        <code>( )</code> group&nbsp;&nbsp;
                                        <code>+</code> add&nbsp;&nbsp;
                                        <code>-</code> subtract&nbsp;&nbsp;
                                        <code>*</code> multiply&nbsp;&nbsp;
                                        <code>/</code> divide&nbsp;&nbsp;
                                        <code>!</code> boolean not&nbsp;&nbsp;
                                        <code>and</code>&nbsp;&nbsp;
                                        <code>or</code>&nbsp;&nbsp;
                                        <code>not</code>&nbsp;&nbsp;
                                    </div>

                                    <div class="tt-sub">Fields</div>
                                    <div class="tt-fields">
                                        <code>THP</code><code>TDmg</code><code>TRate</code><code>TRange</code>
                                        <code>HHP</code><code>HDmg</code><code>HRate</code><code>HSpeed</code>
                                        <code>Ab1</code><code>Ab2</code>
                                        <code>ResG</code><code>ResP</code><code>ResF</code><code>ResL</code>
                                        <code>Location</code><code>Quality</code><code>Rating</code><code>Sides</code>
                                        <code>Lvl</code><code>MaxLvl</code><code>ResSum</code><code>ResAvg</code>
                                        <code>Value</code><code>Name</code>
                                    </div>

                                    <div class="tt-note">
                                        Enclose strings in &quot;double quotes&quot; to compare with spaces.
                                    </div>
                                </div>
                            }
                    </span>
                    <div class="filter-error">@_customFilterError</div>
                </div>
            </div>
        </div>


            <div class="summary">@_summary</div>
            <div class="stats-row">
                <div class="metric-card highlighted-card">
                    <span class="metric-label">Equipped Armor Rating</span>
                    <div class="metric-main">
                        <span class="metric-number">@EquippedArmorRating</span>
                        <span class="metric-type  highlighted-card-type">@EquippedArmorSet</span>
                    </div>
                </div>

                <div class="metric-card">
                    <span class="metric-label">Vanity Account Armor Total</span>
                    <div class="metric-main">
                        <span class="metric-number">@ArmorTotalValue</span>
                        <span class="metric-type">CV</span>
                    </div>
                </div>

                <div class="metric-card">
                    <span class="metric-label">Vanity Account Event Total</span>
                    <div class="metric-main">
                        <span class="metric-number">@EventTotalValue</span>
                        <span class="metric-type">CV</span>

                        <button type="button" class="metric-mini-pill" @onclick="ShowEventCollection">
                            @CollectedEventCount / @TotalEventCount
                        </button>
                    </div>

                </div>
            </div>

            @if (_showEventCollection)
            {
                <div class="event-overlay-backdrop" @onclick="CloseEventCollection" role="presentation">
                    <div class="event-overlay-panel" role="dialog" aria-modal="true" aria-label="Event collection" @onclick:stopPropagation="true">
                        <div class="event-overlay-header">
                            <div class="event-overlay-titlewrap">
                                <div class="event-overlay-title">Event Collection</div>
                                <div class="event-overlay-sub">@CollectedEventCount / @TotalEventCount collected</div>
                            </div>
                            <button type="button" class="event-overlay-export" title="Export" @onclick="ExportEventCollection">Copy To Clipboard</button>
                            <button type="button" class="event-overlay-close" title="Close" @onclick="CloseEventCollection">×</button>
                        </div>

                        <div class="event-overlay-tools">
                            <input class="event-search"
                                   placeholder="Search categories…"
                                   @onchange="OnEventSearchChanged" />
                        </div>

                        <div class="event-overlay-body">
                            @foreach (var group in VisibleEventCollection
                                                .GroupBy(x => x.Category)
                                                .OrderBy(g => GetCategoryOrderKey(g.Key))
                                                .ThenBy(g => g.Key, StringComparer.OrdinalIgnoreCase))
                            {
                            var cat = SplitCategory(group.Key);
                                <div class="event-cat">
                                    <div class="event-cat-hdr">
                                        <span class="event-cat-page">@cat.Page</span>
                                        <span class="event-cat-sep">›</span>
                                        <span class="event-cat-section">@cat.Section</span>
                                    </div>

                                    <div class="event-list">
                                        @foreach (var item in group
                                                                    .OrderByDescending(x => x.Price)
                                                                    .ThenBy(x => x.Name, StringComparer.OrdinalIgnoreCase)
                                                                    )
                                        {
                                            <div class="event-row @(item.OwnedCount > 0 ? "owned" : "missing")">
                                                <div class="event-line">
                                                    <div class="event-name">@item.Name</div>
                                                    <div class="event-price">@(item.Price != 0 ? @item.Price : "Unknown") CVx</div>
                                                    <span class="event-owned-badge" title="How many of this item you have">@item.OwnedCount</span>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
    </div>

<div class="bottom-pane">

    @if (_rows.Count == 0)
    {
    }
    else
    {
        <div class='grid-wrap @(_gridReady ? "" : "grid-hidden")' @ref="_scrollRef" style="--overlay-height:@($"{_overlayHeightPx}px")">
            <div class="overlay-layer" aria-hidden="true">
                @foreach (var slot in _panelSlots)
                {
                    if (slot.Panel is not null)
                    {
                        @foreach (var e in slot.Panel.EquippedItems)
                        {
                            <div class="row-highlight" @key=@($"{slot.Id}_{e.Key}")
                                 style="transform: translateY(@($"{e.Value.CachedY}px")); height: @($"{e.Value.CachedHeight}px"); opacity: 1;">
                            </div>
                        }
                    }
                }
            </div>
            <table class="grid @(_compactDisplay?"compact-table":"")" @ref="_tableRef">
                <colgroup>
                    <col style="width:80px" />   @* Rating *@
                    <col style="width:70px" />   @* Value *@
                    <col style="width:65px" />   @* BestFor *@
                    <col style="width:65px" />   @* Type *@
                    <col style="width:70px" />   @* Position *@

                    <col style="width:15%" />    @* Name (2*) *@
                    <col style="width:10%" />    @* Location (2*) *@
                    <col style="width:60px" />   @* Quality *@

                    <col style="width:50px" />   @* MaxLvl *@
                    <col style="width:50px" />   @* Lvl *@
                    <col style="width:65px" />   @* Damage *@                    
                    <col style="width:55px" />   @* HHP *@
                    <col style="width:55px" />   @* HDmg *@
                    <col style="width:55px" />   @* HSpd *@
                    <col style="width:55px" />   @* HRate *@
                    <col style="width:55px" />   @* Ab1 *@
                    <col style="width:55px" />   @* Ab2 *@
                    <col style="width:55px" />   @* THP *@
                    <col style="width:55px" />   @* TDmg *@
                    <col style="width:55px" />   @* TRange *@
                    <col style="width:55px" />   @* TRate *@
                    <col style="width:55px" />   @* RG *@
                </colgroup>

                <thead>
                    <tr class="rating-row">
                        <th colspan="11">

                            <span class="hint-text">
                                <span class="hint-left">
                                    @VisibleCount / @TotalCount items visible
                                </span>

                                <span class="hint-right">
                                    Click names to sort, or stars to adjust the rating calculation →
                                </span>
                            </span>
                        </th>
                        <th class="importance-cell">
                            <div class="th-center">
                                <button type="button" data-tooltip=@ImportanceTooltip(DDStat.HeroHealth)
                                        @onclick="() => ChangeImportance(DDStat.HeroHealth)">
                                    <img src="@GetImportanceImage(DDStat.HeroHealth)" />
                                </button>
                            </div>
                        </th>

                        <th class="importance-cell">
                            <div class="th-center">
                                <button type="button" data-tooltip=@ImportanceTooltip(DDStat.HeroDamage)
                                        @onclick="() => ChangeImportance(DDStat.HeroDamage)">
                                    <img src="@GetImportanceImage(DDStat.HeroDamage)" />
                                </button>
                            </div>
                        </th>
                        <th class="importance-cell">
                            <div class="th-center">
                                <button type="button" data-tooltip=@ImportanceTooltip(DDStat.HeroSpeed)
                                        @onclick="() => ChangeImportance(DDStat.HeroSpeed)">
                                    <img src="@GetImportanceImage(DDStat.HeroSpeed)" />
                                </button>
                            </div>
                        </th>

                        <th class="importance-cell">
                            <div class="th-center">
                                <button type="button" data-tooltip=@ImportanceTooltip(DDStat.HeroCastRate)
                                        @onclick="() => ChangeImportance(DDStat.HeroCastRate)">
                                    <img src="@GetImportanceImage(DDStat.HeroCastRate)" />
                                </button>
                            </div>
                        </th>

                        <th class="importance-cell">
                            <div class="th-center">
                                <button type="button" data-tooltip=@ImportanceTooltip(DDStat.HeroAbility1)
                                        @onclick="() => ChangeImportance(DDStat.HeroAbility1)">
                                    <img src="@GetImportanceImage(DDStat.HeroAbility1)" />
                                </button>
                            </div>
                        </th>

                        <th class="importance-cell">
                            <div class="th-center">
                                <button type="button" data-tooltip=@ImportanceTooltip(DDStat.HeroAbility2)
                                        @onclick="() => ChangeImportance(DDStat.HeroAbility2)">
                                    <img src="@GetImportanceImage(DDStat.HeroAbility2)" />
                                </button>
                            </div>
                        </th>

                        <th class="importance-cell">
                            <div class="th-center">
                                <button type="button" data-tooltip=@ImportanceTooltip(DDStat.TowerHealth)
                                        @onclick="() => ChangeImportance(DDStat.TowerHealth)">
                                    <img src="@GetImportanceImage(DDStat.TowerHealth)" />
                                </button>
                            </div>
                        </th>

                        <th class="importance-cell">
                            <div class="th-center">
                                <button type="button" data-tooltip=@ImportanceTooltip(DDStat.TowerDamage)
                                        @onclick="() => ChangeImportance(DDStat.TowerDamage)">
                                    <img src="@GetImportanceImage(DDStat.TowerDamage)" />
                                </button>
                            </div>
                        </th>

                        <th class="importance-cell">
                            <div class="th-center">
                                <button type="button" data-tooltip=@ImportanceTooltip(DDStat.TowerRange)
                                        @onclick="() => ChangeImportance(DDStat.TowerRange)">
                                    <img src="@GetImportanceImage(DDStat.TowerRange)" />
                                </button>
                            </div>
                        </th>

                        <th class="importance-cell">
                            <div class="th-center">
                                <button type="button" data-tooltip=@ImportanceTooltip(DDStat.TowerRate)
                                        @onclick="() => ChangeImportance(DDStat.TowerRate)">
                                    <img src="@GetImportanceImage(DDStat.TowerRate)" />
                                </button>
                            </div>

                        </th>

                        <!-- Resists (all toggle the same flag, but still distinct columns) -->

                        <th class="importance-cell">
                            <div class="th-center">
                                <button type="button" data-tooltip=@ImportanceTooltip(DDStat.HeroResistance)
                                        @onclick="() => ChangeImportance(DDStat.HeroResistance)">
                                    <img src="@GetImportanceImage(DDStat.HeroResistance)" />
                                </button>
                            </div>
                        </th>

                    </tr>
                    <tr class="header-row">
                        <th class="sortable" data-tooltip=@Tips["Rating"]>
                            <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.Rating))">
                                Rating <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Rating))</span>
                            </button>
                            <div class="col-resizer"></div>
                        </th>

                        <th class="sortable" data-tooltip=@Tips["Value"]>
                            <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.Value))">
                                Est. Value* <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Value))</span>
                            </button>
                            <div class="col-resizer"></div>
                        </th>

                        <th class="sortable">
                            <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.BestFor))">
                                Best For<span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.BestFor))</span>
                            </button>
                            <div class="col-resizer"></div>
                        </th>

                        <th class="sortable">
                            <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.Type))">
                                Type <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Type))</span>
                            </button>
                            <div class="col-resizer"></div>
                        </th>

                        <th class="sortable">
                            <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.Set))">
                                Set <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Set))</span>
                            </button>
                            <div class="col-resizer"></div>
                        </th>
                        <th class="sortable">
                            <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.Name))">
                                Name <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Name))</span>
                            </button>
                            <div class="col-resizer"></div>
                        </th>

                        <th class="sortable" data-tooltip=@Tips["Location"]>
                            <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.Location))">
                                Location <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Location))</span>
                            </button>
                            <div class="col-resizer"></div>
                        </th>


                        <th class="sortable">
                            <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.Quality))">
                                <span class="small-grid-header">Quality</span> <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Quality))</span>
                            </button>
                            <div class="col-resizer"></div>
                        </th>

                        <th class="sortable">
                            <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.MaxLevel))">
                                Max Lvl <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.MaxLevel))</span>
                            </button>
                            <div class="col-resizer"></div>
                        </th>
                                                
                        <th class="sortable">
                            <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.Level))">
                                Lvl <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Level))</span>
                            </button>
                            <div class="col-resizer"></div>
                        </th>
                        <th class="sortable">
                            <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.DPS))" data-tooltip="Estimated DPS in Nightmare">
                               <span class="hdr-text">Estimated Nightmare DPS</span>  <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.DPS))</span>
                            </button>
                            <div class="col-resizer"></div>
                        </th>
                        <th class="sortable icon-header @HeaderShadingStyle(DDStat.HeroHealth)">
                            <button type="button" class="th-btn th-icon" title="Hero Health" @onclick="() => SortBy(nameof(DDStat.HeroHealth))">
                                <img src="png/Hero Health.png" alt="HHP" />
                                <span class="hdr-text">Hero<br />Health</span>
                                <span class="sort-glyph">@SortGlyph(nameof(DDStat.HeroHealth))</span>
                            </button>
                            <div class="col-resizer"></div>
                        </th>

                        <th class="sortable icon-header @HeaderShadingStyle(DDStat.HeroDamage)">
                            <button type="button" class="th-btn th-icon" title="Hero Damage" @onclick="() => SortBy(nameof(DDStat.HeroDamage))">
                                <img src="png/Hero Damage.png" alt="HDmg" />
                                <span class="hdr-text">Hero<br />Damage</span>
                                <span class="sort-glyph">@SortGlyph(nameof(DDStat.HeroDamage))</span>
                            </button>
                            <div class="col-resizer"></div>
                        </th>

                        <th class="sortable icon-header @HeaderShadingStyle(DDStat.HeroSpeed)">
                            <button type="button" class="th-btn th-icon" title="Hero Speed" @onclick="() => SortBy(nameof(DDStat.HeroSpeed))">
                                <img src="png/Move Speed.png" alt="HSpd" />
                                <span class="hdr-text">Hero<br />Speed</span>
                                <span class="sort-glyph">@SortGlyph(nameof(DDStat.HeroSpeed))</span>
                            </button>
                            <div class="col-resizer"></div>
                        </th>

                        <th class="sortable icon-header @HeaderShadingStyle(DDStat.HeroCastRate)">
                            <button type="button" class="th-btn th-icon" title="Hero Casting Rate" @onclick="() => SortBy(nameof(DDStat.HeroCastRate))">
                                <img src="png/Cast Rate.png" alt="HRate" />
                                <span class="hdr-text">Hero<br />Rate</span>
                                <span class="sort-glyph">@SortGlyph(nameof(DDStat.HeroCastRate))</span>
                            </button>
                            <div class="col-resizer"></div>
                        </th>

                        <th class="sortable icon-header @HeaderShadingStyle(DDStat.HeroAbility1)">
                            <button type="button" class="th-btn th-icon" title="Ability 1" @onclick="() => SortBy(nameof(DDStat.HeroAbility1))">
                                <img src="png/AB1/Monk AB1.png" alt="Ab1" />
                                <span class="hdr-text">Hero<br />Ability 1</span>
                                <span class="sort-glyph">@SortGlyph(nameof(DDStat.HeroAbility1))</span>
                            </button>
                            <div class="col-resizer"></div>
                        </th>

                        <th class="sortable icon-header @HeaderShadingStyle(DDStat.HeroAbility2)">
                            <button type="button" class="th-btn th-icon" title="Ability 2" @onclick="() => SortBy(nameof(DDStat.HeroAbility2))">
                                <img src="png/AB2/Hero Boost Monk AB2.png" alt="Ab2" />
                                <span class="hdr-text">Hero<br />Ability 2</span>
                                <span class="sort-glyph">@SortGlyph(nameof(DDStat.HeroAbility2))</span>
                            </button>
                            <div class="col-resizer"></div>
                        </th>

                        <th class="sortable icon-header @HeaderShadingStyle(DDStat.TowerHealth)">
                            <button type="button" class="th-btn th-icon" title="Tower Health" @onclick="() => SortBy(nameof(DDStat.TowerHealth))">
                                <img src="png/Tower Health.png" alt="THP" />
                                <span class="hdr-text">Tower<br /> Health</span>
                                <span class="sort-glyph">@SortGlyph(nameof(DDStat.TowerHealth))</span>
                            </button>
                            <div class="col-resizer"></div>
                        </th>

                        <th class="sortable icon-header  @HeaderShadingStyle(DDStat.TowerDamage)">
                            <button type="button" class="th-btn th-icon" title="Tower Damage" @onclick="() => SortBy(nameof(DDStat.TowerDamage))">
                                <img src="png/Tower Damage.png" alt="TDmg" />
                                <span class="hdr-text">Tower<br />Damage</span>
                                <span class="sort-glyph">@SortGlyph(nameof(DDStat.TowerDamage))</span>
                            </button>
                            <div class="col-resizer"></div>
                        </th>

                        <th class="sortable icon-header  @HeaderShadingStyle(DDStat.TowerRange)">
                            <button type="button" class="th-btn th-icon" title="Tower Range" @onclick="() => SortBy(nameof(DDStat.TowerRange))">
                                <img src="png/Tower Range.png" alt="TRng" />
                                <span class="hdr-text">Tower<br />Range</span>
                                <span class="sort-glyph">@SortGlyph(nameof(DDStat.TowerRange))</span>
                            </button>
                            <div class="col-resizer"></div>
                        </th>

                        <th class="sortable icon-header @HeaderShadingStyle(DDStat.TowerRate)">
                            <button type="button" class="th-btn th-icon" title="Tower Rate" @onclick="() => SortBy(nameof(DDStat.TowerRate))">
                                <img src="png/Tower Rate.png" alt="TRate" />
                                <span class="hdr-text">Tower<br />Rate</span>
                                <span class="sort-glyph">@SortGlyph(nameof(DDStat.TowerRate))</span>
                            </button>
                            <div class="col-resizer"></div>
                        </th>

                        <th class="sortable icon-header @HeaderShadingStyle(DDStat.HeroResistance)">
                            <button type="button" class="th-btn th-icon" title="Generic Resist" @onclick="() => SortBy(nameof(DDStat.HeroResistance))">
                                <img src="png/all_resistances.png" alt="Res" />
                                <span class="hdr-text">Average Resistance</span>
                                <span class="sort-glyph">@SortGlyph(nameof(DDStat.HeroResistance))</span>
                            </button>
                            <div class="col-resizer"></div>
                        </th>
                    </tr>
                </thead>


                <tbody>
                    @foreach (var r in _rows)
                    {
                        <tr @key="@r.Idx" data-key="@r.Idx" class="data-row @(r.IsHidden?"hidden-row":"")" @onclick="() => OnRowClicked(r)">
                            <td class="cell-rating" data-tooltip=@(r.BrokenResists ? r.CachedUpgradesToMaxResistText : "")>
                                <span class="rating-primary">@r.Rating</span>
                                <span class="rating-sides">@r.Sides</span>
                            </td>
                            <td>                     
                                <span class="value-icon" data-tooltip="@r.CachedValueDisplayTooltip">
                                    @if (r.CachedValueDisplayIcons != "")
                                    {
                                        <span class="value-emoji">@r.CachedValueDisplayIcons</span>
                                    }
                                    @if (r.CachedValueDisplayText != "")
                                    {
                                        <span class="value-text">@r.CachedValueDisplayText</span>
                                    }
                                </span>
                            </td>
                            <td class="text bestfor">@r.BestFor</td>
                            <td class="text cell-type">@r.Type</td>
                            <td class="text cell-type">@r.Set</td>
                            <td class="text cell-name" data-tooltip='@(r.PlainName != r.GeneratedName ? "[" + r.GeneratedName + "]" : "")' h-tooltip="@r.FunHashString">
                                <span class="name-row">
                                    <img class="atlas-icon"
                                         alt=""
                                         width="32" height="32"
                                         data-size="64"
                                         data-l1x="@r.IconX" data-l1y="@r.IconY"
                                         data-l2x="@r.IconX1" data-l2y="@r.IconY1" data-l2t="@r.Color1"
                                         data-l3x="@r.IconX2" data-l3y="@r.IconY2" data-l3t="@r.Color2" />
                                    <span class="name-name">
                                        @(_compactDisplay ? r.PlainName : r.Name)
                                    </span>
                                    @if (r.HasCustomColor)
                                    {
                                        <span class="name-colors">
                                            <ColorSwatches Name="" Color1="@r.Color1" Color2="@r.Color2" />
                                        </span>
                                    }
                                </span>
                            </td>
                            <td class="text location">@GetLocation(r)</td>
                            <td class="text @QualityClass(r.Quality)">@r.Quality</td>

                            <td class="num">@r.MaxLevel</td>
                            <td class="num">@r.Level</td>                            
                            <td class="cell-dps" data-tooltip="@r.DPSTooltip">@r.CachedDPSString</td>
                            <td class="num cell-health @CachedStatShadingStyles[(int)DDStat.HeroHealth]">@r.CachedStatValues[(int)DDStat.HeroHealth]</td>
                            <td class="num cell-damage @CachedStatShadingStyles[(int)DDStat.HeroDamage]">@r.CachedStatValues[(int)DDStat.HeroDamage]</td>
                            <td class="num cell-range @CachedStatShadingStyles[(int)DDStat.HeroSpeed]">@r.CachedStatValues[(int)DDStat.HeroSpeed]</td>
                            <td class="num cell-rate @CachedStatShadingStyles[(int)DDStat.HeroCastRate]">@r.CachedStatValues[(int)DDStat.HeroCastRate]</td>
                            <td class="num cell-ab1 @CachedStatShadingStyles[(int)DDStat.HeroAbility1]">@r.CachedStatValues[(int)DDStat.HeroAbility1]</td>
                            <td class="num cell-ab2 @CachedStatShadingStyles[(int)DDStat.HeroAbility2]">@r.CachedStatValues[(int)DDStat.HeroAbility2]</td>
                            <td class="num cell-health @CachedStatShadingStyles[(int)DDStat.TowerHealth]">@r.CachedStatValues[(int)DDStat.TowerHealth]</td>
                            <td class="num cell-damage @CachedStatShadingStyles[(int)DDStat.TowerDamage]">@r.CachedStatValues[(int)DDStat.TowerDamage]</td>
                            <td class="num cell-range @CachedStatShadingStyles[(int)DDStat.TowerRange]">@r.CachedStatValues[(int)DDStat.TowerRange]</td>
                            <td class="num cell-rate @CachedStatShadingStyles[(int)DDStat.TowerRate]">@r.CachedStatValues[(int)DDStat.TowerRate]</td>
                            <td class="resist @CachedStatShadingStyles[(int)DDStat.HeroResistance]" data-tooltip="@r.CachedResistanceTooltip">@r.CachedResistDisplayValue</td>
                </tr>
                }
                </tbody>
            </table>
        </div>
    }

</div>
</div>
}

@code {
    [Inject] private IJSRuntime JS { get; set; } = default!;

    private int CurrentUIOptionsVersion = 1;
    private readonly string _dropZoneId = "dropzone";
    private DotNetObjectReference<Index>? _dotNetRef;
    private bool _needsAtlasRender;
    private bool _isDragOver;
    private bool _isLoading;
    private bool _hideDropzoneHelp;
    private bool _atlasReady;
    private string _summary = "";
    private string _status = "";
    private string _status2 = "";
    private string? _error;
    private DDDatabase db = new();
    private List<ItemViewRow> _rows = new();
    private record ModeOption(string Value, string Label);
    private string _sortColumn = nameof(ItemViewRow.Rating);
    private bool _sortDesc = true;
    private bool _showContent = false;
    private bool _canLoadLast = false;
    private ElementReference _tableRef;
    private string? _loadedFileName;
    private DateTime? _lastLoadedAt;
    private UiState _ui = new();
    private string _searchText = "";
    private string _lastAppliedSearchText = "";
    private int CollectedEventCount = 0;
    private int TotalEventCount = 0;
    // Multi-panel support
    private sealed class CharacterPanelSlot
    {
        public int Id { get; init; }
        public CharacterPanel? Panel { get; set; }
        public bool IsLocked { get; set; }
    }
    private readonly List<CharacterPanelSlot> _panelSlots = new() { new CharacterPanelSlot { Id = 0 } };
    private int _nextPanelId = 1;
    private int _activePanelIndex = 0;

    private CharacterPanel? _characterPanel => _panelSlots.Count > 0 ? _panelSlots[0].Panel : null;
    private CharacterPanel? ActivePanel => _activePanelIndex < _panelSlots.Count ? _panelSlots[_activePanelIndex].Panel : _characterPanel;

    private int _pendingReloadPanelId = -1;

    private void AddCharacterPanel()
    {
        var id = _nextPanelId++;
        _panelSlots.Add(new CharacterPanelSlot { Id = id });
        _pendingReloadPanelId = id;
        StateHasChanged();
    }

    private void RemoveCharacterPanel(int id)
    {
        if (_panelSlots.Count <= 1) return;

        var slot = _panelSlots.FirstOrDefault(s => s.Id == id);
        if (slot?.Panel is not null)
        {
            // Clear equipment from this panel
            foreach (var e in slot.Panel.EquippedItems.Values.ToList())
            {
                e.CurrentEquippedSlot = "";
            }
            slot.Panel.ClearAllEquipment();
        }

        _panelSlots.RemoveAll(s => s.Id == id);
        if (_activePanelIndex >= _panelSlots.Count)
            _activePanelIndex = _panelSlots.Count - 1;

        _ = UpdateCalculatedValues(false, true);
        StateHasChanged();
    }

    private void SetActivePanel(int index)
    {
        _activePanelIndex = index;
    }

    private bool _showEventCollection = false;
    private string _eventSearch = "";
    private double _overlayHeightPx = 0;
    private ElementReference _scrollRef;
    private bool _overlayObserversStarted;
    private string _customFilterError = "";
    private bool _compactDisplay = true;
    public string[] CachedStatShadingStyles = new string[11];
    private bool _gridReady = false;


    public bool _templateDBIsLoaded = false;
    public TemplateDatabase TemplateDB = new TemplateDatabase();
    public DamageCalculator? _damageCalculator = null;


    // Current sorting criteria
    private bool _bRequireResists = false;
    private bool _bUpgradeWeaponStats = false;
    private List<DDStat> _RatingStatsPriority = new();
    private List<DDStat> _SidesStatsPriority = new();
    private bool _showFilterHelp = false;

    void OpenFilterHelp() => _showFilterHelp = true;
    void CloseFilterHelp() => _showFilterHelp = false;

    private void ToggleFilterHelp()
    {
        _showFilterHelp = !_showFilterHelp;
    }

    // ======= selection ==========
    public sealed class OverlayMeasure
    {
        public double overlayHeight { get; set; }
        public List<RowMeasure> rows { get; set; } = new();
    }
    public sealed class RowMeasure
    {
        public string? key { get; set; }
        public double y { get; set; }
        public double h { get; set; }
    }

    // Bind targets
    private List<string> SelectedTypes
    {
        get => _ui.SelectedTypes.ToList();
        set => SetUi(u => u with { SelectedTypes = value.ToImmutableArray() });                                
    }

    private List<string> SelectedSets
    {
        get => _ui.SelectedSets.ToList();
        set => SetUi(u => u with { SelectedSets = value.ToImmutableArray() });                    
    }

    private List<string> SelectedOther
    {
        get => _ui.SelectedOther.ToList();
        set => SetUi(u => u with { SelectedOther = value.ToImmutableArray() });                    
    }

    private readonly List<FilterChips.Option> _typeOptions = new()
        {

        new("Helmet"),
        new("Gauntlet"),
        new("Torso"),
        new("Boots"),
        new("Brooch"),
        new("Mask"),
        new("Bracers"),
        new("Shield"),
        new("Pets"),
        new("Weapons"),
        new("Currency"),
        };

    private readonly List<FilterChips.Option> _setOptions = new()
        {
        new("Pristine"),
        new("Plate"),
        new("Chain"),
        new("Mail"),
        new("Leather"),
        new("Zamira"),
        new("Squire"),
        new("Apprentice"),
        new("Monk"),
        new("Huntress"),
        };

    private readonly List<FilterChips.Option> _otherOptions = new()
        {

        new("Only Events",    MutexGroup: "eventMode"),
        new("Exclude Events", MutexGroup: "eventMode"),

        new("Exclude Other Characters Equipment"),

        new("Exclude Missing Resists"),
        };


    [JSInvokable]
    public void OnGridLayoutChanged(OverlayMeasure m)
    {
        _overlayHeightPx = m.overlayHeight;

        // Map measurements back into your model
        // Example: dictionary by row.Id or whatever your key is
        var map = m.rows
            .Where(r => r.key is not null)
            .ToDictionary(r => r.key!, r => (r.y, r.h));

        foreach (var row in _rows)
        {
            var key = row.Idx.ToString();
            if (map.TryGetValue(key, out var v))
            {
                row.CachedY = v.y;
                row.CachedHeight = v.h;
            }
        }

        InvokeAsync(StateHasChanged);
    }



    // this should be updated for new characters
    private string GetTypeOfExtraSlot(CharacterPanel? panel = null)
    {
        panel ??= ActivePanel;
        string? Template = panel?.SelectedHeroInfo?.Template;
        if (Template != null && HeroTemplateData.Map.ContainsKey(Template))
        {
            return (HeroTemplateData.Map[Template].ExtraType);
        }

        return "None";
    }

    private bool IsWeaponSetValid(string set, CharacterPanel? panel = null)
    {
        panel ??= ActivePanel;
        string? Template = panel?.SelectedHeroInfo?.Template;

        if (Template != null && HeroTemplateData.Map.ContainsKey(Template))
        {
            string ValidWeapons = HeroTemplateData.Map[Template].WeaponType;
            return ValidWeapons.Contains(set);
        }
        return true;
    }


    private void ClearAllSelections()
    {
        foreach (var slot in _panelSlots)
            ClearPanelSelections(slot.Panel);
    }

    private void ClearPanelSelections(CharacterPanel? panel)
    {
        if (panel is null) return;

        List<ItemViewRow> equippedItems = panel.EquippedItems.Values.ToList();
        foreach (var v in equippedItems)
            DeselectRow(v, panel);
    }

    private void DeselectRow(ItemViewRow row, CharacterPanel? panel = null)
    {
        if (row.CurrentEquippedSlot == "") return;

        panel ??= ActivePanel;
        panel?.ChangeEquipment(row.CurrentEquippedSlot, null);
        row.CurrentEquippedSlot = "";
        _ = UpdateCalculatedValues(false, true);
    }

    private void SelectRow(ItemViewRow row, CharacterPanel? panel = null)
    {
        if (row.CurrentEquippedSlot != "") return;
        panel ??= ActivePanel;
        if (panel == null) return;

        string extra = GetTypeOfExtraSlot(panel);
        string itemType = row.Type;

        // can't select weapons that you can't equip
        if (itemType == "Weapon" && !IsWeaponSetValid(row.Set, panel))
            return;

        if ((itemType == "Unknown") || (itemType == "") || (itemType == "Currency")) return;
        if ((itemType == "Shield") && (extra != "Shield")) return;
        if (itemType == "Shield") { itemType = "Extra"; }

        if (panel.EquippedItems.ContainsKey(itemType) && (itemType == extra))
            itemType = "Extra";

        if (panel.EquippedItems.ContainsKey(itemType))
            DeselectRow(panel.EquippedItems[itemType], panel);

        panel?.ChangeEquipment(itemType, row);
        row.CurrentEquippedSlot = itemType;
        _ = UpdateCalculatedValues(false, true);
    }

    private bool IsSelected(ItemViewRow row)
    {
        return (row.CurrentEquippedSlot != "");
    }

    private void OnRowClicked(ItemViewRow row)
    {
        if (IsSelected(row))
            DeselectRow(row, ActivePanel);
        else
            SelectRow(row, ActivePanel);
    }

    private static readonly string[] ValidTags =
     {
        "name", "location", "value", "quality", "rating", "lvl", "maxlvl", "set", "type", "best", "sides",
        "thp", "tdmg", "trate", "trange", "hhp", "hdmg", "hrate", "hspd", "ab1", "ab2",
        "ressum", "resavg", "resg", "resp", "resf", "resl",
    };
    private string NormalizeTag(string rawTag)
    {
        if (string.IsNullOrWhiteSpace(rawTag)) return "";

        string t = rawTag.ToLowerInvariant();

        t = t.Replace("damage", "dmg");
        t = t.Replace("tower", "t");
        t = t.Replace("hero", "h");
        t = t.Replace("ability", "ab");
        t = t.Replace("health", "hp");
        t = t.Replace("level", "lvl");
        t = t.Replace("resistance", "res");
        t = t.Replace("resist", "res");
        t = t.Replace("speed", "spd");

        for (int i = 0; i < ValidTags.Length; i++)
        {
            if (ValidTags[i].Equals(t, StringComparison.OrdinalIgnoreCase))
                return ValidTags[i];
        }
        for (int i = 0; i < ValidTags.Length; i++)
        {
            if (ValidTags[i].Contains(t, StringComparison.OrdinalIgnoreCase))
                return ValidTags[i];
        }

        return "";
    }


    // Equipping!

    private Task HandleChangedHero()
    {        
        ApplyFilters();

        return Task.CompletedTask;
    }

    private Task HandleChangedRatingMode(string? mode)
    {
        if (string.IsNullOrWhiteSpace(mode))
            return Task.CompletedTask;

        SetUi(u => u with { RatingMode = mode });
        return Task.CompletedTask;
    }

    private Task HandleEquipmentClick(ItemViewRow row)
    {        
        JS.InvokeVoidAsync("scrollRowIntoView", row.Idx);
        return Task.CompletedTask;
    }


    private Task HandleEquipmentRightClick(ItemViewRow row)
    {

        // deselect this row
        DeselectRow(row);
        return Task.CompletedTask;
    }

    private Task HandleEquipFromFile(CharacterPanelSlot slot)
    {
        var panel = slot.Panel;
        if (panel == null)
            return Task.CompletedTask;

        ClearPanelSelections(panel);
        if (panel.SelectedHeroInfo == null)
        {
            return Task.CompletedTask;
        }

        foreach (var v in panel.SelectedHeroInfo.Equipment)
        {
            if (v.cachedItemRow != null)
                SelectRow(v.cachedItemRow, panel);
        }
        return Task.CompletedTask;
    }

    private Task HandleEquipBest(CharacterPanelSlot slot)
    {
        FindAndEquipBestPieces(slot.Panel);
        return Task.CompletedTask;
    }

    private Task HandleEquipClear(CharacterPanelSlot slot)
    {
        ClearPanelSelections(slot.Panel);
        return Task.CompletedTask;
    }


    // ===== Event Collection Overlay =====


    private sealed record EventCollectionRow(
        string Name,
       string Category,
        int Price,
        int OwnedCount);


    private List<EventCollectionRow> _eventCollection = new();

    private IEnumerable<EventCollectionRow> VisibleEventCollection
    {
        get
        {
            if (_eventCollection.Count == 0)
                return Array.Empty<EventCollectionRow>();

            if (string.IsNullOrWhiteSpace(_eventSearch))
                return _eventCollection;

            var s = _eventSearch.Trim();
            return _eventCollection.Where(x => ((x.Category != null) && (x.Category.Contains(s, StringComparison.OrdinalIgnoreCase))) || ((x.Name != null) && (x.Name.Contains(s, StringComparison.OrdinalIgnoreCase))));
        }
    }

    // Apply category filter only after the user finishes editing the textbox.
    private void OnEventSearchChanged(ChangeEventArgs e)
    {
        _eventSearch = e.Value?.ToString() ?? "";
        StateHasChanged();
    }

    public void ShowEventCollection()
    {
        RebuildEventCollection();
        _showEventCollection = true;
        StateHasChanged();
    }

    private async Task ExportEventCollection()
    {
        if (_eventCollection == null || _eventCollection.Count == 0)
            return;

        // Alphabetical by name
        var lines = _eventCollection
            .OrderBy(x => x.Name, StringComparer.OrdinalIgnoreCase)
            .Select(x => $"{x.Name}\t{x.OwnedCount}");

        var text = string.Join(Environment.NewLine, lines);

        await JS.InvokeVoidAsync("copyToClipboard", text);
    }

    private void CloseEventCollection()
    {
        _showEventCollection = false;
        _eventSearch = "";
        StateHasChanged();
    }





    private static (string Page, string Section) SplitCategory(string category)
    {
        if (string.IsNullOrWhiteSpace(category)) return ("Other", "");

        var parts = category.Split('>');
        var page = (parts.Length > 0 ? parts[0] : category).Trim();
        var section = (parts.Length > 1 ? parts[1] : "").Trim();
        if (page.Equals("Unknown", StringComparison.OrdinalIgnoreCase)) page = "Unknown";
        return (string.IsNullOrWhiteSpace(page) ? "Other" : page, section);
    }


    // Desired category ordering for the Event Collection overlay
    private static readonly string[] _eventCategoryOrder = new[]
    {
        "Weapons > Apprentice",
        "Weapons > Huntress",
        "Weapons > Monk",
        "Weapons > Squire",
        "Weapons > Exclusive",

        "Accessories > High End Hats",
        "Accessories > High End Masks",
        "Accessories > High End Bracers",
        "Accessories > Mid End Hats",
        "Accessories > Mid End Masks",
        "Accessories > Mid End Bracers",
        "Accessories > Hats",
        "Accessories > Shields",
        "Accessories > Masks",
        "Accessories > Bracers",
        "Accessories > Armor Pieces",
        "Accessories > Exclusive Armor Pieces",
        "Accessories > Exclusives",

        "Pets > Guardians",
        "Pets > Streamer",
        "Pets > DPS",
        "Pets > Builder",
        "Pets > Collectibles",
        "Pets > Exclusives",

        "Unknown",
    };

    private static readonly Dictionary<string, int> _eventCategoryOrderMap = BuildEventCategoryOrderMap();

    private static Dictionary<string, int> BuildEventCategoryOrderMap()
    {
        var d = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase);
        for (int i = 0; i < _eventCategoryOrder.Length; i++)
            d[_eventCategoryOrder[i]] = i;
        return d;
    }

    private static string NormalizeCategoryKey(string category)
    {
        if (string.IsNullOrWhiteSpace(category)) return "Unknown";

        var s = category.Trim();
        if (s.Equals("unknown", StringComparison.OrdinalIgnoreCase))
            return "Unknown";

        var parts = s.Split('>');
        if (parts.Length == 1)
            return parts[0].Trim();

        var page = parts[0].Trim();
        var section = parts.Length > 1 ? parts[1].Trim() : "";
        if (page.Equals("unknown", StringComparison.OrdinalIgnoreCase)) page = "Unknown";
        return string.IsNullOrWhiteSpace(section) ? page : $"{page} > {section}";
    }

    private static int GetCategoryOrderKey(string category)
    {
        var key = NormalizeCategoryKey(category);
        if (_eventCategoryOrderMap.TryGetValue(key, out var i))
            return i;

        return 10000;
    }

    private void RebuildEventCollection()
    {
        // Total: unique EventItem names in the price guide (guide has duplicates by design)
        var all = EventPriceGuide.HashToEventInfo.Values;

        // Build (unique-name) catalog using the most expensive entry as representative
        var catalog = all
            .GroupBy(x => x.ItemName, StringComparer.OrdinalIgnoreCase)
            .Select(g =>
            {
                var rep = g.OrderByDescending(x => x.Price).First();
                return (Name: rep.ItemName, Category: rep.Category, Price: rep.Price);
            })
            .ToList();

        TotalEventCount = catalog.Count;

        // Owned counts: count how many of your _rows are events, and their hash resolves to an EventItemInfo
        var ownedByName = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase);

        foreach (var r in _rows)
        {
            if (!r.IsEvent) continue;

            if (!ItemHash.TryPhraseToInt30(r.FunHashString, out uint h))
                continue;

            if (!EventPriceGuide.HashToEventInfo.TryGetValue(h, out var info))
                continue;

            ownedByName[info.ItemName] = ownedByName.TryGetValue(info.ItemName, out var c) ? (c + 1) : 1;
        }

        _eventCollection = catalog
            .Select(x => new EventCollectionRow(
                Name: x.Name,
                Category: x.Category,
                Price: x.Price,
                OwnedCount: ownedByName.TryGetValue(x.Name, out var c) ? c : 0))
            .ToList();


        /*      var uncollectedEvents = _eventCollection
            .Where(x => x.OwnedCount == 0)
            .ToList();*/
    CollectedEventCount = _eventCollection.Count(x => x.OwnedCount > 0);
    }

    //==========================================
    // UiState 
    //==========================================

    public sealed record UiState
    {
        public const int CurrentUIOptionsVersion = 2;

        public int Version { get; init; } = CurrentUIOptionsVersion;
        public bool Censor { get; init; } = true;
        public string RatingMode { get; init; } = "Builder App";
        public string ItemBoxLayout { get; init; } = "5x3";

        public bool ShowLivePrices { get; init; } = false;
        public bool ShowUpgradedStats { get; init; } = false;
        public bool AssumeSetBonuses { get; init; } = false;
        public bool CompactDisplay { get; init; } = false;
        public bool SidesAreImportant { get; init; } = false;
        public string Theme { get; init; } = "light";

        public string DPSMode { get; init; } = "Damage per Second";

        // bump this when baking new items
        public int IconVersion = 2;

        public ImmutableArray<string> SelectedTypes { get; init; } = ["Helmet", "Torso", "Gauntlet", "Boots"];
        public ImmutableArray<string> SelectedSets { get; init; } = ["Chain", "Mail", "Pristine", "Leather", "Plate"];
        public ImmutableArray<string> SelectedOther { get; init; } = ["Exclude Events"];
    }

    private static bool DifferentSelection(List<string>? a, List<string>? b)
    {
        if (ReferenceEquals(a, b)) return false;
        if (a is null || b is null) return a != b;
        if (a.Count != b.Count) return true;

        // order-insensitive compare
        return !a
            .OrderBy(x => x, StringComparer.Ordinal)
            .SequenceEqual(b.OrderBy(x => x, StringComparer.Ordinal), StringComparer.Ordinal);
    }


    private void SetUi(UiState newState)
    {
        SetUi(_ => newState);
    }

    static bool SameSet(ImmutableArray<string> a, ImmutableArray<string> b)=> a.Length == b.Length && a.ToHashSet().SetEquals(b);

    private  void SetUi(Func<UiState, UiState> mutate)
    {
        UiState prev = _ui;

        _ui = mutate(_ui) with { Version = UiState.CurrentUIOptionsVersion };

        bool bNeedUpdateCache = false;
        bool bNeedUpdateDPS = false;
        bool bNeedUpdateRating = false;
        bool bNeedUpdateFilters = false;
        bool bNeedUpdateMode = false;

        if (prev.Censor != _ui.Censor) { bNeedUpdateCache = true; }
        if (prev.RatingMode != _ui.RatingMode) { bNeedUpdateMode = true; bNeedUpdateRating = true; bNeedUpdateDPS = true; }
        if (prev.ItemBoxLayout != _ui.ItemBoxLayout) {bNeedUpdateCache = true; }
        if (prev.ShowUpgradedStats != _ui.ShowUpgradedStats) { bNeedUpdateDPS = true; }
        if (prev.AssumeSetBonuses != _ui.AssumeSetBonuses) { bNeedUpdateRating = true; bNeedUpdateDPS = true; }
        if (prev.SidesAreImportant != _ui.SidesAreImportant) { bNeedUpdateRating = true; }
        if (prev.Theme != _ui.Theme) { JS.InvokeVoidAsync("setTheme", _ui.Theme); }
        if (!SameSet(prev.SelectedTypes, _ui.SelectedTypes)) { bNeedUpdateFilters = true; }
        if (!SameSet(prev.SelectedSets, _ui.SelectedSets))  { bNeedUpdateFilters = true; }
        if (!SameSet(prev.SelectedOther, _ui.SelectedOther)) { bNeedUpdateFilters = true; }

        bNeedUpdateCache |= bNeedUpdateDPS | bNeedUpdateFilters;

        if (bNeedUpdateDPS) bNeedUpdateCache = false; // update dps will handle this for us

        foreach (var slot in _panelSlots)
            slot.Panel?.SetUIFlags(_ui.Censor);

        if (bNeedUpdateMode) SetDisplayedMode(_ui.RatingMode);
        if (bNeedUpdateFilters) ApplyFilters();

        if (bNeedUpdateRating || bNeedUpdateDPS)
            _ = UpdateCalculatedValues(bNeedUpdateRating, bNeedUpdateDPS);

        if (bNeedUpdateCache)
            UpdateCachedDisplayValues();

        if (prev.IconVersion != _ui.IconVersion)
        {
            JS.InvokeVoidAsync("atlasIcons.clearCache");
        }

        QueueSaveUiState();
    }    


    static UiState MigrateAndNormalize(string json)
    {
        UiState? state;

        try
        {
            state = JsonSerializer.Deserialize<UiState>(json);
        }
        catch
        {
            return new UiState() with { Version = UiState.CurrentUIOptionsVersion };
        }

        if (state is null)
            return new UiState() with { Version = UiState.CurrentUIOptionsVersion };

        // Version-specific migrations (only when you introduce schema changes)
        var migrated = state.Version switch
        {
            1 => state with { Theme = "light" },
            2 => state,
            _ => new UiState()   // unknown future version (conservative)
        };

        return NormalizeCommon(migrated) with { Version = UiState.CurrentUIOptionsVersion };
    }
    static UiState NormalizeCommon(UiState s)
    {
        var d = new UiState();

        // Strings: fall back to defaults if empty/whitespace
        var ratingMode = string.IsNullOrWhiteSpace(s.RatingMode)     ? d.RatingMode     : s.RatingMode;
        var layout     = string.IsNullOrWhiteSpace(s.ItemBoxLayout)  ? d.ItemBoxLayout  : s.ItemBoxLayout;
        var dpsMode    = string.IsNullOrWhiteSpace(s.DPSMode)        ? d.DPSMode        : s.DPSMode;
        var theme      = s.Theme is "light" or "dark" ? s.Theme : "light";

        static ImmutableArray<string> Clean(ImmutableArray<string> items)
        {
            // If items is default (can happen via bad JSON or missing init), treat as empty
            if (items.IsDefault) items = ImmutableArray<string>.Empty;

            return items
                .Where(x => !string.IsNullOrWhiteSpace(x))
                .Select(x => x.Trim())
                .Distinct(StringComparer.Ordinal)
                .ToImmutableArray();
        }

        return s with
        {
            RatingMode    = ratingMode,
            ItemBoxLayout = layout,
            DPSMode       = dpsMode,
            Theme         = theme,

            SelectedSets  = Clean(s.SelectedSets),
            SelectedTypes = Clean(s.SelectedTypes),
            SelectedOther = Clean(s.SelectedOther),
        };
    }

      //==========================================
    //==========================================

    private string LastLoadedText =>
    _lastLoadedAt is null ? "just now" : Humanize(_lastLoadedAt.Value);

    private static string Humanize(DateTime dt)
    {
        var span = DateTime.Now - dt;
        if (span.TotalSeconds < 30) return "just now";
        if (span.TotalMinutes < 1) return $"{(int)span.TotalSeconds} seconds ago";
        if (span.TotalHours < 1) return $"{(int)span.TotalMinutes} minutes ago";
        if (span.TotalDays < 1) return $"{(int)span.TotalHours} hours ago";
        return $"{(int)span.TotalDays} days ago";
    }

    private void TogglePrepHelp() => _hideDropzoneHelp = !_hideDropzoneHelp;



    public string GetLocation(ItemViewRow viewRow)
    {
        // no folders for tavern or characters
        if ((viewRow.IndexInFolder == -1) || (viewRow.Location == null) || (viewRow.Location[0] == 'T') || (viewRow.Location[0] == 'C'))
            return viewRow?.Location ?? "";

        int idx = viewRow.IndexInFolder;
        int itemsPerPage = 15;
        if (_ui.ItemBoxLayout == "4x3") itemsPerPage = 12;
        else if (_ui.ItemBoxLayout == "6x4") itemsPerPage = 24;
        else if (_ui.ItemBoxLayout == "5x3") itemsPerPage = 15;
        else 
        {
            // revert to 5x3, since the value is bad
            SetUi(u => u with { ItemBoxLayout = "5x3" });
            itemsPerPage = 15;
        }

        int subFolderItems = (db.SubfolderCount.ContainsKey(viewRow.Location)) ? db.SubfolderCount[viewRow.Location] : 0;

        itemsPerPage -= subFolderItems;
        int pageNumber = (int)(viewRow.IndexInFolder / itemsPerPage) + 1;
        return viewRow.Location + " (" + pageNumber.ToString() + ")";

    }


@*     public void SetPriceStatus(string stat, bool showLivePrices)
    {
        _status2 = stat;
        _showLivePrices = showLivePrices;
        StateHasChanged();

    } *@

    // TOOLTIPS GO HERE

    private static readonly Dictionary<string, string> Tips = new()
    {
        ["Rating"] = "Rating is the sum of important stats,\naffected by upgrades, required resists,\nand set bonuses.\nSmall number is sides.",
        ["Value"] = "Stars show how good this item is at what it does best,\ncompared to the rest of your equipment.\nCV is estimated trade value.",
        ["Location"] = "Location (and page) of item\nwhen sorting by Level.",
        ["Censor"] = "Censors Ult++ and other special items\nfor sharing screenshots on DDRnG.",
        ["ShowUpgraded"] = "Shows inventory items as fully upgraded\naccording to current priority.\n\nEquipped items are always upgraded.",
        ["AssumeSetBonuses"] = "Shows inventory items as if they\nhave a set bonus.\n\nEquipped items always assume set bonuses.",
        ["LivePrices"] = "Sends valuable item ratings\nto Shiro's API for price data.",
        ["ItemBoxSize"] = "Sets item box in-game size \nto calculate accurate page number\nwhen sorting by Level.",
        ["CompactDisplay"] = "Compresses the size of elements for\nsmaller windows.",
        ["SidesAreImportant"] = "Makes 'Equip best' includes sides at half value.\n",
        ["DarkMode"] = "Toggles between light and dark themes.",
        ["DPSMode"] = "Set DPS Display Mode"
    };

    // Note: filtering is now driven by FilterChips selections (SelectedTypes/SelectedSets/SelectedOther)
    // instead of a bitflag enum.

    private readonly List<ModeOption> _modeOptions = new()
    {
        new("Builder Stats", "Builder Stats"),
        new("Hero Stats", "Hero Stats"),
        new("Builder App", "Builder App"),
        new("Builder Hermit", "Builder Hermit"),
        new("Builder TRange", "Builder TRange"),
        new("Builder EV", "Builder EV"),
        new("Builder Summoner", "Builder Summoner"),
        new("AB1 Only", "AB1 Only"),
        new("DPS AB1", "DPS AB1"),
        new("DPS AB2", "DPS AB2"),
        new("Pure DPS", "Pure DPS"),
        new("Gunwitch", "Gunwitch"),
        new("Guardian Summoner", "Guardian Summoner"),
        //new("Best Rating", "Best Rating")
    };


    private bool IsCensorEnabled => _ui.Censor;

    private static readonly HashSet<string> ArmorSetNames = new(StringComparer.OrdinalIgnoreCase)
    {
        "Pristine", "Plate", "Chain", "Mail", "Leather", "Zamira"
    };

    private void UpdateCachedDisplayValues()
    {
        foreach (var r in _rows)
        {
            for (int i = 1; i < 11; i ++)
                r.CachedStatValues[i] = r.GetStringStatValue((DDStat)i, _ui.ShowUpgradedStats, _ui.AssumeSetBonuses, _ui.Censor);
            r.CachedResistDisplayValue = r.GetStringResistValue(_ui.ShowUpgradedStats, _ui.AssumeSetBonuses);

            if (r.DPS == 0.0f)
                r.CachedDPSString = "";
            else
                r.CachedDPSString = DDEquipmentInfo.FormatCompact(r.DPS);       
        }                   
    }

    private void UpdateStatShadingStyles()
    {
        for (int i = 0; i < 11; i++)
        {
            CachedStatShadingStyles[i] = CellShadingStyle((DDStat)i);
        }
    }

    private string CellShadingStyle(DDStat stat)
    {
        if (stat == DDStat.HeroResistance)
        {
            return _bRequireResists ? "cell-stat-primary" : "cell-stat-dimmed";
        }
        if (_RatingStatsPriority.Contains(stat)) return "cell-stat-primary";
        if (_SidesStatsPriority.Contains(stat)) return "cell-stat-side";
        return "cell-stat-dimmed";
    }

    int VisibleCount => _rows.Count(r => !r.IsHidden);
    int TotalCount => _rows.Count;


    private void ApplyFilters()
    {
        if (_rows.Count == 0)
            return;

        bool onlyEvents = _ui.SelectedOther.Contains("Only Events");
        bool excludeEvents = _ui.SelectedOther.Contains("Exclude Events");
        bool excludeEquipped = _ui.SelectedOther.Contains("Exclude Other Characters Equipment");
        bool excludeMissingResists = _ui.SelectedOther.Contains("Exclude Missing Resists");

        bool updateCustomSearch = false;
        bool customSearchIsError = false;
        ExpressionParser.BoolNode? root = null;


        if (_searchText != _lastAppliedSearchText)
        {
            _lastAppliedSearchText = _searchText;
            updateCustomSearch = true;
            if (!string.IsNullOrWhiteSpace(_searchText))
            {
                _customFilterError = "";
                var parser = new ExpressionParser.Parser(_searchText, NormalizeTag);
                try
                {
                    root = parser.ParseAll();
                    if (!string.IsNullOrEmpty(parser.Error))
                    {
                        _customFilterError = parser.Error;
                        customSearchIsError = true;
                    }
                }
                catch (Exception ex)
                {
                    _customFilterError = $"Invalid filter: {ex.Message}";
                    customSearchIsError = true;
                }
            }
        }

        foreach (var v in _rows)
        {
            // ---- Type filtering (OR within the chip group) ----
            bool typeOk;
            if ( _ui.SelectedTypes.Length == 0)
            {
                typeOk = true; // no selection => include all
            }
            else
            {
                var typeLabel = v.Type switch
                {
                    "Pet" => "Pets",
                    "Weapon" => "Weapons",
                    _ => v.Type
                };

                typeOk = _ui.SelectedTypes.Contains(typeLabel);
            }

            // ---- Set filtering (OR within the chip group) ----
            bool setOk;
            if (_ui.SelectedSets.Length == 0)
            {
                setOk = true;
            }
            else if (v.IsArmor)
            {                
                if (string.Equals(v.Set, "Any", StringComparison.OrdinalIgnoreCase))
                {
                    setOk = true;//_ui.SelectedSets.Any(s => ArmorSetNames.Contains(s));
                }
                else
                {
                    setOk = _ui.SelectedSets.Contains(v.Set);
                }
            }
            else
            {
                // Non-armor: Set is usually the weapon archetype (Squire/Monk/etc.)
                setOk = _ui.SelectedSets.Contains(v.Set) || string.Equals(v.Set, "Any", StringComparison.OrdinalIgnoreCase);
            }

            bool includeItem = typeOk && setOk;

            if (onlyEvents)
                includeItem &= v.IsEvent;
            if (excludeEvents)
                includeItem &= !v.IsEvent;

            if ((excludeEquipped && (ActivePanel?.SelectedHeroInfo?.Name != null) && (v.Location != "Character > " + ActivePanel?.SelectedHeroInfo?.Name)) ||
                (excludeEquipped && (ActivePanel?.SelectedHeroInfo == null) && (v.Location.StartsWith("Character"))))
                includeItem &= !v.IsEquipped;

            if (excludeMissingResists)
                includeItem &= !v.IsMissingResists;

            if (updateCustomSearch)
            {
                if (customSearchIsError == false)
                    v.IsHiddenDueToSearch = (root == null) ? false : !(root.Eval(v));
                else
                    v.IsHiddenDueToSearch = false;
            }

            if (v.IsHiddenDueToSearch)
                includeItem = false;

            v.IsHidden = !includeItem;
        }
    }

    private async Task ApplySearch(string s)
    {
        _searchText = s ?? "";
        _customFilterError = "";

        if (!string.IsNullOrWhiteSpace(_searchText))
        {        
            await AddToSearchHistoryAsync(_searchText);
        }

        ApplyFilters();
    }

    private string HeaderShadingStyle(DDStat stat)
    {
        // optimize later?
        if (stat == DDStat.HeroResistance)
        {
            return _bRequireResists ? "table-header-primary" : "table-header-none";
        }

        if (_RatingStatsPriority.Contains(stat)) return "table-header-primary";
        if (_SidesStatsPriority.Contains(stat)) return "table-header-secondary";
        return "table-header-none";
    }

    string _currentSetMode = "";

    private void SetDisplayedMode(string mode)
    {
        if (_currentSetMode == mode )
            return;

        if ((mode == null) || (mode == ""))
            return;

        foreach (var v in Ratings.RatingModes)
        {
            if (mode.StartsWith(v.Name))
            {
                _RatingStatsPriority.Clear();
                _RatingStatsPriority.AddRange(v.RatingStatsPriority);
                _SidesStatsPriority.Clear();
                _SidesStatsPriority.AddRange(v.SidesStatsPriority);
                _bRequireResists = v.RequireResists;
                _bUpgradeWeaponStats = v.UpgradeWeaponStats;
                break;
            }
        }                
    }

    private void TestForBestPiece(string type, string set, int rating, Dictionary<string, int> BestPieces)
    {
        if (set == "Any")
        {
            TestForBestPiece(type, "Chain", rating, BestPieces);
            TestForBestPiece(type, "Pristine", rating, BestPieces);
            TestForBestPiece(type, "Plate", rating, BestPieces);
            TestForBestPiece(type, "Mail", rating, BestPieces);
            TestForBestPiece(type, "Leather", rating, BestPieces);
            return;
        }

        string key = set + "_" + type;

        if (BestPieces.ContainsKey(key))
        {
            if (BestPieces[key] < rating)
                BestPieces[key] = rating;
        }
        else
            BestPieces[key] = rating;
    }

    public int EquippedArmorRating = 0;
    public int EquippedArmorSides = 0;
    public string EquippedArmorSet = "";

    private void FindAndEquipBestPieces(CharacterPanel? panel = null)
    {
        panel ??= ActivePanel;
        if (panel == null) return;

        // Clear this panel's equipment first so items become available
        ClearPanelSelections(panel);

        Dictionary<string, int> BestPieces = new Dictionary<string, int>();
        var hinfo = panel.SelectedHeroInfo;

        List<string> ExcludedQualities = new List<string>();

        if (hinfo != null)
        {
            int level = hinfo.HeroLevel;
            if (level < 60) ExcludedQualities.Add("Godly");
            if (level < 74) ExcludedQualities.Add("Mythical");
            if (level < 78) ExcludedQualities.Add("Trans");
            if (level < 83) ExcludedQualities.Add("Supreme");
            if (level < 90) ExcludedQualities.Add("Ult90");
            if (level < 93) ExcludedQualities.Add("Ult93");
            if (level < 100) ExcludedQualities.Add("Ult+");
            if (level < 100) ExcludedQualities.Add("Ult++");
        }

        // Collect items locked on other panels
        var lockedItems = new HashSet<int>();
        foreach (var otherSlot in _panelSlots)
        {
            if (!otherSlot.IsLocked || otherSlot.Panel == panel) continue;
            if (otherSlot.Panel is null) continue;
            foreach (var equipped in otherSlot.Panel.EquippedItems.Values)
                lockedItems.Add(equipped.Idx);
        }

        for (int i = 0; i < _rows.Count; i++)
        {
            var r = _rows[i];
            if (r.CurrentEquippedSlot != "") continue; // equipped on another panel
            if (!r.IsHidden && r.IsEligibleForBest && !ExcludedQualities.Contains(r.Quality) && !lockedItems.Contains(r.Idx))
            {
                TestForBestPiece(r.Type, r.Set, r.Rating + (_ui.SidesAreImportant ? r.Sides/2:0), BestPieces);
            }
        }

        // find best armor set
        //-------------------------
        string[] Sets = { "Plate", "Pristine", "Leather", "Mail", "Chain" };
        int[] Scores = new int[5];
        foreach (var v in BestPieces)
        {
            for (int i = 0; i < 5; i++)
            {
                if (v.Key.StartsWith(Sets[i]))
                {
                    Scores[i] += v.Value;
                }
            }
        }

        string bestSet = Sets[0];
        int bestScore = Scores[0];
        for (int i = 1; i < 5; i++)
        {
            if (bestScore < Scores[i])
            {
                bestScore = Scores[i];
                bestSet = Sets[i];
            }
        }

        string NameString = "";

        for (int i = 0; i < _rows.Count; i++)
        {
            var r = _rows[i];
            if (r.CurrentEquippedSlot != "") continue; // equipped on another panel
            if (r.IsHidden || !r.IsEligibleForBest || lockedItems.Contains(r.Idx)) continue;
            if ((r.Set == bestSet) || (r.Set == "Any"))
            {
                string typeString = bestSet + "_" + r.Type;
                if (BestPieces.ContainsKey(typeString))
                {
                    int rating = BestPieces[typeString];
                    if ((r.Rating + (_ui.SidesAreImportant ?  r.Sides / 2 : 0)) == rating)
                    {
                        BestPieces[typeString] = -99999;
                        NameString += r.Name + " ";
                        SelectRow(_rows[i], panel);
                    }
                }
            }
        }
        _ = UpdateCalculatedValues(false, true);
    }

    private void UpdateEquipmentRatingAndType()
    {
        var panel = ActivePanel;
        if (panel == null) return;

        string foundSet = "None";
        int totalRating = 0;
        int totalSides = 0;

        foreach (var v in panel.EquippedItems)
        {
            ItemViewRow row = v.Value;
            if (row == null) continue;

            if ((foundSet == "None") && row.IsArmor)
                foundSet = row.Set;

            if ((foundSet != "None") && row.IsArmor && row.Set != foundSet)
                foundSet = "Mixed";

            totalRating += row.Rating;
            totalSides += row.Sides;
        }

        EquippedArmorRating = totalRating;
        EquippedArmorSides = totalSides;
        EquippedArmorSet = foundSet;
    }


    //=============================================
    // Derived value recalculation - Ratings + DPS
    //=============================================


    CancellationTokenSource? _calculatedValuesCts;
    bool _bNeedsRatingUpdate = false;
    bool _bNeedsDPSUpdate = false;
    int _calcGeneration = 0;

    private async Task UpdateCalculatedValues( bool bUpdateRatings, bool bUpdateDPS )
    {
        if (bUpdateRatings) _bNeedsRatingUpdate = true;
        if (bUpdateDPS) _bNeedsDPSUpdate = true;

        int myGen = Interlocked.Increment(ref _calcGeneration);
        var newCts = new CancellationTokenSource();
        var previous = Interlocked.Exchange(ref _calculatedValuesCts, newCts);
        previous?.Cancel();
        previous?.Dispose();

        foreach (var slot in _panelSlots)
            slot.Panel?.UpdateCharacterTotalStats();

        var token = newCts.Token;
        try
        {                        
            if (myGen != Volatile.Read(ref _calcGeneration))
                return;

            await Task.Delay(120, token);

            bool doRatingCalc = _bNeedsRatingUpdate;
            bool doDpsCalc = _bNeedsDPSUpdate;
            _bNeedsRatingUpdate = false;
            _bNeedsDPSUpdate = false;


            // Do expensive Work
            if (doRatingCalc)
            {
                await RecalculateRatings(token, myGen);
                token.ThrowIfCancellationRequested();                
            }

            if (doDpsCalc)
            {
                await RecalculateDPS(token, myGen);
                token.ThrowIfCancellationRequested();                
            }

            if (myGen != Volatile.Read(ref _calcGeneration))  return;

            UpdateCachedDisplayValues();      
            await InvokeAsync(StateHasChanged);
        }
        catch (OperationCanceledException)
        {

        }
    }    



    private async Task RecalculateRatings(CancellationToken token, int myCalcGeneration)
    {
        int n = _rows.Count;
        var newRatings = new (int rating, int sides)[n];

        for (int i = 0; i < n; i++)
        {            
            var r = _rows[i];
            newRatings[i] = Ratings.EvalRatingAndUpgrades(r, _RatingStatsPriority, _SidesStatsPriority, _bRequireResists, _bUpgradeWeaponStats);

            if (((i & 127) == 0) && (i!=0))
            {
                token.ThrowIfCancellationRequested();
                await Task.Yield();                                
            }
        }

        for (int i = 0; i < n; i++)
        {
            _rows[i].Rating = newRatings[i].rating;
            _rows[i].Sides = newRatings[i].sides;                    
        }


        token.ThrowIfCancellationRequested();
        if (myCalcGeneration != Volatile.Read(ref _calcGeneration))
            return;


        _sortDesc = true;
        _sortColumn = "";
        SortBy("Rating");
        UpdateStatShadingStyles();
    }


    public async Task RecalculateDPS(CancellationToken token, int calcGen )
    {
        HeroInfo info = new HeroInfo();
        //IndexEntry

        if (TemplateDB == null)
            return;
        if (ActivePanel == null)
            return;
        if (_damageCalculator == null)
            return;

        var heroInstance = ActivePanel?.SelectedHeroInfo;
        string heroTemplate = ActivePanel?.SelectedHeroInfo?.Template ?? "";
        if (!TemplateDB.TryGetTemplateIndex(heroTemplate, out int entry))
        {
            Console.WriteLine($"Couldn't find hero template {heroTemplate}");
            return;
        }

        // need to remake this so failure isn't a throw
        info.TemplateData = TemplateDB.GetDunDefHero(entry);        
        info.PlayerTemplateData = TemplateDB.GetDunDefPlayer(info.TemplateData.PlayerTemplate);

        info.MeleeAttack1LargeAnimDuration = info.PlayerTemplateData.MeleeAttack1LargeAnimDuration;
        info.MeleeAttack2LargeAnimDuration = info.PlayerTemplateData.MeleeAttack2LargeAnimDuration;
        info.MeleeAttack3LargeAnimDuration = info.PlayerTemplateData.MeleeAttack3LargeAnimDuration;
        info.MeleeAttack1MediumAnimDuration = info.PlayerTemplateData.MeleeAttack1MediumAnimDuration;
        info.MeleeAttack2MediumAnimDuration = info.PlayerTemplateData.MeleeAttack2MediumAnimDuration;
        info.MeleeAttack3MediumAnimDuration = info.PlayerTemplateData.MeleeAttack3MediumAnimDuration;
        info.MeleeAttack1LargeAnimDamageStart = info.PlayerTemplateData.MeleeAttack1LargeAnimDamageStart;
        info.MeleeAttack2LargeAnimDamageStart = info.PlayerTemplateData.MeleeAttack2LargeAnimDamageStart;
        info.MeleeAttack3LargeAnimDamageStart = info.PlayerTemplateData.MeleeAttack3LargeAnimDamageStart;
        info.MeleeAttack1MediumAnimDamageStart = info.PlayerTemplateData.MeleeAttack1MediumAnimDamageStart;
        info.MeleeAttack2MediumAnimDamageStart = info.PlayerTemplateData.MeleeAttack2MediumAnimDamageStart;
        info.MeleeAttack3MediumAnimDamageStart = info.PlayerTemplateData.MeleeAttack3MediumAnimDamageStart;

        if ((heroInstance != null) && (heroInstance.CostumeIndex >= 0) && (heroInstance.CostumeIndex < info.TemplateData.HeroCostumes.Count))
        {
            var HeroCostumeTemplate = TemplateDB.GetHeroCostumeTemplate(info.TemplateData.HeroCostumes.Start + heroInstance.CostumeIndex);
            if (HeroCostumeTemplate.PlayerTemplateOverride != -1)
            {
                info.PlayerTemplateData = TemplateDB.GetDunDefPlayer(HeroCostumeTemplate.PlayerTemplateOverride);
            }
            if (HeroCostumeTemplate.MeleeAttack1MediumAnimDuration != -1) 
            {
                info.MeleeAttack1MediumAnimDuration = HeroCostumeTemplate.MeleeAttack1MediumAnimDuration;
                info.MeleeAttack1MediumAnimDamageStart = HeroCostumeTemplate.MeleeAttack1MediumAnimDamageStart;
            }
            if (HeroCostumeTemplate.MeleeAttack2MediumAnimDuration != -1) 
            {
                info.MeleeAttack2MediumAnimDuration = HeroCostumeTemplate.MeleeAttack2MediumAnimDuration;
                info.MeleeAttack2MediumAnimDamageStart = HeroCostumeTemplate.MeleeAttack2MediumAnimDamageStart;
            }
            if (HeroCostumeTemplate.MeleeAttack3MediumAnimDuration != -1) 
            {
                info.MeleeAttack3MediumAnimDuration = HeroCostumeTemplate.MeleeAttack3MediumAnimDuration;
                info.MeleeAttack3MediumAnimDamageStart = HeroCostumeTemplate.MeleeAttack3MediumAnimDamageStart;
            }
            if (HeroCostumeTemplate.MeleeAttack1LargeAnimDuration != -1) 
            {
                info.MeleeAttack1LargeAnimDuration = HeroCostumeTemplate.MeleeAttack1LargeAnimDuration;
                info.MeleeAttack1LargeAnimDamageStart = HeroCostumeTemplate.MeleeAttack1LargeAnimDamageStart;
            }
            if (HeroCostumeTemplate.MeleeAttack2LargeAnimDuration != -1)
            {
                info.MeleeAttack2LargeAnimDuration = HeroCostumeTemplate.MeleeAttack2LargeAnimDuration;
                info.MeleeAttack2LargeAnimDamageStart = HeroCostumeTemplate.MeleeAttack2LargeAnimDamageStart;
            }
            if (HeroCostumeTemplate.MeleeAttack3LargeAnimDuration != -1)
            {
                info.MeleeAttack3LargeAnimDuration = HeroCostumeTemplate.MeleeAttack3LargeAnimDuration;
                info.MeleeAttack3LargeAnimDamageStart = HeroCostumeTemplate.MeleeAttack3LargeAnimDamageStart;
            }

        }

        for (int i = 0; i < 11; i++)
        {
            info.TotalStats[i] = ActivePanel!.ShownStat[i];
        }
        int count = 0;
        int n = _rows.Count;

        var dps = new float[n];
        var tips = new string[n];

        if (calcGen != Volatile.Read(ref _calcGeneration)) return;

        for (int i = 0; i < n; i++ )
        {
            token.ThrowIfCancellationRequested();
            if ( i >= _rows.Count)
                break;
            var v = _rows[i];

            if (v.Type != "Weapon")
                continue;


            if (!TemplateDB.TryGetTemplateIndex(db.Items[v.Idx].Template, out int weaponTemplateIdx ))
            {
                Console.WriteLine($"Expected known weapon template {db.Items[v.Idx].Template}");
                continue;
            }

            var weaponTemplate = TemplateDB.GetHeroEquipment(weaponTemplateIdx);
            v.DPS = 0.0f;
            v.DPSTooltip = "";

            if (!IsWeaponSetValid(v.Set))
                continue;

            _damageCalculator.CalculateUpgradedWeaponStats(v, false, ref weaponTemplate);

            if (v.Set == "Squire") 
            {
                (dps[i], tips[i]) = (_damageCalculator.GetMeleeWeaponDamage(v, _ui.ShowUpgradedStats, ref info, ref weaponTemplate));
            }
            else if (v.Set == "Huntress")
            {
                (dps[i], tips[i]) = (_damageCalculator.GetCrossbowWeaponDamage(v, _ui.ShowUpgradedStats, ref info, ref weaponTemplate));
            }                
            else if (v.Set == "Monk")
            {
                (float meleeDamage, string meleeTip) = (_damageCalculator.GetSpearWeaponDamage(v, _ui.ShowUpgradedStats, false, ref info, ref weaponTemplate));                                
                _damageCalculator.CalculateUpgradedWeaponStats(v, true, ref weaponTemplate);
                (float rangedDamage, string rangedTip) = (_damageCalculator.GetSpearWeaponDamage(v, _ui.ShowUpgradedStats, true, ref info, ref weaponTemplate));

                string rangedStr = DDEquipmentInfo.FormatCompact(rangedDamage);
                string meleeStr = DDEquipmentInfo.FormatCompact(meleeDamage);		

                dps[i] = (meleeDamage > rangedDamage) ? meleeDamage : rangedDamage;
                tips[i] = $"{rangedStr} Ranged DPS (upgrading as Ranged)\r\n{rangedTip}\r\n\r\n{meleeStr} Melee DPS (upgrading as Melee)\r\n{meleeTip}\r\n";
                
                if (_ui.ShowUpgradedStats)
                    tips[i] += "Stats below are upgrading for " + ((meleeDamage > rangedDamage) ? "Melee:" : "Ranged:");

                if ( meleeDamage > rangedDamage )
                {
                    // if melee wins, make sure we go with those upgrades
                    _damageCalculator.CalculateUpgradedWeaponStats(v, false, ref weaponTemplate);
                }
            }
            else if (v.Set == "Apprentice")
            {
                (dps[i], tips[i]) = (_damageCalculator.GetStaffWeaponDamage(v, _ui.ShowUpgradedStats, ref info, ref weaponTemplate));
            }             


            int viewWeaponDamage = _damageCalculator.GetDisplayWeaponDamage(v, _ui.ShowUpgradedStats, ref info, ref weaponTemplate);
            int viewWeaponAltDamage = _damageCalculator.GetDisplayAltDamage(v, _ui.ShowUpgradedStats, ref info, ref weaponTemplate);
            int viewWeaponAdditionalDamage = _damageCalculator.GetDisplayAdditionalDamage(v, _ui.ShowUpgradedStats, ref info, ref weaponTemplate);
            int viewShotsPerSec = _damageCalculator.GetDisplayShotsPerSecond(v, _ui.ShowUpgradedStats, ref info, ref weaponTemplate);
            int viewNumProjectiles = _damageCalculator.GetDisplayNumProjectiles(v, _ui.ShowUpgradedStats, ref info, ref weaponTemplate);

            tips[i] +=  
               ((v.UpgradedWeaponDamageBonus == 0) ? "" : $"\r\n[Weapon Damage]: {viewWeaponDamage}") + 
               ((v.UpgradedWeaponAltDamageBonus== 0) ? "" : $"\r\n[Weapon Alt Damage]: {viewWeaponAltDamage}") + 
               ((v.UpgradedWeaponAdditionalDamageAmount == 0) ? "" : $"\r\n[Weapon Elemental Damage]: {viewWeaponAdditionalDamage}") +
               ((v.UpgradedWeaponNumberOfProjectilesBonus == 0) ? "" : $"\r\n[Num Projectiles]: {viewNumProjectiles}") +
               ((v.UpgradedWeaponShotsPerSecondBonus == 0) ? "" : $"\r\n[Shots Per Second]: {viewShotsPerSec}");


            if ((++count & 127) == 0)
            {
                if (calcGen != Volatile.Read(ref _calcGeneration)) return;
                await Task.Yield();
            }
        }    

        token.ThrowIfCancellationRequested();
        if (calcGen != Volatile.Read(ref _calcGeneration)) return;

        for (int i = 0; i < n; i++)
        {
            token.ThrowIfCancellationRequested();
            if ( i >= _rows.Count)
                break;

            if (_rows[i].Type != "Weapon")
                continue;

            _rows[i].DPS = dps[i];
            _rows[i].DPSTooltip = tips[i];                                         
        }

        UpdateEquipmentRatingAndType();
    }


    //=============================================
    //=============================================


    private void ChangeImportance(DDStat stat)
    {
        if (stat == DDStat.HeroResistance)
            _bRequireResists = !_bRequireResists;
        else if (_RatingStatsPriority.Contains(stat))
        {
            _RatingStatsPriority.Remove(stat);
            _SidesStatsPriority.Add(stat);
        }
        else if (_SidesStatsPriority.Contains(stat))
        {
            _SidesStatsPriority.Remove(stat);
        }
        else
        {
            _RatingStatsPriority.Add(stat);
        }

        _ = UpdateCalculatedValues(true, true);        
    }

    private string ImportanceTooltip(DDStat stat)
    {
        if (_RatingStatsPriority.Contains(stat) || ((stat == DDStat.HeroResistance) && _bRequireResists))
        {
            return "Stat is important and added to Rating.\nClick to change.";
        }
        else if (_SidesStatsPriority.Contains(stat))
        {
            return "Stat is a side and shown next to \nRating, but not added in.\nClick to change.";
        }
        return "Stat is unimportant.\nClick to change.";
    }


    private string GetImportanceImage(DDStat stat)
    {
        if (stat == DDStat.HeroResistance)
        {
            return _bRequireResists ? "png/importance-rating.png" : "png/importance-none.png";
        }

        if (_RatingStatsPriority.Contains(stat))
            return "png/importance-rating.png";
        if (_SidesStatsPriority.Contains(stat))
            return "png/importance-side.png";

        return "png/importance-none.png";
    }

    private void SortBy(string column)
    {
        if (_sortColumn == column)
            _sortDesc = !_sortDesc;      // toggle
        else
        {
            _sortColumn = column;
            _sortDesc = true;            // default: desc like WPF “largest first”
        }

        ApplySort();
    }
    private static readonly StringComparer Ci = StringComparer.OrdinalIgnoreCase;

    private void ApplySort()
    {
        int dir = _sortDesc ? -1 : 1;

        int Cmp(int a, int b) => a.CompareTo(b);
        int CmpStr(string? a, string? b) => Ci.Compare(a ?? "", b ?? "");

        int Compare(ItemViewRow a, ItemViewRow b)
        {
            int loc = 0;
            if (_sortColumn == nameof(ItemViewRow.Location))
            {
                loc = CmpStr(a.Location, b.Location);
                if (loc == 0) loc = Cmp(a.IndexInFolder, b.IndexInFolder);
            }

            int c = _sortColumn switch
            {
                nameof(ItemViewRow.Rating) => Cmp(a.Rating, b.Rating),
                nameof(ItemViewRow.Value) => Cmp(a.Value, b.Value),
                nameof(ItemViewRow.BestFor) => CmpStr(a.BestFor, b.BestFor),
                nameof(ItemViewRow.Level) => Cmp(a.Level, b.Level),
                nameof(ItemViewRow.MaxLevel) => Cmp(a.MaxLevel, b.MaxLevel),

                nameof(DDStat.HeroHealth) => Cmp(a.Stats[(int)DDStat.HeroHealth], b.Stats[(int)DDStat.HeroHealth]),
                nameof(DDStat.HeroDamage) => Cmp(a.Stats[(int)DDStat.HeroDamage], b.Stats[(int)DDStat.HeroDamage]),
                nameof(DDStat.HeroSpeed) => Cmp(a.Stats[(int)DDStat.HeroSpeed], b.Stats[(int)DDStat.HeroSpeed]),
                nameof(DDStat.HeroCastRate) => Cmp(a.Stats[(int)DDStat.HeroCastRate], b.Stats[(int)DDStat.HeroCastRate]),
                nameof(DDStat.HeroAbility1) => Cmp(a.Stats[(int)DDStat.HeroAbility1], b.Stats[(int)DDStat.HeroAbility1]),
                nameof(DDStat.HeroAbility2) => Cmp(a.Stats[(int)DDStat.HeroAbility2], b.Stats[(int)DDStat.HeroAbility2]),
                nameof(DDStat.TowerHealth) => Cmp(a.Stats[(int)DDStat.TowerHealth], b.Stats[(int)DDStat.TowerHealth]),
                nameof(DDStat.TowerDamage) => Cmp(a.Stats[(int)DDStat.TowerDamage], b.Stats[(int)DDStat.TowerDamage]),
                nameof(DDStat.TowerRange) => Cmp(a.Stats[(int)DDStat.TowerRange], b.Stats[(int)DDStat.TowerRange]),
                nameof(DDStat.TowerRate) => Cmp(a.Stats[(int)DDStat.TowerRate], b.Stats[(int)DDStat.TowerRate]),

                nameof(DDStat.HeroResistance) => Cmp(a.Resists[0] + a.Resists[1] + a.Resists[2] + a.Resists[3], b.Resists[0] + b.Resists[1] + b.Resists[2] + b.Resists[3]),

                nameof(ItemViewRow.Name) => CmpStr(a.Name, b.Name),
                nameof(ItemViewRow.Location) => loc,

                nameof(ItemViewRow.Type) => CmpStr(a.Type, b.Type),
                nameof(ItemViewRow.Set) => CmpStr(a.Set, b.Set),

                nameof(ItemViewRow.Quality) => Cmp(a.QualityRank, b.QualityRank),
                nameof(ItemViewRow.DPS) => Cmp((int)a.DPS, (int)b.DPS),
                _ => Cmp(a.Rating, b.Rating),
            };

            // primary sort direction
            c *= dir;
            if (c != 0) return c;

            // tie-breakers (desc, like you were doing)
            c = b.Rating.CompareTo(a.Rating);
            if (c != 0) return c;
            c = b.Sides.CompareTo(a.Sides);
            if (c != 0) return c;
            return b.Name.CompareTo(a.Name);
        }

        _rows.Sort(Compare);
    }


    private static string QualityClass(string quality)
    {
        if (quality == "Ult++") return "cell-quality-ultplusplus";
        else if (quality == "Ult+") return "cell-quality-ultplus";
        else if (quality == "Ult93") return "cell-quality-ult93";
        else if (quality == "Ult90") return "cell-quality-ult90";
        else if (quality == "Supreme") return "cell-quality-supreme";
        else if (quality == "Trans") return "cell-quality-transcendent";
        else if (quality == "Mythic") return "cell-quality-mythical";
        else return "cell-quality-default";
    }
    const string UiStateKey = "ddgo.uiState.v1";
    const string SearchHistoryKey = "ddgo.searchHistory.v1";

    private bool _searchHistoryOpen;
    private List<string> _searchHistory = new();

    private CancellationTokenSource? _saveCts;

    void QueueSaveUiState()
    {        
        _saveCts?.Cancel();
        _saveCts?.Dispose();
        _saveCts = new CancellationTokenSource();

        _ = DebouncedSaveAsync(_saveCts.Token);
    }

    private async Task DebouncedSaveAsync(CancellationToken token)
    {
        try
        {
            await Task.Delay(500, token);

            // _ui is already the source of truth now — no SyncFieldsToUi().
            var uiToSave = _ui with { Version = CurrentUIOptionsVersion };

            var json = JsonSerializer.Serialize(uiToSave);
            await InvokeAsync(async () => { await JS.InvokeVoidAsync("appState.set", UiStateKey, json); });
        }
        catch (OperationCanceledException) { }
        catch (ObjectDisposedException) { } // covers JS/runtime teardown cases
        catch (Exception ex)
        {
            Console.WriteLine("Save UI state failed: " + ex);
        }
    }

    private void ToggleSearchHistory() => _searchHistoryOpen = !_searchHistoryOpen;

    private void CloseSearchHistory() => _searchHistoryOpen = false;

    private async Task LoadSearchHistoryAsync()
    {
        try
        {
            var json = await JS.InvokeAsync<string?>("appState.get", SearchHistoryKey);
            if (!string.IsNullOrWhiteSpace(json))
            {
                var list = JsonSerializer.Deserialize<List<string>>(json);
                if (list != null)
                    _searchHistory = list.Where(s => !string.IsNullOrWhiteSpace(s)).Select(s => s.Trim()).Take(10).ToList();
            }
        }
        catch
        {
            // ignore bad JSON / schema changes
            _searchHistory = new();
        }
    }

    private async Task SaveSearchHistoryAsync()
    {
        var json = JsonSerializer.Serialize(_searchHistory);
        await JS.InvokeVoidAsync("appState.set", SearchHistoryKey, json);
    }

    private async Task AddToSearchHistoryAsync(string filter)
    {
        var s = (filter ?? "").Trim();
        if (string.IsNullOrWhiteSpace(s))
            return;

        // De-dupe (case-insensitive), move to top
        _searchHistory.RemoveAll(x => string.Equals(x, s, StringComparison.OrdinalIgnoreCase));
        _searchHistory.Insert(0, s);

        if (_searchHistory.Count > 10)
            _searchHistory = _searchHistory.Take(10).ToList();

        await SaveSearchHistoryAsync();
    }

    private async Task ClearSearchHistoryAsync()
    {
        _searchHistory.Clear();
        await SaveSearchHistoryAsync();
        CloseSearchHistory();
    }

    private async Task ApplySearchHistory(string filter)
    {
        _searchText = filter ?? "";
        _searchHistoryOpen = false;
        await ApplySearch(_searchText);
    }


    protected override async Task OnInitializedAsync()
    {
        if (_dotNetRef == null)
            _dotNetRef = DotNetObjectReference.Create(this);
        // 1) UI state

        UiState newState = new();
        var json = await JS.InvokeAsync<string?>("appState.get", UiStateKey);
        try
        {
            if (!string.IsNullOrWhiteSpace(json))
                newState = MigrateAndNormalize(json);
        }
        catch
        {        
        }

        // Apply side effects / cached values based on _ui
        SetUi(newState);
        await JS.InvokeVoidAsync("setTheme", _ui.Theme);

        for (int i = 0; i < 11; i++)
            CachedStatShadingStyles[i] = "";

        await LoadSearchHistoryAsync();


        // read the template database
        if (!_templateDBIsLoaded)
        {
            await TemplateDB.Load(Http, "DunDefTemplates.dbz");
            _templateDBIsLoaded = true;
            _damageCalculator = new DamageCalculator(TemplateDB);
        }

        if (await JS.InvokeAsync<bool>("dropzone.supportsHandles"))
        {
            var ok = await JS.InvokeAsync<bool>("dropzone.tryLoadLastHandleAndRead", _dotNetRef); // returns true if it loaded bytes & called into .NET or returned bytes
            if (ok) return;
        }

        var oldFileName = await JS.InvokeAsync<string?>("dropzone.tryLoadCachedFilename"); // from IndexedDB
        var cachedList = await JS.InvokeAsync<int[]?>("dropzone.tryLoadCachedDunBytes");
        var cached = cachedList?.Select(i => (byte)i).ToArray();
        if (cached is { Length: > 0 })
            await LoadDunBytesAsync(oldFileName ?? "", cached, TemplateDB);
    }

    public int _renderCount = 0;


    protected override bool ShouldRender()
    {
        //Console.WriteLine($"{GetType().Name} ShouldRender() = true");        
        return true;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        _renderCount++;
        //Console.WriteLine($"{GetType().Name} rendered #{_renderCount} (first={firstRender})");


        if (firstRender)
        {
            //_dotNetRef = DotNetObjectReference.Create(this);

            await JS.InvokeVoidAsync("dropzone.init", _dropZoneId, _dotNetRef);
            var supports = await JS.InvokeAsync<bool>("dropzone.supportsHandles");
            _canLoadLast = supports && await JS.InvokeAsync<bool>("dropzone.hasLast");
            StateHasChanged();
            await JS.InvokeVoidAsync("atlasIcons.init", "png/HeroEquipment_Atlas.png"); // set your atlas path
            await JS.InvokeVoidAsync("atlasIcons.startAutoRender");

            _atlasReady = true;

            StateHasChanged();
        }

        if (_showContent && !_overlayObserversStarted)
        {
            _overlayObserversStarted = true;
            await JS.InvokeVoidAsync("gridOverlayObservers.start", _scrollRef, _tableRef, _dotNetRef);
        }

        if (_needsAtlasRender && _showContent && _atlasReady)
        {
            _needsAtlasRender = false;
            await JS.InvokeVoidAsync("atlasIcons.renderAllCached");
        }

        if (_pendingHeroReload is not null)
        {
            bool anyPanel = false;
            foreach (var slot in _panelSlots)
            {
                if (slot.Panel is not null)
                {
                    slot.Panel.SetUIFlags(_ui.Censor);
                    slot.Panel.Reload(_pendingHeroReload);
                    anyPanel = true;
                }
            }
            if (anyPanel)
            {
                _lastLoadedHeroes = _pendingHeroReload;
                _pendingHeroReload = null;
                ApplyFilters();
                await UpdateCalculatedValues(true, true);
                await Task.Delay(100);
                _gridReady = true;
                await InvokeAsync(StateHasChanged);
            }
        }

        // Reload heroes into newly added panels
        if (_pendingReloadPanelId >= 0 && _lastLoadedHeroes is not null)
        {
            var newSlot = _panelSlots.FirstOrDefault(s => s.Id == _pendingReloadPanelId);
            if (newSlot?.Panel is not null)
            {
                newSlot.Panel.SetUIFlags(_ui.Censor);
                newSlot.Panel.Reload(_lastLoadedHeroes);
                _pendingReloadPanelId = -1;
                StateHasChanged();
            }
        }
    }

    public async ValueTask DisposeAsync()
    {
        _saveCts?.Cancel(); _saveCts?.Dispose(); _saveCts = null;
        _calculatedValuesCts?.Cancel(); _calculatedValuesCts?.Dispose(); _calculatedValuesCts = null;
        try { await JS.InvokeVoidAsync("gridOverlayObservers.stop", _scrollRef); } catch { }
        _dotNetRef?.Dispose();
    }

    // Called by JS when user drags over / leaves to let us style the dropzone
    [JSInvokable]
    public void SetDragOver(bool isOver)
    {
        if (_isDragOver == isOver) return;
        _isDragOver = isOver;
        _ = InvokeAsync(StateHasChanged);
    }

    private List<DDHeroInfo>? _pendingHeroReload = null;
    private List<DDHeroInfo>? _lastLoadedHeroes = null;

    public async Task LoadDunBytesAsync(string fileName, byte[] bytes, ExportedTemplateDatabase tdb)
    {
        _loadedFileName = fileName;
        _lastLoadedAt = DateTime.Now;
        _error = null;
        _isLoading = true;
        _gridReady = false;
        _status = $"Reading {fileName}…";
        await InvokeAsync(StateHasChanged);        
        await db.LoadFromDun(bytes, tdb);
        if (!db.IsReady)
        {
            _error = db.Status;
        }
        else
        {
            _status = db.Status;
            _rows.Clear();
            Ratings.ClearBestRatings();
            for (int i = 0; i < db.Items.Count; i++)
            {
                ItemViewRow itemViewRow = db.Items[i].ToItemViewRow();
                _rows.Add(itemViewRow);

                (int value, itemViewRow.BestFor) = Ratings.GetBestValue(true, itemViewRow);

                // don't override set event values
                if (itemViewRow.Value == 0)
                    itemViewRow.Value = value;
            }
            // now go through and get relative value
            foreach (var v in _rows)
            {
                // only override if we don't have a value yet
                if (v.Value == 0)
                {
                    // calculate relative rating for value (goes from -1000 to 0)
                    (v.Value, v.BestFor) = Ratings.GetBestValue(false, v);
                }
                v.UpdateValueDisplay();
            }

            // Event collection counts + overlay data (unique names in guide, plus your owned counts)
            RebuildEventCollection();
            CalculateVanityTotals();

            // don't care about when it gets back
            // SetPriceStatus("Prices estimated by table", true);

            _showContent = true;
            _needsAtlasRender = true;
            _pendingHeroReload = db.Heroes;          
        }
    }

    // Called by JS after it reads the dropped file as base64
    [JSInvokable]
    public async Task OnFileDropped(string fileName, byte[] bytes)
    {

        StateHasChanged();

        try
        {
            _status = $"Parsing {fileName} ({bytes.Length:N0} bytes)";
            StateHasChanged();
            await LoadDunBytesAsync(fileName, bytes, TemplateDB);
        }
        catch (Exception ex)
        {
            _showContent = false;
            _error = $"Error: {ex.Message} {db.Status}";
            _isLoading = false;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private string SortGlyph(string col)
    {
        if (_sortColumn != col) return "";
        return _sortDesc ? "▼" : "▲";
    }

    public int ArmorTotalValue = 0;
    public int EventTotalValue = 0;

    public void CalculateVanityTotals()
    {
        int at = 0;
        int et = 0;
        foreach (var v in _rows)
        {
            if (v.IsArmor && !v.IsEvent && v.Value > 0)
                at += v.Value;
            if (v.IsEvent && v.Value > 0)
                et += v.Value;
        }
        ArmorTotalValue = at;
        EventTotalValue = et;
    }


    public string GetFunHash(ItemViewRow ivr)
    {
        return ivr.FunHashString;
    }
    


    @* private void GetLivePrices()
    {
        _ = Ratings.AsyncShiroPriceAPICall(this);
    } *@
    private async Task LoadLastFile()
    {
        _error = null;
        _status = "";
        _status2 = "";

        // Only returns true in Chrome/Edge *and* if a handle was saved before.
        bool ok = await JS.InvokeAsync<bool>("dropzone.loadLast", _dotNetRef);

        if (!ok)
        {
            _status = "No remembered file yet (or the browser blocked access). Drop the file once, or use the Open button.";
            StateHasChanged();
        }
    }
    private async Task OpenFileDialog()
    {
        _error = null;
        _status = "";
        _status2 = "";
        StateHasChanged();

        // Opens file picker, reads bytes in JS, then calls OnFileDropped(fileName, bytes)
        bool ok = await JS.InvokeAsync<bool>("dropzone.pickFile", _dotNetRef);

        if (!ok)
        {
            _status = "No file selected.";
            StateHasChanged();
        }
    }

    private static string Csv(string? value)
    {
        value ??= "";
        // Escape quotes by doubling them, and quote the field if needed
        bool mustQuote = value.Contains(',') || value.Contains('"') || value.Contains('\n') || value.Contains('\r');
        if (value.Contains('"'))
            value = value.Replace("\"", "\"\"");
        return mustQuote ? $"\"{value}\"" : value;
    }

    private async Task ExportToCSV()
    {
        List<string> lines = new();

        int app = Ratings.GetRatingModeInfo("Builder App")?.ListIndex ?? 0;
        int hermit = Ratings.GetRatingModeInfo("Builder Hermit")?.ListIndex ?? 0;
        int dmg = Ratings.GetRatingModeInfo("Builder EV")?.ListIndex ?? 0;
        int trange = Ratings.GetRatingModeInfo("Builder TRange")?.ListIndex ?? 0;
        int thp = Ratings.GetRatingModeInfo("Builder Summoner")?.ListIndex ?? 0;
        int ab2dps = Ratings.GetRatingModeInfo("DPS AB2")?.ListIndex ?? 0;
        int ab1dps = Ratings.GetRatingModeInfo("DPS AB1")?.ListIndex ?? 0;
        int gunwitch = Ratings.GetRatingModeInfo("Gunwitch")?.ListIndex ?? 0;
        int ab1 = Ratings.GetRatingModeInfo("AB1 Only")?.ListIndex ?? 0;
        int hhp = Ratings.GetRatingModeInfo("Guardian Summoner")?.ListIndex ?? 0;

        // Header row
        lines.Add(string.Join(",", new[]
        {
        "BestFor","Name","Type","Set","Quality","Level","Max Level",
        "Hero Health","Hero Speed","Hero Damage","Hero Cast Rate","AB1","AB2",
        "Tower Health","Tower Rate","Tower Damage","Tower Range",
        "Res Generic","Res Poison","Res Fire","Res Electric",
        "Location",
        "Builder App","Builder Hermit","Builder EV","Builder TRange","Builder Summoner",
        "DPS AB2","DPS AB1","Gunwitch","AB1 Only","Guardian Summoner",
        "Set Bonus","Unusued Upgrades","Ups Needed for Res"
        }));

        foreach (var r in _rows)
        {
            if (r.IsHidden) continue;

            string upgradesRequiredForResists = "";
            if (r.IsArmor && r.UpgradesRequiredForResists == -1)
                upgradesRequiredForResists = "Res Fix";
            else if (r.IsArmor)
                upgradesRequiredForResists = r.UpgradesRequiredForResists.ToString();

            var fields = new List<string>
        {
            Csv(r.BestFor),
            Csv(r.Name),
            Csv(r.Type),
            Csv(r.Set),
            Csv(r.Quality),
            r.Level.ToString(),
            r.MaxLevel.ToString()
        };

            // Stats 1..10 (your code uses Stats[i+1])
            for (int i = 0; i < 10; i++)
                fields.Add(r.Stats[i + 1] == 0 ? "" : r.Stats[i + 1].ToString());

            // Resists 0..3
            for (int i = 0; i < 4; i++)
                fields.Add(r.Resists[i] == 0 ? "" : r.Resists[i].ToString());

            fields.Add(Csv(GetLocation(r)));

            fields.Add(r.CachedRatings[app].ToString());
            fields.Add(r.CachedRatings[hermit].ToString());
            fields.Add(r.CachedRatings[dmg].ToString());
            fields.Add(r.CachedRatings[trange].ToString());
            fields.Add(r.CachedRatings[thp].ToString());

            fields.Add(r.CachedRatings[ab2dps].ToString());
            fields.Add(r.CachedRatings[ab1dps].ToString());
            fields.Add(r.CachedRatings[gunwitch].ToString());
            fields.Add(r.CachedRatings[ab1].ToString());
            fields.Add(r.CachedRatings[hhp].ToString());

            fields.Add(r.SetBonus.ToString("F2"));
            fields.Add((r.MaxLevel - r.Level).ToString());
            fields.Add(Csv(upgradesRequiredForResists));

            lines.Add(string.Join(",", fields));
        }

        var csvText = string.Join(Environment.NewLine, lines);

        // Trigger download
        await JS.InvokeVoidAsync(
            "download.fromText",
            "DDEquipment.csv",
            "text/csv;charset=utf-8",
            csvText
        );
    }
}
