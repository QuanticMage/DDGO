@page "/"
@implements IDisposable
@using Microsoft.JSInterop
@using System.Text.Json
@using System.Text.RegularExpressions

<div class="top-pane">
    <div class="left-pane">
        <h1 >Dungeon Defenders Gear Optimizer</h1>        
        <div class="build"><i>Jan 25 2026 - Version 1.4</i></div>    
        <div id="@_dropZoneId" class="dropzone dz2 @( _isDragOver ? "over" : "" )">

            @* ============== EMPTY FILE TILE, BEFORE WE'VE LOADED ============== *@            
            @if (!_showContent)
            {
                <div class="dz2-card">

                    <div class="dz2-sub">
                        Select your data file to get started.
                    </div>

                    <div class="dz2-drop">
                        <div class="dz2-drop-inner">
                            <div class="dz2-drop-icon" aria-hidden="true">📁</div>
                            <div class="dz2-drop-text">Drag &amp; Drop File Here</div>
                            <div class="dz2-drop-hint">
                                Drag your <b>DunDefHeroes.dun</b> file into this box
                            </div>
                        </div>
                    </div>

                    <div class="dz2-or">
                        <span class="dz2-or-line"></span>
                        <span class="dz2-or-text">Or</span>
                        <span class="dz2-or-line"></span>
                    </div>

                    <button type="button" class="dz2-btn dz2-btn-primary" @onclick="OpenFileDialog">
                        <span class="dz2-btn-icon" aria-hidden="true">📁</span>
                        <span>Browse for file…</span>
                    </button>

                    <button type="button"
                            class="dz2-help"
                            aria-expanded="@(!_hideDropzoneHelp)"
                            @onclick="TogglePrepHelp">
                        <span class="dz2-help-caret" aria-hidden="true">@(_hideDropzoneHelp ? "▸" : "▾")</span>
                        <span>How do I find or prepare the file?</span>
                    </button>

                    <div class="dz2-help-body @( _hideDropzoneHelp ? "hidden" : "" )">
                        <ul>
                            <li>Run Dungeon Defenders, log into Ranked, then click Export to Open</li>
                            <li>Go to Dungeon Defenders in your Steam library, right-click, Manage &gt; Browse Local Files</li>
                            <li>Then open the Binaries\Win32 or Win64 folder (whichever you run), and drag <b>DunDefHeroes.dun</b> here.</li>
                            <li>This runs locally. Only aggregate armor ratings are sent to Shiro’s API for live prices, and only if you enable live prices.</li>
                        </ul>

                        @if (_canLoadLast)
                        {
                            <div class="dz2-actions">
                                <button type="button" class="dz2-btn dz2-btn-dark" @onclick="LoadLastFile">
                                    <span class="dz2-btn-icon" aria-hidden="true">⟳</span>
                                    <span>Reload last file from disk (Chrome/Edge)</span>
                                </button>
                            </div>
                        }
                    </div>
                </div>
            }
            else  @* ============== LOADED FILE TILE ============== *@          
            {
                <div class="dz2-card-loaded">
                    <div class="dz2-filename">@_loadedFileName</div>                                                                    
                    @* status *@
                    @if (_isLoading)
                    {
                        <div class="status">Loading… @_status</div>
                    }
                    else if (!string.IsNullOrEmpty(_error))
                    {
                        <div class="status error">@_error</div>
                    }
                    else if (!string.IsNullOrEmpty(_status))
                    {
                        <div class="status">@_status</div>
                        @_status2
                    }                                          
                    <div class="dz2-actions">
                        @if (_canLoadLast)
                        {
                            <button type="button" class="dz2-btn dz2-btn-ghost" @onclick="LoadLastFile">
                                <span class="dz2-btn-icon" aria-hidden="true">⟳</span>
                                <span>Reload</span>
                            </button>
                        }

                        <button type="button" class="dz2-btn dz2-btn-ghost" @onclick="OpenFileDialog">
                            <span>Load new</span>
                        </button>
                    </div>
                </div>
            }       
        </div>
    </div>

     @* ============== CREDITS AND LINK PANE ============== *@     
    <aside class="info-pane">
        <div class="credits">            
            <div class="credits-by">Created by <i>Mage (&#64;entangledmage)</i></div>
            <div class="credits-thanks">Based on item DB by <i>Tbolt</i>, using price estimates by <i>Shiro and Sesar</i></div>            
            <div class="credits-thanks">Special Thanks to <i>Cerium, Chiku, Scryllix, Shiro, Sesar, SteveTrevor, Tbolt, and Thales</i></div>            
        </div>

    <h3 class="links-title">Quick Links</h3>
    <ul class="link-list">
        <li><a href="https://dungeondefenders.wiki.gg" rel="noopener">Dungeon Defender's Wiki</a></li>
        <li><a href="https://steamcommunity.com/sharedfiles/filedetails/?id=2968079729" rel="noopener">Chiku’s Guide</a></li>
        <li><a href="https://docs.google.com/spreadsheets/d/11v0h3LLUDYEkTxvkLVWUzYv8wXvjZ1cPTJJ-o1QqVDM/edit?gid=1598543540#gid=1598543540" rel="noopener">Best-in-Slot Doc</a></li>
        <li><a href="https://www.dundefplanner.com" target="_blank" rel="noopener">DunDefPlanner for sharing layouts</a></li>           
        <li><a href="https://docs.google.com/spreadsheets/d/1XzYuWB4I9RoNe8x-DD2M1koWs72tW8sTgyQ_n-d7l-E/edit?pli=1&gid=2059687993#gid=2059687993" rel="noopener">Event price sheet</a></li>
    </ul>    
    </aside>
</div>

@if (@_showContent)
{
<div class="middle-pane">    
    <div class="middle-left">    
    <div class="utility-row">
        <span class="utility-label"><font face="Arial">⚙️</font></span>

        <label class="utility-toggle">
            <input type="checkbox"
                   class="tool-filter"
                   checked="@_censor"
                   @onchange="@((e) => { _censor = (bool)e.Value!; QueueSaveUiState(); StateHasChanged(); })" />
            <span>Censor Ult++</span>
        </label>

        <label class="utility-toggle">
            <input type="checkbox"
                   class="tool-filter"
                   checked="@_highlight"
                   @onchange="@((e) => { _highlight = (bool)e.Value!; QueueSaveUiState(); StateHasChanged(); })" />
            <span>Highlight Best</span>
        </label>
    
        <label class="utility-toggle">
            <input type="checkbox"
                   class="tool-filter"
                   checked="@_livePrices"
                   @onchange="@((e) => { _livePrices = e.Value is bool b && b; QueueSaveUiState(); if (_livePrices) GetLivePrices(); })" />
            <span>Get Live Prices</span>
        </label>

        <label class="utility-select">
            <span>Itembox size</span>
            <select value="@_itemboxSize" @onchange="OnItemboxSizeChanged" font="inherit">
                <option value="5x3">5x3</option>
                <option value="4x3">4x3</option>
                <option value="6x4">6x4</option>
            </select>
        </label>
    </div>
    <br/>
    <div class="rateby-pane">    
        <div class="rateby-header">
            Rating Mode
        </div>    
        <div class="toolbar">
        @foreach (var opt in _modeOptions)
        {
            <input class="tool-radio"
                    type="radio"
                    name="setOptions"
                    id="@($"mode-{opt.Value}")"
                    value="@opt.Value"
                    checked="@(_selectedMode == opt.Value)"
                    @onchange="() => SetMode(opt.Value)" />

            <label class="tool-btn" for="@($"mode-{opt.Value}")">
                @opt.Label
            </label>
        }
         </div>
    </div>
    <div class="filters-menu-header">
        Filters
    </div>
    <div class="filters-column">
        <FilterChips Title="Type" Theme="type"
                     Options="_typeOptions"
                     Placeholder="Any"
                     ShowNoneAll="true"
                     MenuMaxHeightPx="520"
                     @bind-Selected="SelectedTypes"
                     Presets="@(new[]
                     {
                         new FilterChips.Preset("Armor", new [] { "Helmet", "Gauntlet", "Boots", "Torso"}),       
                     })"  />       

        <FilterChips Title="Set" Theme="set"
                     Options="_setOptions"
                     Placeholder="Any"
                     ShowNoneAll="true"
                     MenuMaxHeightPx="520"
                     @bind-Selected="SelectedSets"    
                     Presets="@(new[]
                     {
                         new FilterChips.Preset("Armor", new [] { "Pristine", "Plate", "Chain", "Mail", "Leather", "Zamira"}),       
                         new FilterChips.Preset("Weapons", new [] { "Squire", "Apprentice", "Monk", "Huntress"}),       
                     })"  />       

        <FilterChips Title="Other" Theme="other"
                        Options="_otherOptions"
                        Placeholder="None"
                        @bind-Selected="SelectedOther" />
            <div class="filter-search-row">
                <div class="filter-search-label">
                    Custom
                </div>

                <div class="filter-search-control">
            
                    <SearchBar @bind-Value="_searchText"
                                OnDebounced="ApplySearch"/>
                    <button type="button"
                            class="help-icon"
                            aria-label="Search help"
                            data-tooltip="@SearchHelp">
                    ?
                    </button>
                </div>
            </div>
    </div>


    @code {
        private List<string> _selectedTypes = new();
        private List<string> _selectedSets = new();
        private List<string> _selectedOther = new();

        // Bind targets 
        private List<string> SelectedTypes
        {
            get => _selectedTypes;
            set
            {
                _selectedTypes = value ?? new();
                ApplyChipFilters();
            }
        }

        private List<string> SelectedSets
        {
            get => _selectedSets;
            set
            {
                _selectedSets = value ?? new();
                ApplyChipFilters();
            }
        }

        private List<string> SelectedOther
        {
            get => _selectedOther;
            set
            {
                _selectedOther = value ?? new();
                ApplyChipFilters();
            }
        }    



        private readonly List<FilterChips.Option> _typeOptions = new()
        {

            new("Helmet"),
            new("Gauntlet"),
            new("Torso"),
            new("Boots"),
            new("Brooch"),
            new("Mask"),
            new("Bracers"),
            new("Shield"),        
            new("Pets"),
            new("Weapons"),      
            new("Currency"),             
        };

        private readonly List<FilterChips.Option> _setOptions = new()
        {
            new("Pristine"),
            new("Plate"),
            new("Chain"),
            new("Mail"),
            new("Leather"),      
            new("Zamira"),      
            new("Squire"),
            new("Apprentice"),
            new("Monk"),
            new("Huntress"),        
        };

        private readonly List<FilterChips.Option> _otherOptions = new()
        {
        
            new("Only Events",    MutexGroup: "eventMode"),
            new("Exclude Events", MutexGroup: "eventMode"),

            new("Only Equipped", MutexGroup: "equipMode"),        
            new("Exclude Equipped", MutexGroup: "equipMode"),        

            new("Exclude Missing Resists"),          
        };
    }

    <div class="summary">@_summary</div> 
    <div class="stats-row">
      <div class="metric-card highlighted-card">
        <span class="metric-label">Best Filtered Armor Set</span>
        <div class="metric-main">
          <span class="metric-number">@BestArmorRating</span>
          <span class="metric-type  highlighted-card-type">@BestArmorType</span>
        </div>
      </div>

      <div class="metric-card">
        <span class="metric-label">Vanity Account Armor Total</span>    
        <div class="metric-main">
          <span class="metric-number">@ArmorTotalValue</span>
          <span class="metric-type">CV</span>
        </div>
      </div>

      <div class="metric-card">
        <span class="metric-label">Vanity Account Event Total</span>
         <div class="metric-main">
          <span class="metric-number">@EventTotalValue</span>
          <span class="metric-type">CV</span>

          <button type="button" class="metric-mini-pill" @onclick="ShowEventCollection">
           @CollectedEventCount / @TotalEventCount
          </button>
        </div>

      </div>
    </div>

    @if (_showEventCollection)
    {
        <div class="event-overlay-backdrop" @onclick="CloseEventCollection" role="presentation">
            <div class="event-overlay-panel" role="dialog" aria-modal="true" aria-label="Event collection" @onclick:stopPropagation="true">
                <div class="event-overlay-header">
                    <div class="event-overlay-titlewrap">
                        <div class="event-overlay-title">Event Collection</div>
                        <div class="event-overlay-sub">@CollectedEventCount / @TotalEventCount collected</div>
                    </div>
                    <button type="button" class="event-overlay-export" title="Export" @onclick="ExportEventCollection">Copy To Clipboard</button>
                    <button type="button" class="event-overlay-close" title="Close" @onclick="CloseEventCollection">×</button>
                </div>

                <div class="event-overlay-tools">
                    <input class="event-search"
                           placeholder="Search categories…"
                           @onchange="OnEventSearchChanged" />
                </div>

                <div class="event-overlay-body">
                    @foreach (var group in VisibleEventCollection
                        .GroupBy(x => x.Category)
                        .OrderBy(g => GetCategoryOrderKey(g.Key))
                        .ThenBy(g => g.Key, StringComparer.OrdinalIgnoreCase))
                    {                    
                        var cat = SplitCategory(group.Key);
                        <div class="event-cat">
                            <div class="event-cat-hdr">
                                <span class="event-cat-page">@cat.Page</span>
                                <span class="event-cat-sep">›</span>
                                <span class="event-cat-section">@cat.Section</span>
                            </div>

                            <div class="event-list">
                                @foreach (var item in group
                                    .OrderByDescending(x => x.Price)
                                    .ThenBy(x => x.Name, StringComparer.OrdinalIgnoreCase)
                                )
                                {
                                    <div class="event-row @(item.OwnedCount > 0 ? "owned" : "missing")">
                                        <div class="event-line">
                                            <div class="event-name">@item.Name</div>
                                            <div class="event-price">@(item.Price!=0?@item.Price:"Unknown") CVx</div>
                                            <span class="event-owned-badge" title="How many of this item you have">@item.OwnedCount</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
    </div> @* middle-left  *@
    <aside class="middle-right">
       <CharacterPanel/>
    </aside>

    </div> @* Middle pane *@
    <div class="bottom-pane">    

    @if (_rows.Count == 0)
    {  
    }
    else
    {
   
        <div class="grid-wrap">
        <table class="grid" @ref="_tableRef">
            <colgroup>
                <col style="width:80px" />   @* Rating *@
                <col style="width:75px" />   @* Value *@
                <col style="width:65px" />   @* BestFor *@
                <col style="width:70px" />   @* Type *@
                <col style="width:70px" />   @* Position *@

                <col style="width:15%" />    @* Name (2*) *@
                <col style="width:10%" />    @* Location (2*) *@
                <col style="width:80px" />   @* Quality *@
            
                <col style="width:55px" />   @* Lvl *@
                <col style="width:55px" />   @* MaxLvl *@

                <col style="width:60px" />   @* HHP *@
                <col style="width:60px" />   @* HDmg *@
                <col style="width:60px" />   @* HSpd *@
                <col style="width:60px" />   @* HRate *@
                <col style="width:60px" />   @* Ab1 *@
                <col style="width:60px" />   @* Ab2 *@
                <col style="width:60px" />   @* THP *@
                <col style="width:60px" />   @* TDmg *@
                <col style="width:60px" />   @* TRange *@
                <col style="width:60px" />   @* TRate *@

                <col style="width:60px" />   @* RG *@
            </colgroup>
  
            <thead>
                <tr class="rating-row">                
                    <th colspan="10">       
                
                        <span class="hint-text">
                            <span class="hint-left">
                                @VisibleCount / @TotalCount items visible
                            </span>

                            <span class="hint-right">
                                Click names to sort, or stars to adjust the rating calculation →
                            </span>
                        </span>
                    </th>
                    <th class="importance-cell">
                        <div class="th-center">
                        <button type="button" 
                                @onclick="() => ChangeImportance(nameof(ItemViewRow.HHP))">
                            <img src="@GetImportanceImage(nameof(ItemViewRow.HHP))" />
                        </button>
                        </div>
                    </th>

                        <th class="importance-cell">
                        <div class="th-center">
                       <button type="button" 
                                @onclick="() => ChangeImportance(nameof(ItemViewRow.HDmg))">
                                <img src="@GetImportanceImage(nameof(ItemViewRow.HDmg))" />
                        </button>
                        </div>
                    </th>
                         <th class="importance-cell">
                        <div class="th-center">
                   <button type="button" 
                                @onclick="() => ChangeImportance(nameof(ItemViewRow.HSpd))">
                                <img  src="@GetImportanceImage(nameof(ItemViewRow.HSpd))" />
                        </button>
                         </div>
                    </th>

                    <th class="importance-cell">
                        <div class="th-center">
                            <button type="button" 
                                @onclick="() => ChangeImportance(nameof(ItemViewRow.HRate))">
                                <img  src="@GetImportanceImage(nameof(ItemViewRow.HRate))" />
                            </button>
                        </div>                    
                    </th>

                    <th class="importance-cell">
                        <div class="th-center">
                        <button type="button" 
                                @onclick="() => ChangeImportance(nameof(ItemViewRow.Ab1))">
                                <img  src="@GetImportanceImage(nameof(ItemViewRow.Ab1))" />
                        </button>
                        </div>
                    </th>

                    <th class="importance-cell">
                        <div class="th-center">
                        <button type="button" 
                                @onclick="() => ChangeImportance(nameof(ItemViewRow.Ab2))">
                                <img  src="@GetImportanceImage(nameof(ItemViewRow.Ab2))" />
                        </button>
                        </div>
                    </th>

                    <th class="importance-cell">
                        <div class="th-center">
                        <button type="button" 
                                @onclick="() => ChangeImportance(nameof(ItemViewRow.THP))">
                                <img  src="@GetImportanceImage(nameof(ItemViewRow.THP))" />
                        </button>
                        </div>
                    </th>

                    <th class="importance-cell">
                        <div class="th-center">
                        <button type="button" 
                                @onclick="() => ChangeImportance(nameof(ItemViewRow.TDmg))">
                                <img  src="@GetImportanceImage(nameof(ItemViewRow.TDmg))" />
                        </button>
                        </div>
                    </th>

                    <th class="importance-cell">
                        <div class="th-center">
                        <button type="button" 
                                @onclick="() => ChangeImportance(nameof(ItemViewRow.TRange))">
                                <img  src="@GetImportanceImage(nameof(ItemViewRow.TRange))" />
                        </button>
                        </div>
                    </th>

                    <th class="importance-cell">
                        <div class="th-center">
                        <button type="button" 
                                @onclick="() => ChangeImportance(nameof(ItemViewRow.TRate))">
                                <img  src="@GetImportanceImage(nameof(ItemViewRow.TRate))" />
                        </button>
                        </div>

                    </th>

                    <!-- Resists (all toggle the same flag, but still distinct columns) -->

                    <th class="importance-cell">
                        <div class="th-center">
                        <button type="button"
                                @onclick="() => ChangeImportance(nameof(ItemViewRow.RG))">
                                <img  src="@GetImportanceImage(nameof(ItemViewRow.RG))" />
                        </button>
                        </div>
                    </th>

                </tr>
                <tr class="header-row" >
                    <th class="sortable" data-tooltip=@Tips["Rating"]>
                        <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.Rating))">
                            Rating <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Rating))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable" data-tooltip=@Tips["Value"]>
                        <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.Value))">
                             Est. Value* <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Value))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>
                
                    <th class="sortable">
                        <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.BestFor))">
                             Best For<span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.BestFor))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable">
                        <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.Type))">
                            Type <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Type))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable">
                        <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.Set))">
                            Set <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Set))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>
                    <th class="sortable">
                        <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.Name))">
                            Name <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Name))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable"  data-tooltip="@Tips["Location"]">
                        <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.Location))">
                            Location <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Location))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable">
                        <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.Quality))">
                            Quality <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Quality))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>


                    <th class="sortable">
                        <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.Level))">
                            Lvl <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Level))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable">
                        <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.MaxLevel))">
                            MaxLvl <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.MaxLevel))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable icon-header @HeaderShadingStyle(sumIdxHHP)">
                        <button type="button" class="th-btn th-icon" title="Hero Health" @onclick="() => SortBy(nameof(ItemViewRow.HHP))">
                            <img src="png/Hero Health.png" alt="HHP" />
                            <span class="hdr-text">Hero<br />Health</span>
                            <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.HHP))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable icon-header @HeaderShadingStyle(sumIdxHDmg)">
                        <button type="button" class="th-btn th-icon" title="Hero Damage" @onclick="() => SortBy(nameof(ItemViewRow.HDmg))">
                            <img src="png/Hero Damage.png" alt="HDmg" />
                            <span class="hdr-text">Hero<br />Damage</span>
                            <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.HDmg))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable icon-header @HeaderShadingStyle(sumIdxHSpd)">
                        <button type="button" class="th-btn th-icon" title="Hero Speed" @onclick="() => SortBy(nameof(ItemViewRow.HSpd))">
                            <img src="png/Move Speed.png" alt="HSpd" />
                            <span class="hdr-text">Hero<br />Speed</span>
                            <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.HSpd))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable icon-header @HeaderShadingStyle(sumIdxHRate)">
                        <button type="button" class="th-btn th-icon" title="Hero Casting Rate" @onclick="() => SortBy(nameof(ItemViewRow.HRate))">
                            <img src="png/Cast Rate.png" alt="HRate" />
                            <span class="hdr-text">Hero<br />Cast Rate</span>
                            <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.HRate))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable icon-header @HeaderShadingStyle(sumIdxAb1)">
                        <button type="button" class="th-btn th-icon" title="Ability 1" @onclick="() => SortBy(nameof(ItemViewRow.Ab1))">
                            <img src="png/AB1/Monk AB1.png" alt="Ab1" />
                            <span class="hdr-text">Hero<br />Ability 1</span>
                            <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Ab1))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable icon-header @HeaderShadingStyle(sumIdxAb2)">
                        <button type="button" class="th-btn th-icon" title="Ability 2" @onclick="() => SortBy(nameof(ItemViewRow.Ab2))">
                            <img src="png/AB2/Hero Boost Monk AB2.png" alt="Ab2" />
                            <span class="hdr-text">Hero<br />Ability 2</span>
                            <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Ab2))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable icon-header @HeaderShadingStyle(sumIdxTHP)">
                        <button type="button" class="th-btn th-icon" title="Tower Health" @onclick="() => SortBy(nameof(ItemViewRow.THP))">
                            <img src="png/Tower Health.png" alt="THP" />
                            <span class="hdr-text">Tower<br /> Health</span>
                            <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.THP))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable icon-header  @HeaderShadingStyle(sumIdxTDmg)">
                        <button type="button" class="th-btn th-icon" title="Tower Damage" @onclick="() => SortBy(nameof(ItemViewRow.TDmg))">
                            <img src="png/Tower Damage.png" alt="TDmg" />
                            <span class="hdr-text">Tower<br />Damage</span>
                            <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.TDmg))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable icon-header  @HeaderShadingStyle(sumIdxTRange)">
                        <button type="button" class="th-btn th-icon" title="Tower Range" @onclick="() => SortBy(nameof(ItemViewRow.TRange))">
                            <img src="png/Tower Range.png" alt="TRng" />
                            <span class="hdr-text">Tower<br />Range</span>
                            <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.TRange))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable icon-header @HeaderShadingStyle(sumIdxTRate)">
                        <button type="button" class="th-btn th-icon" title="Tower Rate" @onclick="() => SortBy(nameof(ItemViewRow.TRate))">
                            <img src="png/Tower Rate.png" alt="TRate" />
                            <span class="hdr-text">Tower<br />Rate</span>
                            <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.TRate))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable icon-header @HeaderShadingStyle(bFactorInResists?1:0)">
                        <button type="button" class="th-btn th-icon" title="Generic Resist" @onclick="() => SortBy(nameof(ItemViewRow.RG))">
                            <img src="png/all_resistances.png" alt="Res" />
                            <span class="hdr-text">Average Resistance</span>
                            <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.RG))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>            
                </tr>
            </thead>


            <tbody>
                @foreach (var r in _rows)
                {
                    <tr @key="r.Idx" class="data-row @GetRowClass(r.IsSelected, r.IsHidden)" @onclick="()=>OnRowClicked(r)">
                        <td class="cell-rating">
                            <span class="rating-primary">@r.Rating</span>
                            <span class="rating-sides">@r.Sides</span>
                        </td>
                        <td>
                            @{
                                var (text, icon, tooltip) = GetValueDisplay(r);
                                bool hasText = !string.IsNullOrWhiteSpace(text);
                                bool hasIcon = !string.IsNullOrWhiteSpace(icon);
                            }
                            <span class="value-icon @(hasText? "" : "value-icon-only")" data-tooltip="@tooltip">
                                @if (hasIcon)
                                {
                                    <img class="icon" src="@icon"/>
                                }
                                @if (hasText)
                                {
                                    <span class="label">@text</span>
                                }
                            </span>
                        </td>
                        <td class="text bestfor">@r.BestFor</td>
                        <td class="text cell-type">@r.Type</td>
                        <td class="text cell-type">@r.Set</td>
                        <td class="text cell-name" h-tooltip="@GetFunHash(r)">
                            <span class="name-row">
                                    <img class="atlas-icon"
                                        alt=""
                                        width="32" height="32"
                                        data-size="32"

                                        data-l1x="@r.IconX" data-l1y="@r.IconY"
                                        data-l2x="@r.IconX1" data-l2y="@r.IconY1" data-l2t="@r.Color1"
                                        data-l3x="@r.IconX2" data-l3y="@r.IconY2" data-l3t="@r.Color2" />
                                    <span class="name-name">
                                    @r.Name 
                                </span>
                                @{
                                    bool IsBlack(string? c)
                                    {
                                        if (string.IsNullOrWhiteSpace(c)) return true; // treat empty as "no color"
                                        var s = c.Trim().ToLowerInvariant();
                                        return s == "#000" || s == "#000000" ||
                                               s == "rgb(0,0,0)" || s == "rgb(0, 0, 0)" ||
                                               s == "rgba(0,0,0,1)" || s == "rgba(0, 0, 0, 1)";
                                    }

                                    var show = !IsBlack(r.Color1) || !IsBlack(r.Color2);
                                }

                                @if (show)
                                {
                                    <span class="name-colors">
                                        <ColorSwatches Name="" Color1="@r.Color1" Color2="@r.Color2" />
                                    </span>
                                }                      
                            </span>                      
                        </td>
                        <td class="text location">@GetLocation(r)</td>
                        <td class="text @QualityClass(r.Quality)">@r.Quality</td>
                
                        <td class="num">@r.Level</td>
                        <td class="num">@r.MaxLevel</td>

                        <td class="num cell-health @(_columnClasses[sumIdxHHP])">@GetValue(r.HHP,r)</td>
                        <td class="num cell-damage @(_columnClasses[sumIdxHDmg])">@GetValue(r.HDmg,r)</td>
                        <td class="num cell-range @(_columnClasses[sumIdxHSpd])">@GetValue(r.HSpd,r)</td>
                        <td class="num cell-rate @(_columnClasses[sumIdxHRate])">@GetValue(r.HRate,r)</td>
                        <td class="num cell-ab1 @(_columnClasses[sumIdxAb1])">@GetValue(r.Ab1,r)</td>
                        <td class="num cell-ab2 @(_columnClasses[sumIdxAb2])">@GetValue(r.Ab2,r)</td>
                        <td class="num cell-health @(_columnClasses[sumIdxTHP])">@GetValue(r.THP,r)</td>
                        <td class="num cell-damage @(_columnClasses[sumIdxTDmg])">@GetValue(r.TDmg,r)</td>
                        <td class="num cell-range @(_columnClasses[sumIdxTRange])">@GetValue(r.TRange,r)</td>
                        <td class="num cell-rate @(_columnClasses[sumIdxTRate])">@GetValue(r.TRate,r)</td>

                        <td class="resist @(_columnClasses[bFactorInResists?1:0])" 
                            data-tooltip=@(
                              $"<div class='resist-container'>" +
                                $"<img class='resist-icon' src='png/Generic Resistance.png' alt='G' /><span class='resist-val'>{r.RG}</span>" +
                                $"<img class='resist-icon' src='png/Poison Resistance.png'  class='resist-icon' alt='P' /><span class='resist-val'>{r.RP}</span>" +
                                $"<img class='resist-icon' src='png/Fire Resistance.png'    class='resist-icon' alt='F' /><span class='resist-val'>{r.RF}</span>" +
                                $"<img class='resist-icon' src='png/Lightning Resistance.png' class='resist-icon' alt='L' /><span class='resist-val'>{r.RL}</span>" +
                                $"</div><br>{ShowUpgradesToMaxResist(r)}")>                  
                            @((r.RG + r.RP + r.RF + r.RL)/4)</td>                    
                    </tr>
                }
            </tbody>
        </table>
        </div>        
    }        
    </div>
}

@code {
    [Inject] private IJSRuntime JS { get; set; } = default!;

    private int CurrentUIOptionsVersion = 1;
    private string[] _columnClasses = new[] { "cell-stat-dimmed", "cell-stat-primary", "cell-stat-side" };
    private readonly string _dropZoneId = "dropzone";
    private DotNetObjectReference<Index>? _dotNetRef;
    private bool _needsAtlasRender;
    private bool _isDragOver;
    private bool _isLoading;
    private bool _hideDropzoneHelp;
    private bool _atlasReady;
    private string _summary = "";
    private string _status = "";
    private string _status2 = "";
    private bool _showLivePrices = true;
    private string? _error;
    private DDDatabase db = new();
    private List<ItemViewRow> _rows = new();
    private record ModeOption(string Value, string Label);
    private string _sortColumn = nameof(ItemViewRow.Rating);
    private bool _sortDesc = true;
    private bool _censor = true;
    private bool _highlight = true;
    private bool _livePrices = false;
    private string _itemboxSize = "5x3";
    private bool _showContent = false;
    private bool _canLoadLast = false;
    private ElementReference _tableRef;
    private string? _loadedFileName;
    private DateTime? _lastLoadedAt;
    private UiState _ui = DefaultState();
    private string _searchText = "";
    private int CollectedEventCount = 0;
    private int TotalEventCount = 0;

    // ======= selection ==========

    void OnRowClicked( ItemViewRow row )
    {
        row.IsSelected = !row.IsSelected;
    }

    // ======= search filter ==========
    private string SearchHelp =
            @"Search syntax
    • Simple Usage (Direct search)
        Dragon → Name must contain ""Dragon""

    • Advanced Usage (Fields) 
        Ab1>=500 → Ab1 is larger or equal to 500 (must not have spaces)
        Location:ItemBox  → Location contains ""ItemBox""

    Fields
    <i>THP, TDmg, TRate, TRange, HHP, HDmg, HRate, HSpeed,
    Ab1, Ab2, ResG, ResP, ResF, ResL, Location, Quality, 
    Rating, Sides, Lvl, MaxLvl, ResSum, ResAvg, Value, Name</i>";

    private string[] ValidTags = { "location", "value", "quality", "rating", "lvl", "maxlvl", "set", "type", "best", "sides", "thp", "tdmg", "tRate", "trange", "hhp", "hdmg", "hrate", "hspd", "ab1", "ab2",  "ressum", "resavg", "resg", "resp", "resf", "resl", "name"};

    static string[] Tokenize(string input)
    {
        var matches = Regex.Matches(input, "\"([^\"]*)\"|(\\S+)");
        var tokens = new List<string>();

        foreach (Match m in matches)
        {
            if (m.Groups[1].Success)
                tokens.Add(m.Groups[1].Value); // quoted token, no quotes
            else
                tokens.Add(m.Groups[2].Value); // normal token
        }

        return tokens.ToArray();
    }

    private void ApplyMask( ItemViewRow r, bool negate, string op, string defaultop, int compareValue )
    {
        // compare value -1 means value < constant
        // compare value 1 means value > constant
        // compare value 0 means value = constant (or contains if that's the query)

        if (op == ":") op = defaultop;        

        switch (op)
        {
            case ">=":            
                if (!negate)
                    r.IsHiddenDueToSearch |= (compareValue < 0);
                else
                    r.IsHiddenDueToSearch |= (compareValue >= 0);
                break;
            case "<=":
                if (!negate)
                    r.IsHiddenDueToSearch |= (compareValue > 0);
                else
                    r.IsHiddenDueToSearch |= (compareValue <= 0);
                break;
            case ">":
                if (!negate)
                    r.IsHiddenDueToSearch |= (compareValue <= 0);
                else
                    r.IsHiddenDueToSearch |= (compareValue > 0);
                break;
            case "<":
                if (!negate)
                    r.IsHiddenDueToSearch |= (compareValue >= 0);
                else
                    r.IsHiddenDueToSearch |= (compareValue < 0);                    
                break;
            case "=":
            case "==":
                if (!negate)
                    r.IsHiddenDueToSearch |= (compareValue != 0);
                else
                    r.IsHiddenDueToSearch |= (compareValue == 0);                                    
                break;
            case "!=":
                if (!negate)
                    r.IsHiddenDueToSearch |= (compareValue == 0);
                else
                    r.IsHiddenDueToSearch |= (compareValue != 0);                                    
                break;
            default:
                break;
        }        

    }

    private void ApplySearch()
    {
        foreach (var r in _rows) r.IsHiddenDueToSearch = false;
        string[] tokens = Tokenize(_searchText);
        foreach( string t in tokens )
        {
            string[] parts = Regex.Split(t, @"(<=|>=|<|>|:|=|!=|==)");

            if (parts.Length == 0) continue;
            bool negateTag = false;
            if ((parts[0] != null) && (parts[0] != "") && (parts[0][0] == '-'))
            {
                negateTag = true;
                parts[0] = parts[0].Substring(1);
            }

            if (parts.Length == 1)
            {                
                foreach (var r in _rows) ApplyMask( r, negateTag, ":", "=", (r.Name.Contains(parts[0], StringComparison.InvariantCultureIgnoreCase)?0:1));
                continue;
            }
            else if (parts.Length > 2) // operator
            {
                // normalize tags
                string tag = parts[0].ToLowerInvariant();
                tag.Replace("damage", "dmg");
                tag.Replace("tower", "t");
                tag.Replace("hero", "h");
                tag.Replace("ability", "ab");
                tag.Replace("health", "hp");
                tag.Replace("level", "lvl");
                tag.Replace("resistance", "res");                
                tag.Replace("resist", "res");
                tag.Replace("speed", "spd");

                string valueString = parts[2].Trim().ToLowerInvariant();
                int valueNum = 0;
                Int32.TryParse( valueString, out valueNum );

                string actualTag = "";
                for (int i = 0; i < ValidTags.Length; i++)
                {
                    if (ValidTags[i].Contains(tag))
                    {
                        actualTag = ValidTags[i];
                        break;
                    }
                }
                string op = parts[1];
                if (actualTag == "") continue;
                switch (actualTag)
                {
                    case "thp": foreach (var r in _rows) ApplyMask( r, negateTag, op, ">", r.THP.CompareTo(valueNum)); break;
                    case "tdmg": foreach (var r in _rows) ApplyMask( r, negateTag, op, ">", r.TDmg.CompareTo(valueNum)); break;
                    case "tRate": foreach (var r in _rows)  ApplyMask( r, negateTag, op, ">", r.TRate.CompareTo(valueNum)); break;                        
                    case "trange": foreach (var r in _rows)  ApplyMask( r, negateTag, op, ">", r.TRange.CompareTo(valueNum)); break;                        
                    case "hhp": foreach (var r in _rows)  ApplyMask( r, negateTag, op, ">", r.HHP.CompareTo(valueNum)); break;                        
                    case "hdmg": foreach (var r in _rows)  ApplyMask( r, negateTag, op, ">", r.HDmg.CompareTo(valueNum)); break;                        
                    case "hrate": foreach (var r in _rows)  ApplyMask( r, negateTag, op, ">", r.HRate.CompareTo(valueNum)); break;
                    case "hspeed": foreach (var r in _rows)  ApplyMask( r, negateTag, op, ">", r.HSpd.CompareTo(valueNum)); break;
                    case "ab1": foreach (var r in _rows) ApplyMask( r, negateTag, op, ">", r.Ab1.CompareTo(valueNum)); break;                        
                    case "ab2": foreach (var r in _rows)  ApplyMask( r, negateTag, op, ">", r.Ab2.CompareTo(valueNum)); break;
                    case "resg": foreach (var r in _rows)  ApplyMask( r, negateTag, op, ">", r.RG.CompareTo(valueNum)); break;
                    case "resp": foreach (var r in _rows) ApplyMask( r, negateTag, op, ">", r.RP.CompareTo(valueNum)); break;
                    case "resf": foreach (var r in _rows)  ApplyMask( r, negateTag, op, ">", r.RF.CompareTo(valueNum)); break;
                    case "resl": foreach (var r in _rows)  ApplyMask( r, negateTag, op, ">", r.RL.CompareTo(valueNum)); break;
                    case "location": foreach (var r in _rows) ApplyMask( r, negateTag, ":", "=", (r.Location.Contains(valueString, StringComparison.InvariantCultureIgnoreCase)?0:1)); break;
                    case "quality": foreach (var r in _rows) ApplyMask( r, negateTag, ":", "=", (r.Quality.Contains(valueString, StringComparison.InvariantCultureIgnoreCase)?0:1));; break;                        
                    case "rating": foreach (var r in _rows) ApplyMask( r, negateTag, op, ">", r.Rating.CompareTo(valueNum)); break;
                    case "sides": foreach (var r in _rows) ApplyMask( r, negateTag, op, ">", r.Sides.CompareTo(valueNum)); break;
                    case "lvl": foreach (var r in _rows) ApplyMask( r, negateTag, op, ">", r.Level.CompareTo(valueNum)); break;
                    case "maxlvl": foreach (var r in _rows) ApplyMask( r, negateTag, op, ">", r.MaxLevel.CompareTo(valueNum)); break;
                    case "value": foreach (var r in _rows) ApplyMask( r, negateTag, op, ">", r.Value.CompareTo(valueNum)); break;
                    case "set": foreach (var r in _rows) ApplyMask( r, negateTag, ":", "=", (r.Set.Contains(valueString, StringComparison.InvariantCultureIgnoreCase)?0:1)); break;                        
                    case "type": foreach (var r in _rows) ApplyMask( r, negateTag, ":", "=", (r.Type.Contains(valueString, StringComparison.InvariantCultureIgnoreCase)?0:1)); break;                        
                    case "best": foreach (var r in _rows) ApplyMask( r, negateTag, ":", "=", (r.BestFor.Contains(valueString, StringComparison.InvariantCultureIgnoreCase)?0:1)); break;                        
                    case "ressum":foreach (var r in _rows) ApplyMask( r, negateTag, op, ">", (r.RG + r.RF + r.RL + r.RP).CompareTo(valueNum)); break;
                    case "resavg":foreach (var r in _rows) ApplyMask( r, negateTag, op, ">", ((r.RG + r.RF + r.RL + r.RP)/4).CompareTo(valueNum)); break;                        
                    case "name":foreach (var r in _rows) ApplyMask( r, negateTag, ":", "=", (r.Name.Contains(valueString, StringComparison.InvariantCultureIgnoreCase)?0:1)); break;                                                
                }
            }

        }        
        

        // this will also update our search
        ApplyChipFilters();              
    }

    // ===== Event Collection Overlay =====
    private bool _showEventCollection = false;
    private string _eventSearch = "";

    private sealed record EventCollectionRow(
        string Name,
       string Category,
        int Price,
        int OwnedCount);


    private List<EventCollectionRow> _eventCollection = new();

    private IEnumerable<EventCollectionRow> VisibleEventCollection
    {
        get
        {
            if (_eventCollection.Count == 0)
                return Array.Empty<EventCollectionRow>();

            if (string.IsNullOrWhiteSpace(_eventSearch))
                return _eventCollection;

            var s = _eventSearch.Trim();            
            return _eventCollection.Where(x => ((x.Category != null) && (x.Category.Contains(s, StringComparison.OrdinalIgnoreCase))) || ((x.Name != null) && (x.Name.Contains(s, StringComparison.OrdinalIgnoreCase))));
        }
    }

    // Apply category filter only after the user finishes editing the textbox.
    private void OnEventSearchChanged(ChangeEventArgs e)
    {
        _eventSearch = e.Value?.ToString() ?? "";
        StateHasChanged();
    }

    public void ShowEventCollection()
    {
        RebuildEventCollection();
        _showEventCollection = true;
        StateHasChanged();
    }

    private async void ExportEventCollection()
    {
        if (_eventCollection == null || _eventCollection.Count == 0)
            return;

        // Alphabetical by name
        var lines = _eventCollection
            .OrderBy(x => x.Name, StringComparer.OrdinalIgnoreCase)
            .Select(x => $"{x.Name}\t{x.OwnedCount}");

        var text = string.Join(Environment.NewLine, lines);

        await JS.InvokeVoidAsync("copyToClipboard", text);
    }

    private void CloseEventCollection()
    {
        _showEventCollection = false;
        _eventSearch = "";
        StateHasChanged();
    }


    private string ShowUpgradesToMaxResist( ItemViewRow r )
    {
        int upgradesRequiredForResists = Ratings.GetUpgradesRequired(r.ResistanceTarget, r.RG, r.RP, r.RF, r.RL);
        int overcappedUpgradesLeft = (r.MaxLevel - r.Level) / 10;
        int overcappedUpgradesNeeded =
            (r.ResistanceTarget - ((r.RG < 23) ? 23 : r.RG)) +
            (r.ResistanceTarget - ((r.RP < 23) ? 23 : r.RP)) +
            (r.ResistanceTarget - ((r.RF < 23) ? 23 : r.RF)) +
            (r.ResistanceTarget - ((r.RL < 23) ? 23 : r.RL));

        if ((overcappedUpgradesLeft < overcappedUpgradesNeeded) || ( upgradesRequiredForResists > (r.MaxLevel - r.Level)))        
            return "Can't cap with remaining levels";
        else if (upgradesRequiredForResists == 0)
            return "";        
        return $"{upgradesRequiredForResists} levels required for cap";
    }



    private static (string Page, string Section) SplitCategory(string category)
    {
        if (string.IsNullOrWhiteSpace(category)) return ("Other", "");

        var parts = category.Split('>');
        var page = (parts.Length > 0 ? parts[0] : category).Trim();
        var section = (parts.Length > 1 ? parts[1] : "").Trim();
        if (page.Equals("Unknown", StringComparison.OrdinalIgnoreCase)) page = "Unknown";
        return (string.IsNullOrWhiteSpace(page) ? "Other" : page, section);
    }


    // Desired category ordering for the Event Collection overlay
    private static readonly string[] _eventCategoryOrder = new[]
    {
        "Weapons > Apprentice",
        "Weapons > Huntress",
        "Weapons > Monk",
        "Weapons > Squire",
        "Weapons > Exclusive",

        "Accessories > High End Hats",
        "Accessories > High End Masks",
        "Accessories > High End Bracers",
        "Accessories > Mid End Hats",
        "Accessories > Mid End Masks",
        "Accessories > Mid End Bracers",
        "Accessories > Hats",
        "Accessories > Shields",
        "Accessories > Masks",
        "Accessories > Bracers",
        "Accessories > Armor Pieces",
        "Accessories > Exclusive Armor Pieces",
        "Accessories > Exclusives",

        "Pets > Guardians",
        "Pets > Streamer",
        "Pets > DPS",
        "Pets > Builder",
        "Pets > Collectibles",
        "Pets > Exclusives",

        "Unknown",
    };

    private static readonly Dictionary<string, int> _eventCategoryOrderMap = BuildEventCategoryOrderMap();

    private static Dictionary<string, int> BuildEventCategoryOrderMap()
    {
        var d = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase);
        for (int i = 0; i < _eventCategoryOrder.Length; i++)
            d[_eventCategoryOrder[i]] = i;
        return d;
    }

    private static string NormalizeCategoryKey(string category)
    {
        if (string.IsNullOrWhiteSpace(category)) return "Unknown";

        var s = category.Trim();
        if (s.Equals("unknown", StringComparison.OrdinalIgnoreCase))
            return "Unknown";

        var parts = s.Split('>');
        if (parts.Length == 1)
            return parts[0].Trim();

        var page = parts[0].Trim();
        var section = parts.Length > 1 ? parts[1].Trim() : "";
        if (page.Equals("unknown", StringComparison.OrdinalIgnoreCase)) page = "Unknown";
        return string.IsNullOrWhiteSpace(section) ? page : $"{page} > {section}";
    }

    private static int GetCategoryOrderKey(string category)
    {
        var key = NormalizeCategoryKey(category);
        if (_eventCategoryOrderMap.TryGetValue(key, out var i))
            return i;

        return 10000;
    }

    private void RebuildEventCollection()
    {
        // Total: unique EventItem names in the price guide (guide has duplicates by design)
        var all = EventPriceGuide.HashToEventInfo.Values;

        // Build (unique-name) catalog using the most expensive entry as representative
        var catalog = all
            .GroupBy(x => x.ItemName, StringComparer.OrdinalIgnoreCase)
            .Select(g =>
            {
                var rep = g.OrderByDescending(x => x.Price).First();
                return (Name: rep.ItemName, Category: rep.Category, Price: rep.Price);
            })
            .ToList();

        TotalEventCount = catalog.Count;

        // Owned counts: count how many of your _rows are events, and their hash resolves to an EventItemInfo
        var ownedByName = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase);

        foreach (var r in _rows)
        {
            if (!r.IsEvent) continue;

            if (!ItemHash.TryPhraseToInt30(r.FunHashString, out uint h))
                continue;

            if (!EventPriceGuide.HashToEventInfo.TryGetValue(h, out var info))
                continue;

            ownedByName[info.ItemName] = ownedByName.TryGetValue(info.ItemName, out var c) ? (c + 1) : 1;
        }

        _eventCollection = catalog
            .Select(x => new EventCollectionRow(
                Name: x.Name,
                Category: x.Category,
                Price: x.Price,
                OwnedCount: ownedByName.TryGetValue(x.Name, out var c) ? c : 0))
            .ToList();


/*      var uncollectedEvents = _eventCollection
    .Where(x => x.OwnedCount == 0)
    .ToList();*/
    CollectedEventCount = _eventCollection.Count(x => x.OwnedCount > 0);
    }

    public sealed record UiState(
        int Version = 1,
        string RatingMode = "Builder App",
        string Layout = "5x3",
        bool ShowLivePrices = false,
        List<string>? SelectedTypes = null,
        List<string>? SelectedSets = null,
        List<string>? SelectedOther = null)
    {
        public List<string> SelectedTypesSafe => SelectedTypes ?? new();
        public List<string> SelectedSetsSafe => SelectedSets ?? new();
        public List<string> SelectedOtherSafe => SelectedOther ?? new();
    }

    static UiState DefaultState() => new(
        Version: 1,
        RatingMode: "Builder App",
        Layout: "5x3",
        ShowLivePrices: false,
        SelectedSets: new() { "Chain", "Mail", "Pristine", "Leather", "Plate" },
        SelectedTypes: new() { "Helmet", "Torso", "Gauntlet", "Boots" },
        SelectedOther: new() { "Exclude Events" }
        );

    private void ApplyUiToFields()
    {
        _selectedMode = _ui.RatingMode;
        _itemboxSize  = _ui.Layout;
        _livePrices   = _ui.ShowLivePrices;

        _selectedTypes = _ui.SelectedTypesSafe.ToList();
        _selectedSets  = _ui.SelectedSetsSafe.ToList();
        _selectedOther = _ui.SelectedOtherSafe.ToList();

        SetMode(_selectedMode);
        ApplyChipFilters();
    }

    private void SyncFieldsToUi()
    {
        _ui = _ui with
        {
            Version = CurrentUIOptionsVersion,
            RatingMode = _selectedMode,
            Layout = _itemboxSize,
            ShowLivePrices = _livePrices,
            SelectedTypes = _selectedTypes.ToList(),
            SelectedSets = _selectedSets.ToList(),
            SelectedOther = _selectedOther.ToList()
        };
    }

    // remove some day
    private bool _showOutOfDateHint = false;

    private string LastLoadedText =>
        _lastLoadedAt is null ? "just now" : Humanize(_lastLoadedAt.Value);

    private static string Humanize(DateTime dt)
    {
        var span = DateTime.Now - dt;
        if (span.TotalSeconds < 30) return "just now";
        if (span.TotalMinutes < 1) return $"{(int)span.TotalSeconds} seconds ago";
        if (span.TotalHours < 1) return $"{(int)span.TotalMinutes} minutes ago";
        if (span.TotalDays < 1) return $"{(int)span.TotalHours} hours ago";
        return $"{(int)span.TotalDays} days ago";
    }

    private void TogglePrepHelp() => _hideDropzoneHelp = !_hideDropzoneHelp;


    private void OnItemboxSizeChanged(ChangeEventArgs e)
    {
        _itemboxSize = e.Value?.ToString() ?? "5x3";
        QueueSaveUiState();
        StateHasChanged(); // This forces the GetLocation() method to re-run for all rows
    }

    public string GetLocation( ItemViewRow viewRow)
    {
        // no folders for tavern or characters
        if (( viewRow.IndexInFolder == -1) || (viewRow.Location[0] == 'T') || (viewRow.Location[0] == 'C'))
            return viewRow.Location;

        int idx = viewRow.IndexInFolder;
        int itemsPerPage = 15;
        if (_itemboxSize == "5x3") itemsPerPage = 15;
        if (_itemboxSize == "4x3") itemsPerPage = 12;
        if (_itemboxSize == "6x4") itemsPerPage = 24;

        int subFolderItems = (db.SubfolderCount.ContainsKey(viewRow.Location)) ? db.SubfolderCount[viewRow.Location] : 0;

        itemsPerPage-= subFolderItems;
        int pageNumber = (int)(viewRow.IndexInFolder / itemsPerPage) + 1;
        return viewRow.Location + " (" + pageNumber.ToString() + ")";

    }


    public void SetPriceStatus(string stat, bool showLivePrices)
    {
        _status2 = stat;
        _showLivePrices = showLivePrices;
        StateHasChanged();        

    }

    // TOOLTIPS GO HERE

    private static readonly Dictionary<string, string> Tips = new()
    {  
        ["Rating"] =    "Rating for the given selected\n stats.  Small number is sides.",
        ["Value"] =     "Estimated value based on highest value role.  \nStars show how good it is relative\n to your best piece of that type for any role.\nIf you see a wrong price, \nlet Shiro and Mage know.",
        ["Location"] =  "Location (and page) of item when sorting by Level"
    };

    // Note: filtering is now driven by FilterChips selections (SelectedTypes/SelectedSets/SelectedOther)
    // instead of a bitflag enum.

    private readonly List<ModeOption> _modeOptions = new()
    {
        new("Builder Stats", "Builder Stats"),
        new("Hero Stats", "Hero Stats"),
        new("Builder App", "Builder App"),
        new("Builder Hermit", "Builder Hermit"),
        new("Builder TRange", "Builder TRange"),
        new("Builder EV", "Builder EV"),
        new("Builder Summoner", "Builder Summoner"),
        new("AB1 Only (TB)", "AB1 Only (TB)"),
        new("DPS AB1", "DPS AB1"),
        new("DPS AB2", "DPS AB2"),
        new("Pure DPS", "Pure DPS"),        
        new("Gunwitch", "Gunwitch"),        
        new("Guardian Summoner", "Guardian Summoner"),
        //new("Best Rating", "Best Rating")
    };

    private (string text, string icon, string tooltip) GetValueDisplay(ItemViewRow row)
    {
        if (row.IsEvent && (row.Value == 0))
        {
            return ("💎 ???", "", "");
        }

        if (row.Value > 0)
        {
            if (row.Value > 300)
                return ("💰Auction", "", "Estimated " + row.Value.ToString() + "cv");
            else
                return ("💎" + row.Value.ToString() + "cv", "", "");
        }
        else
        {
            if ((row.Type != "Weapon") && (row.Type != "Pet") && (row.Type != "Currency"))
            {
                if (row.Value > -100) return ("⭐️⭐️⭐️", "", "");// "png/ValueHighest.png");
                else if (row.Value > -200) return ("⭐️⭐️", "", "");// "png/ValueHigh.png");
                else if (row.Value > -300) return ("⭐️", "", "");//"png/ValueMid.png");
                else  return ("❌", "", "");// "png/ValueLow.png");               
            }
            return ("", "", "");
        }

    }

    private string _selectedMode = "";

    private bool IsCensorEnabled => _censor;

    private static readonly HashSet<string> ArmorSetNames = new(StringComparer.OrdinalIgnoreCase)
    {
        "Pristine", "Plate", "Chain", "Mail", "Leather", "Zamira"
    };

    private string GetValue( int value, ItemViewRow r )
    {
        string s = value.ToString();

        if ( ((r.Quality == "Ult++") && IsCensorEnabled) ||
            (((r.Quality == "Ult++") || (r.Quality == "Ult+") || (r.Quality == "Ult90") || (r.Quality == "Ult93") || (r.Quality == "Supreme") || (r.Quality == "Transcendent"))
              && ((r.Name == "Unicorn") || (r.Name == "Rainbow Unicorn") || (r.Name == "Propeller Cat"))))
            return s.Substring(0, s.Length - 1) + "x";            
        else
            return s;

    }

    int VisibleCount => _rows.Count(r => !r.IsHidden);
    int TotalCount => _rows.Count;

    private void ApplyChipFilters()
    {
        if (_rows.Count == 0)
            return;

        bool onlyEvents = _selectedOther.Contains("Only Events");
        bool excludeEvents = _selectedOther.Contains("Exclude Events");

        bool onlyEquipped = _selectedOther.Contains("Only Equipped");
        bool excludeEquipped = _selectedOther.Contains("Exclude Equipped");

        bool excludeMissingResists = _selectedOther.Contains("Exclude Missing Resists");

        foreach (var v in _rows)
        {
            // ---- Type filtering (OR within the chip group) ----
            bool typeOk;
            if (_selectedTypes.Count == 0)
            {
                typeOk = true; // no selection => include all
            }
            else
            {
                var typeLabel = v.Type switch
                {
                    "Pet" => "Pets",
                    "Weapon" => "Weapons",
                    _ => v.Type
                };

                typeOk = _selectedTypes.Contains(typeLabel);
            }

            // ---- Set filtering (OR within the chip group) ----
            bool setOk;
            if (_selectedSets.Count == 0)
            {
                setOk = true;
            }
            else if (v.IsArmor)
            {
                // Armor: treat Set="Any" as matching any *armor* set selection.
                if (string.Equals(v.Set, "Any", StringComparison.OrdinalIgnoreCase))
                {
                    setOk = _selectedSets.Any(s => ArmorSetNames.Contains(s));
                }
                else
                {
                    setOk = _selectedSets.Contains(v.Set);
                }
            }
            else
            {
                // Non-armor: Set is usually the weapon archetype (Squire/Monk/etc.)
                setOk = _selectedSets.Contains(v.Set) || string.Equals(v.Set, "Any", StringComparison.OrdinalIgnoreCase);
            }

            bool includeItem = typeOk && setOk;

            if (onlyEvents)
                includeItem &= v.IsEvent;
            if (excludeEvents)
                includeItem &= !v.IsEvent;

            if (onlyEquipped)
                includeItem &= v.IsEquipped;
            if (excludeEquipped)
                includeItem &= !v.IsEquipped;

            if (excludeMissingResists)
                includeItem &= !v.IsMissingResists;

            if (v.IsHiddenDueToSearch)
                includeItem = false;

            v.IsHidden = !includeItem;
        }
        QueueSaveUiState();
        RecalculateRatings();
    }


    private bool bFactorInResists = false;
    private int sumIdxHHP = 0;
    private int sumIdxHDmg = 0;
    private int sumIdxHSpd = 0;
    private int sumIdxHRate = 0;
    private int sumIdxAb1 = 0;
    private int sumIdxAb2 = 0;
    private int sumIdxTHP = 0;
    private int sumIdxTDmg = 0;
    private int sumIdxTRange = 0;
    private int sumIdxTRate = 0;

    private static string HeaderShadingStyle(int idx)
    {
        if (idx == 1) return "table-header-primary";
        if (idx == 2) return "table-header-secondary";
        return "table-header-none";
    }

    private void SetMode(string mode)
    {
        _selectedMode = mode;
        // TODO: this is ugly.  Make it a structure or bitflag or something
        // ignore = 0, rating = 1, sides = 2
        int[] sum = new int[3];
        bFactorInResists = false;
        sumIdxHHP = 0;
        sumIdxHDmg = 0;
        sumIdxHSpd = 0;
        sumIdxHRate = 0;
        sumIdxAb1 = 0;
        sumIdxAb2 = 0;
        sumIdxTHP = 0;
        sumIdxTDmg = 0;
        sumIdxTRange = 0;
        sumIdxTRate = 0;

        switch (mode)
        {
            case "Builder Stats":                
                sumIdxTHP = 1;
                sumIdxTDmg = 1;
                sumIdxTRange = 1;
                sumIdxTRate = 1;
                break;
            case "Hero Stats":
                sumIdxHHP = 1;
                sumIdxHDmg = 1;
                sumIdxHSpd = 1;
                sumIdxHRate = 1;
                sumIdxAb1 = 1;
                sumIdxAb2 = 1;
                break;            
            case "Builder App":
                sumIdxTHP = 2;
                sumIdxTDmg = 1;
                sumIdxTRange = 1;
                sumIdxTRate = 1;
                break;
            case "Builder Hermit":
                sumIdxTHP = 1;
                sumIdxTDmg = 1;
                sumIdxTRange = 1;
                sumIdxTRate = 2;
                break;
            case "Builder TRange":
                sumIdxTHP = 2;
                sumIdxTDmg = 2;
                sumIdxTRange = 1;
                sumIdxTRate = 2;
                break;
            case "Builder EV":
                sumIdxTHP = 2;
                sumIdxTDmg = 1;
                sumIdxTRange = 2;
                sumIdxTRate = 2;
                break;
            case "Builder Summoner":
                sumIdxTHP = 1;
                sumIdxTDmg = 2;
                sumIdxTRange = 2;
                sumIdxTRate = 2;
                break;

            case "AB1 Only (TB)":
                bFactorInResists = true;
                sumIdxHHP = 2;
                sumIdxHDmg = 2;
                sumIdxHRate = 2;
                sumIdxAb1 = 1;
                break;

            case "DPS AB1":
                bFactorInResists = true;
                sumIdxHHP = 2;
                sumIdxHDmg = 1;
                sumIdxHRate = 2;
                sumIdxAb1 = 1;
                break;
            case "DPS AB2":
                bFactorInResists = true;
                sumIdxHHP = 2;
                sumIdxHDmg = 1;
                sumIdxHRate = 2;
                sumIdxAb2 = 1;
                break;
            case "Pure DPS":
                bFactorInResists = true;
                sumIdxHHP = 2;
                sumIdxHDmg = 1;
                sumIdxHRate = 2;
                sumIdxAb1 = 2;
                sumIdxAb2 = 2;
                break;       
            case "Gunwitch":
                bFactorInResists = true;
                sumIdxHDmg = 1;
                sumIdxTDmg = 1;
                sumIdxTRate = 2;
                break;
            case "Guardian Summoner":
                bFactorInResists = true;
                sumIdxHHP = 1;
                sumIdxAb2 = 1;
                break;
        }
        QueueSaveUiState();
        RecalculateRatings();
    }

    private void TestForBestPiece(string type, string set, int rating, Dictionary<string, int> BestPieces)
    {
        if ( set == "Any" )
        {
            TestForBestPiece(type, "Chain", rating, BestPieces);
            TestForBestPiece(type, "Pristine", rating, BestPieces);
            TestForBestPiece(type, "Plate", rating, BestPieces);
            TestForBestPiece(type, "Mail", rating, BestPieces);
            TestForBestPiece(type, "Leather", rating, BestPieces);
            return;
        }

        string key = set + "_" + type;

        if (BestPieces.ContainsKey(key))
        {
            if (BestPieces[key] < rating)
                BestPieces[key] = rating;
        }
        else
            BestPieces[key] = rating;
    }

    public int BestArmorRating = 0;
    public string BestArmorType = "";

    private void RecalculateRatings()
    {
        Dictionary<string, int> BestPieces = new Dictionary<string, int>();

        for (int i = 0; i < _rows.Count; i++)
        {            
            var r = _rows[i];
            float mult = r.SetBonus;
            int maxR = r.ResistanceTarget;
            int maxStatLevel = r.MaxStat;
            (int rating, int sides) = Ratings.EvalRating(r, sumIdxHHP, sumIdxHDmg, sumIdxHSpd, sumIdxHRate, sumIdxAb1, sumIdxAb2, sumIdxTHP, sumIdxTDmg, sumIdxTRange, sumIdxTRate, bFactorInResists);


            if (!r.IsHidden && r.IsEligibleForBest)
            {
                TestForBestPiece(r.Type, r.Set, rating, BestPieces);                
            }

            _rows[i].Rating = rating;
            _rows[i].Sides = sides;
            _rows[i].IsSelected = false;
        }

        // find best armor set
        //-------------------------
        string[] Sets = { "Plate", "Pristine", "Leather", "Mail", "Chain" };
        int[] Scores = new int[5];
        foreach ( var v in BestPieces )
        {
            for (int i = 0; i < 5; i++)
            {
                if (v.Key.StartsWith(Sets[i]))
                {
                    Scores[i] += v.Value;
                }
            }            
        }

        string bestSet = Sets[0];
        int bestScore = Scores[0];
        for (int i = 1; i < 5; i++)
        {
            if (bestScore < Scores[i])
            {
                bestScore = Scores[i];
                bestSet = Sets[i];
            }
        }

        string NameString = "";

        for (int i = 0; i < _rows.Count; i++)
        {
            bool highlight = false;
            var r = _rows[i];
            if (r.IsHidden || !r.IsEligibleForBest) continue;
            if ((r.Set == bestSet) || (r.Set == "Any"))
            {
                string typeString = bestSet + "_" + r.Type;
                if ( BestPieces.ContainsKey(typeString))
                {
                    int rating = BestPieces[typeString];    
                    if (r.Rating == rating)
                    {
                        highlight = true;
                        BestPieces[typeString] = -99999;
                        NameString += r.Name + " ";
                    }
                }                                
            }

            _rows[i].IsSelected = highlight;
        }

        BestArmorRating = bestScore;
        BestArmorType = bestSet;
        //_summary = $"Best Armor Set: {bestSet} ({bestScore})";
        //-------------------------
        _sortDesc = true;
        _sortColumn = "";
        SortBy("Rating");
    }



    private void ChangeImportance( string column )
    {

        switch (column)
        {
            case nameof(ItemViewRow.HHP):     sumIdxHHP     = (sumIdxHHP + 1) % 3; break;
            case nameof(ItemViewRow.HDmg):    sumIdxHDmg    = (sumIdxHDmg + 1) % 3; break;
            case nameof(ItemViewRow.HSpd):    sumIdxHSpd    = (sumIdxHSpd + 1) % 3; break;
            case nameof(ItemViewRow.HRate):   sumIdxHRate   = (sumIdxHRate + 1) % 3; break;
            case nameof(ItemViewRow.Ab1):     sumIdxAb1     = (sumIdxAb1 + 1) % 3; break;
            case nameof(ItemViewRow.Ab2):     sumIdxAb2     = (sumIdxAb2 + 1) % 3; break;
            case nameof(ItemViewRow.THP):     sumIdxTHP     = (sumIdxTHP + 1) % 3; break;
            case nameof(ItemViewRow.TDmg):    sumIdxTDmg    = (sumIdxTDmg + 1) % 3; break;
            case nameof(ItemViewRow.TRange):  sumIdxTRange  = (sumIdxTRange + 1) % 3; break;
            case nameof(ItemViewRow.TRate):   sumIdxTRate   = (sumIdxTRate + 1) % 3; break;

            case nameof(ItemViewRow.RG):  bFactorInResists = !bFactorInResists; break;
            case nameof(ItemViewRow.RP):  bFactorInResists = !bFactorInResists; break;
            case nameof(ItemViewRow.RF):  bFactorInResists = !bFactorInResists; break;
            case nameof(ItemViewRow.RL):  bFactorInResists = !bFactorInResists; break;
        }
        RecalculateRatings();

    }

    private string GetImportanceImage( string column )
    {       
        int idx = column switch
        {
            nameof(ItemViewRow.HHP)     => sumIdxHHP,
            nameof(ItemViewRow.HDmg)    => sumIdxHDmg,
            nameof(ItemViewRow.HSpd)    => sumIdxHSpd,
            nameof(ItemViewRow.HRate)   => sumIdxHRate,
            nameof(ItemViewRow.Ab1)     => sumIdxAb1,
            nameof(ItemViewRow.Ab2)     => sumIdxAb2,
            nameof(ItemViewRow.THP)     => sumIdxTHP,
            nameof(ItemViewRow.TDmg)    => sumIdxTDmg,
            nameof(ItemViewRow.TRange)  => sumIdxTRange,
            nameof(ItemViewRow.TRate)   => sumIdxTRate,
            nameof(ItemViewRow.RG)      => bFactorInResists?1:0,
            nameof(ItemViewRow.RP)      => bFactorInResists?1:0,
            nameof(ItemViewRow.RF)      => bFactorInResists?1:0,
            nameof(ItemViewRow.RL)      => bFactorInResists?1:0,
            _ => 0
        };

        return idx switch
        {
            0 => "png/importance-none.png",
            1 => "png/importance-rating.png",
            2 => "png/importance-side.png",
            _ => ""
        };
    }

    private void SortBy(string column)
    {
        if (_sortColumn == column)
            _sortDesc = !_sortDesc;      // toggle
        else
        {
            _sortColumn = column;
            _sortDesc = true;            // default: desc like WPF “largest first”
        }

        ApplySort();
    }
    private static readonly StringComparer Ci = StringComparer.OrdinalIgnoreCase;

    private void ApplySort()
    {
        int dir = _sortDesc ? -1 : 1;

        int Cmp(int a, int b) => a.CompareTo(b);
        int CmpStr(string? a, string? b) => Ci.Compare(a ?? "", b ?? "");

        int Compare(ItemViewRow a, ItemViewRow b)
        {
            int loc = 0;
            if ( _sortColumn == nameof(ItemViewRow.Location))
            {
                loc = CmpStr(a.Location, b.Location); 
                if ( loc == 0) loc = Cmp(a.IndexInFolder, b.IndexInFolder);                
            } 

            int c = _sortColumn switch
            {
                nameof(ItemViewRow.Rating)   => Cmp(a.Rating, b.Rating),
                nameof(ItemViewRow.Value)    => Cmp(a.Value, b.Value),
                nameof(ItemViewRow.BestFor)  => CmpStr(a.BestFor, b.BestFor),
                nameof(ItemViewRow.Level)    => Cmp(a.Level, b.Level),
                nameof(ItemViewRow.MaxLevel) => Cmp(a.MaxLevel, b.MaxLevel),

                nameof(ItemViewRow.HHP)      => Cmp(a.HHP, b.HHP),
                nameof(ItemViewRow.HDmg)     => Cmp(a.HDmg, b.HDmg),
                nameof(ItemViewRow.HSpd)     => Cmp(a.HSpd, b.HSpd),
                nameof(ItemViewRow.HRate)    => Cmp(a.HRate, b.HRate),
                nameof(ItemViewRow.Ab1)      => Cmp(a.Ab1, b.Ab1),
                nameof(ItemViewRow.Ab2)      => Cmp(a.Ab2, b.Ab2),
                nameof(ItemViewRow.THP)      => Cmp(a.THP, b.THP),
                nameof(ItemViewRow.TDmg)     => Cmp(a.TDmg, b.TDmg),
                nameof(ItemViewRow.TRange)   => Cmp(a.TRange, b.TRange),
                nameof(ItemViewRow.TRate)    => Cmp(a.TRate, b.TRate),

                nameof(ItemViewRow.RG)       => Cmp(a.RG+a.RP+a.RF+a.RL, b.RG+b.RP+b.RF+b.RL),
                
                nameof(ItemViewRow.Name)     => CmpStr(a.Name, b.Name),
                nameof(ItemViewRow.Location) => loc,

                nameof(ItemViewRow.Type)     => CmpStr(a.Type, b.Type),
                nameof(ItemViewRow.Set )    => CmpStr(a.Set, b.Set),

                nameof(ItemViewRow.Quality)  => Cmp(QualityRank(a.Quality), QualityRank(b.Quality)),
                _ => Cmp(a.Rating, b.Rating),
            };

            // primary sort direction
            c *= dir;
            if (c != 0) return c;

            // tie-breakers (desc, like you were doing)
            c = b.Rating.CompareTo(a.Rating);
            if (c != 0) return c;
            c = b.Sides.CompareTo(a.Sides);
            if (c != 0) return c;
            return b.Name.CompareTo(a.Name);
        }

        _rows.Sort(Compare);
    }

    private static int QualityRank(string? q)
    {
        q = (q ?? "").Trim();


        return q switch
        {
            "Ult++" => 7,
            "Ult+" => 6, 
            "Ult93" => 5,
            "Ult90" => 4,
            "Supreme" => 3,
            "Transcendent" => 2,
            "Mythical" => 1,
            _ => 0
        };
    }

    private string GetRowClass(bool selected, bool h)
    {
        if (h) return "hidden-row";
        if (selected) return "selected";
        return "";
    }


    private static string QualityClass(string quality)
    {
        if (quality == "Ult++") return "cell-quality-ultplusplus";
        else if (quality == "Ult+") return "cell-quality-ultplus";
        else if (quality == "Ult93") return "cell-quality-ult93";
        else if (quality == "Ult90") return "cell-quality-ult90";
        else if (quality == "Supreme") return "cell-quality-supreme";
        else if (quality == "Transcendent") return "cell-quality-transcendent";
        else if (quality == "Mythical") return "cell-quality-mythical";
        else return "cell-quality-default";
    }
    const string UiStateKey = "ddgo.uiState.v1";

    CancellationTokenSource? _saveCts;

    void QueueSaveUiState()
    {
        _saveCts?.Cancel();
        _saveCts = new CancellationTokenSource();
        var token = _saveCts.Token;

        _ = DebouncedSaveAsync(token);
    }

    private async Task DebouncedSaveAsync(CancellationToken token)
    {
        try
        {
            await Task.Delay(500, token);

            // Make sure _ui reflects the latest UI fields
            SyncFieldsToUi();

            var json = JsonSerializer.Serialize(_ui);
            await InvokeAsync(() => JS.InvokeVoidAsync("appState.set", UiStateKey, json));
        }
        catch (OperationCanceledException) { }
        catch (Exception ex)
        {
            // Don’t swallow silently while debugging:
            Console.WriteLine("Save UI state failed: " + ex);
        }
    }
    protected override async Task OnInitializedAsync()
    {
        _dotNetRef = DotNetObjectReference.Create(this);
        // 1) UI state
        var json = await JS.InvokeAsync<string?>("appState.get", UiStateKey);
        if (!string.IsNullOrWhiteSpace(json))
        {
            try { _ui = MigrateAndNormalize(json) ?? DefaultState(); }
            catch { _ui = DefaultState(); }
        }
        else _ui = DefaultState();

        ApplyUiToFields();

        if (await JS.InvokeAsync<bool>("dropzone.supportsHandles"))
        {
            var ok = await JS.InvokeAsync<bool>("dropzone.tryLoadLastHandleAndRead", _dotNetRef); // returns true if it loaded bytes & called into .NET or returned bytes
            if (ok) return;
        }

        var oldFileName = await JS.InvokeAsync<string?>("dropzone.tryLoadCachedFilename"); // from IndexedDB
        var cachedList = await JS.InvokeAsync<int[]?>("dropzone.tryLoadCachedDunBytes");
        var cached = cachedList?.Select(i => (byte)i).ToArray();
        if (cached is { Length: > 0 })
            await LoadDunBytesAsync(oldFileName ??"", cached);
    }


    static UiState NormalizeV1(UiState s)   
    {
        return s with
        {
            SelectedTypes = s.SelectedTypes ?? new(),
            SelectedSets = s.SelectedSets ?? new(),
            SelectedOther = s.SelectedOther ?? new(),
            RatingMode = string.IsNullOrWhiteSpace(s.RatingMode)
                ? "Builder App"
                : s.RatingMode,
            Layout = string.IsNullOrWhiteSpace(s.Layout)
                ? "5x3"
                : s.Layout
        };
    }

    static UiState MigrateAndNormalize(string json)
    {
        UiState? state;

        try
        {
            state = JsonSerializer.Deserialize<UiState>(json);
        }
        catch
        {
            return DefaultState();
        }

        if (state is null)
            return DefaultState();

        return state.Version switch
        {
            1 => NormalizeV1(state),
            _ => DefaultState() // unknown future version
        };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        _dotNetRef = DotNetObjectReference.Create(this);

        if (firstRender)
        {
            await JS.InvokeVoidAsync("dropzone.init", _dropZoneId, _dotNetRef);
            await JS.InvokeVoidAsync("enableColumnResizing", _tableRef);
            var supports = await JS.InvokeAsync<bool>("dropzone.supportsHandles");
            _canLoadLast = supports && await JS.InvokeAsync<bool>("dropzone.hasLast");
            StateHasChanged();
            await JS.InvokeVoidAsync("atlasIcons.init", "png/HeroEquipment_Atlas.png"); // set your atlas path
            _atlasReady = true;
            StateHasChanged();
        }

        if (_needsAtlasRender && _showContent && _atlasReady )
        {
            _needsAtlasRender = false;
            await JS.InvokeVoidAsync("atlasIcons.renderAllCached");
        }   

    }

    public void Dispose()
    {
        _dotNetRef?.Dispose();
    }

    // Called by JS when user drags over / leaves to let us style the dropzone
    [JSInvokable]
    public void SetDragOver(bool isOver)
    {
        if (_isDragOver == isOver) return;
        _isDragOver = isOver;
        StateHasChanged();
    }


    public async Task LoadDunBytesAsync(string fileName, byte[] bytes)
    {
        _loadedFileName = fileName;
        _lastLoadedAt = DateTime.Now;
        _showOutOfDateHint = false; // set true later if you detect staleness
        _error = null;
        _isLoading = true;
        _status = $"Reading {fileName}…";
        await db.LoadFromDun(bytes);
        if (!db.IsReady)
        {
            _error = db.Status;               
        }
        else
        {
            _status = db.Status;
            _rows.Clear();
            Ratings.ClearBestRatings();
            for (int i =0; i < db.Items.Count; i++)
            {
                ItemViewRow itemViewRow = db.Items[i].ToItemViewRow();
                _rows.Add(itemViewRow);

                (int value, itemViewRow.BestFor) = Ratings.GetBestValue(true, itemViewRow);

                // don't override set event values
                if ( itemViewRow.Value == 0)
                    itemViewRow.Value = value;
            }

            // now go through and get relative value
            foreach( var v in _rows )
            {
                // only override if we don't have a value yet
                if (v.Value == 0)
                {
                    // calculate relative rating for value (goes from -1000 to 0)
                    (v.Value, v.BestFor) = Ratings.GetBestValue(false, v);
                }
            }

            // Event collection counts + overlay data (unique names in guide, plus your owned counts)
            RebuildEventCollection();

            CalculateVanityTotals();
            SetPriceStatus("Prices estimated by table", true);
            // don't care about when it gets back              

            ApplyChipFilters();


            _showContent = true;
            _needsAtlasRender = true;
            await InvokeAsync(StateHasChanged);
        }
    }

    // Called by JS after it reads the dropped file as base64
    [JSInvokable]
    public async Task OnFileDropped(string fileName, byte[] bytes)
    {
        
        StateHasChanged();

        try
        {
            _status = $"Parsing {fileName} ({bytes.Length:N0} bytes)";
            StateHasChanged();
            await LoadDunBytesAsync(fileName, bytes);
        }
        catch (Exception ex)
        {
            _showContent = false;            
            _error = $"Error: {ex.Message} {db.Status}";
            _isLoading = false;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private string SortGlyph(string col)
    {
        if (_sortColumn != col) return "";
        return _sortDesc ? "▼" : "▲";
    }

    private void OnButtonClicked()
    {
        // Example: you’ll replace with your own action
        _status = $"Button clicked at {DateTime.Now:T}";

    }

    public int ArmorTotalValue = 0;
    public int EventTotalValue = 0;

    public void CalculateVanityTotals()
    {
        int at = 0;
        int et = 0;
        foreach  (var v in _rows)
        {
            if ( v.IsArmor && !v.IsEvent && v.Value > 0)
                at += v.Value;
            if ( v.IsEvent && v.Value > 0)
                et += v.Value;
        }
        ArmorTotalValue = at;
        EventTotalValue = et;
    }


    public string GetFunHash(ItemViewRow ivr)
    {
        return ivr.FunHashString;
    }

    private void GetLivePrices()
    {
        _ = Ratings.AsyncShiroPriceAPICall(this);        
    }
    private async Task LoadLastFile()
    {
        _error = null;
        _status = "";
        _status2 = "";

        // Only returns true in Chrome/Edge *and* if a handle was saved before.
        bool ok = await JS.InvokeAsync<bool>("dropzone.loadLast", _dotNetRef);

        if (!ok)
        {
            _status = "No remembered file yet (or the browser blocked access). Drop the file once, or use the Open button.";
            StateHasChanged();
        }
    }
    private async Task OpenFileDialog()
    {
        _error = null;
        _status = "";
        _status2 = "";
        StateHasChanged();

        // Opens file picker, reads bytes in JS, then calls OnFileDropped(fileName, bytes)
        bool ok = await JS.InvokeAsync<bool>("dropzone.pickFile", _dotNetRef);

        if (!ok)
        {
            _status = "No file selected.";
            StateHasChanged();
        }
    }
}
