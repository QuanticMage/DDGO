@page "/"
@implements IAsyncDisposable
@using Microsoft.JSInterop
@using System.Text.Json
@using System.Text.RegularExpressions

<div class="top-pane">
    <div class="left-pane">
        <h1 >Dungeon Defenders Gear Optimizer</h1>        
        <div class="build"><i>Jan 30 2026 - Version 1.5b</i></div>    
        <div id="@_dropZoneId" class="dropzone dz2 @( _isDragOver ? "over" : "" )">

            @* ============== EMPTY FILE TILE, BEFORE WE'VE LOADED ============== *@            
            @if (!_showContent)
            {
                <div class="dz2-card">

                    <div class="dz2-sub">
                        Select your data file to get started.
                    </div>

                    <div class="dz2-drop">
                        <div class="dz2-drop-inner">
                            <div class="dz2-drop-icon" aria-hidden="true">📁</div>
                            <div class="dz2-drop-text">Drag &amp; Drop File Here</div>
                            <div class="dz2-drop-hint">
                                Drag your <b>DunDefHeroes.dun</b> file into this box
                            </div>
                        </div>
                    </div>

                    <div class="dz2-or">
                        <span class="dz2-or-line"></span>
                        <span class="dz2-or-text">Or</span>
                        <span class="dz2-or-line"></span>
                    </div>

                    <button type="button" class="dz2-btn dz2-btn-primary" @onclick="OpenFileDialog">
                        <span class="dz2-btn-icon" aria-hidden="true">📁</span>
                        <span>Browse for file…</span>
                    </button>

                    <button type="button"
                            class="dz2-help"
                            aria-expanded="@(!_hideDropzoneHelp)"
                            @onclick="TogglePrepHelp">
                        <span class="dz2-help-caret" aria-hidden="true">@(_hideDropzoneHelp ? "▸" : "▾")</span>
                        <span>How do I find or prepare the file?</span>
                    </button>

                    <div class="dz2-help-body @( _hideDropzoneHelp ? "hidden" : "" )">
                        <ul>
                            <li>Run Dungeon Defenders, log into Ranked, then click Export to Open</li>
                            <li>Go to Dungeon Defenders in your Steam library, right-click, Manage &gt; Browse Local Files</li>
                            <li>Then open the Binaries\Win32 or Win64 folder (whichever you run), and drag <b>DunDefHeroes.dun</b> here.</li>
                            <li>This runs locally. Only aggregate armor ratings are sent to Shiro’s API for live prices, and only if you enable live prices.</li>
                        </ul>

                        @if (_canLoadLast)
                        {
                            <div class="dz2-actions">
                                <button type="button" class="dz2-btn dz2-btn-dark" @onclick="LoadLastFile">
                                    <span class="dz2-btn-icon" aria-hidden="true">⟳</span>
                                    <span>Reload last file from disk (Chrome/Edge)</span>
                                </button>
                            </div>
                        }
                    </div>
                </div>
            }
            else  @* ============== LOADED FILE TILE ============== *@          
            {
                <div class="dz2-card-loaded">
                    <div class="dz2-filename">@_loadedFileName</div>                                                                    
                    @* status *@
                    @if (_isLoading)
                    {
                        <div class="status">Loading… @_status</div>
                    }
                    else if (!string.IsNullOrEmpty(_error))
                    {
                        <div class="status error">@_error</div>
                    }
                    else if (!string.IsNullOrEmpty(_status))
                    {
                        <div class="status">@_status</div>
                        @_status2
                    }                                          
                    <div class="dz2-actions">
                        @if (_canLoadLast)
                        {
                            <button type="button" class="dz2-btn dz2-btn-ghost" @onclick="LoadLastFile">
                                <span class="dz2-btn-icon" aria-hidden="true">⟳</span>
                                <span>Reload</span>
                            </button>
                        }

                        <button type="button" class="dz2-btn dz2-btn-ghost" @onclick="OpenFileDialog">
                            <span>Load new</span>
                        </button>
                    </div>
                </div>
            }       
        </div>
    </div>

     @* ============== CREDITS AND LINK PANE ============== *@     
    <aside class="info-pane">
        <div class="credits">            
            <div class="credits-by">Created by <i>Mage (&#64;entangledmage)</i></div>
            <div class="credits-thanks">Based on item DB by <i>Tbolt</i>, using price estimates by <i>Shiro and Sesar</i></div>            
            <div class="credits-thanks">Special Thanks to <i>Cerium, Chiku, Favon, Scryllix, Shiro, Sesar, SteveTrevor, Tbolt, and Thales</i></div>            
        </div>

    <h3 class="links-title">Quick Links</h3>
    <ul class="link-list">
        <li><a href="https://dungeondefenders.wiki.gg" rel="noopener">Dungeon Defender's Wiki</a></li>
        <li><a href="https://steamcommunity.com/sharedfiles/filedetails/?id=2968079729" rel="noopener">Chiku’s Guide</a></li>
        <li><a href="https://docs.google.com/spreadsheets/d/11v0h3LLUDYEkTxvkLVWUzYv8wXvjZ1cPTJJ-o1QqVDM/edit?gid=1598543540#gid=1598543540" rel="noopener">Best-in-Slot Doc</a></li>
        <li><a href="https://www.dundefplanner.com" target="_blank" rel="noopener">DunDefPlanner for sharing layouts</a></li>           
        <li><a href="https://docs.google.com/spreadsheets/d/1XzYuWB4I9RoNe8x-DD2M1koWs72tW8sTgyQ_n-d7l-E/edit?pli=1&gid=2059687993#gid=2059687993" rel="noopener">Event price sheet</a></li>
    </ul>    
    </aside>
</div>

@if (@_showContent)
{
<div class="middle-pane">    
    <div class="middle-left">
       <CharacterPanel @ref="_characterPanel"
            
            OnEquipFromFile="HandleEquipFromFile"
            OnEquipBest="HandleEquipBest"
            OnEquipClear="HandleEquipClear"
            OnClickEquipment="HandleEquipmentClick"
            OnChangedRatingMode="HandleChangedRatingMode"
            OnChangedHero="HandleChangedHero"/>
    </div>

    <div class="middle-right">    
    <div class="utility-row">
        <span class="utility-label"><font face="Arial">⚙️</font></span>

        <label class="utility-toggle">
            <input type="checkbox"
                   class="tool-filter"
                   checked="@_censor"
                   @onchange="@((e) => { _censor = (bool)e.Value!; QueueSaveUiState(); StateHasChanged(); })" />
            <span>Censor Ult++</span>
        </label>
    
        <label class="utility-toggle">
            <input type="checkbox"
                   class="tool-filter"
                   checked="@_livePrices"
                   @onchange="@((e) => { _livePrices = e.Value is bool b && b; QueueSaveUiState(); if (_livePrices) GetLivePrices(); })" />
            <span>Get Live Prices</span>
        </label>

        <label class="utility-select">
            <span>Itembox size</span>
            <select value="@_itemboxSize" @onchange="OnItemboxSizeChanged" font="inherit">
                <option value="5x3">5x3</option>
                <option value="4x3">4x3</option>
                <option value="6x4">6x4</option>
            </select>
        </label>

        <label class="utility-toggle">
            <input type="checkbox"
                class="tool-filter"
                checked="@_showUpgradedStats"
                @onchange="@((e) => { _showUpgradedStats= e.Value is bool b && b; QueueSaveUiState(); StateHasChanged(); })" />
            <span>Fully upgrade items</span>
        </label>
        <label class="utility-toggle">
            <input type="checkbox"
                    class="tool-filter"
                    checked="@_assumeSetBonuses"
                    @onchange="@((e) => { _assumeSetBonuses = e.Value is bool b && b; QueueSaveUiState(); StateHasChanged(); })" />
            <span>Assume set bonuses</span>
        </label>
    </div>
    <br/>
    
    <div class="filters-menu-header">
        Filters
    </div>
    <div class="filters-column">
        <FilterChips Title="Type" Theme="type"
                     Options="_typeOptions"
                     Placeholder="Any"
                     ShowNoneAll="true"
                     MenuMaxHeightPx="520"
                     @bind-Selected="SelectedTypes"
                     Presets="@(new[]
                     {
                         new FilterChips.Preset("Armor", new [] { "Helmet", "Gauntlet", "Boots", "Torso"}),       
                     })"  />       

        <FilterChips Title="Set" Theme="set"
                     Options="_setOptions"
                     Placeholder="Any"
                     ShowNoneAll="true"
                     MenuMaxHeightPx="520"
                     @bind-Selected="SelectedSets"    
                     Presets="@(new[]
                     {
                         new FilterChips.Preset("Armor", new [] { "Pristine", "Plate", "Chain", "Mail", "Leather", "Zamira"}),       
                         new FilterChips.Preset("Weapons", new [] { "Squire", "Apprentice", "Monk", "Huntress"}),       
                     })"  />       

        <FilterChips Title="Other" Theme="other"
                        Options="_otherOptions"
                        Placeholder="None"
                        @bind-Selected="SelectedOther" />
            <div class="filter-search-row">
                <div class="filter-search-label">
                    Custom
                </div>

                <div class="filter-search-control">
            
                    <SearchBar ValueChanged="ApplySearch"/>
                    <button type="button"
                            class="help-icon"
                            aria-label="Search help"
                            data-tooltip="@SearchHelp">
                    ?
                    </button>
                </div>
            </div>
    </div>


    @code {
        private List<string> _selectedTypes = new();
        private List<string> _selectedSets = new();
        private List<string> _selectedOther = new();

        // Bind targets 
        private List<string> SelectedTypes
        {
            get => _selectedTypes;
            set
            {
                _selectedTypes = value ?? new();
                ApplyChipFilters();
            }
        }

        private List<string> SelectedSets
        {
            get => _selectedSets;
            set
            {
                _selectedSets = value ?? new();
                ApplyChipFilters();
            }
        }

        private List<string> SelectedOther
        {
            get => _selectedOther;
            set
            {
                _selectedOther = value ?? new();
                ApplyChipFilters();
            }
        }    



        private readonly List<FilterChips.Option> _typeOptions = new()
        {

            new("Helmet"),
            new("Gauntlet"),
            new("Torso"),
            new("Boots"),
            new("Brooch"),
            new("Mask"),
            new("Bracers"),
            new("Shield"),        
            new("Pets"),
            new("Weapons"),      
            new("Currency"),             
        };

        private readonly List<FilterChips.Option> _setOptions = new()
        {
            new("Pristine"),
            new("Plate"),
            new("Chain"),
            new("Mail"),
            new("Leather"),      
            new("Zamira"),      
            new("Squire"),
            new("Apprentice"),
            new("Monk"),
            new("Huntress"),        
        };

        private readonly List<FilterChips.Option> _otherOptions = new()
        {
        
            new("Only Events",    MutexGroup: "eventMode"),
            new("Exclude Events", MutexGroup: "eventMode"),

            new("Exclude Other Characters Equipment"),

            new("Exclude Missing Resists"),
        };
    }

    <div class="summary">@_summary</div> 
    <div class="stats-row">
      <div class="metric-card highlighted-card">
        <span class="metric-label">Equipped Armor Rating</span>
        <div class="metric-main">
          <span class="metric-number">@EquippedArmorRating</span>
          <span class="metric-type  highlighted-card-type">@EquippedArmorSet</span>
        </div>
      </div>

      <div class="metric-card">
        <span class="metric-label">Vanity Account Armor Total</span>    
        <div class="metric-main">
          <span class="metric-number">@ArmorTotalValue</span>
          <span class="metric-type">CV</span>
        </div>
      </div>

      <div class="metric-card">
        <span class="metric-label">Vanity Account Event Total</span>
         <div class="metric-main">
          <span class="metric-number">@EventTotalValue</span>
          <span class="metric-type">CV</span>

          <button type="button" class="metric-mini-pill" @onclick="ShowEventCollection">
           @CollectedEventCount / @TotalEventCount
          </button>
        </div>

      </div>
    </div>

    @if (_showEventCollection)
    {
        <div class="event-overlay-backdrop" @onclick="CloseEventCollection" role="presentation">
            <div class="event-overlay-panel" role="dialog" aria-modal="true" aria-label="Event collection" @onclick:stopPropagation="true">
                <div class="event-overlay-header">
                    <div class="event-overlay-titlewrap">
                        <div class="event-overlay-title">Event Collection</div>
                        <div class="event-overlay-sub">@CollectedEventCount / @TotalEventCount collected</div>
                    </div>
                    <button type="button" class="event-overlay-export" title="Export" @onclick="ExportEventCollection">Copy To Clipboard</button>
                    <button type="button" class="event-overlay-close" title="Close" @onclick="CloseEventCollection">×</button>
                </div>

                <div class="event-overlay-tools">
                    <input class="event-search"
                           placeholder="Search categories…"
                           @onchange="OnEventSearchChanged" />
                </div>

                <div class="event-overlay-body">
                    @foreach (var group in VisibleEventCollection
                        .GroupBy(x => x.Category)
                        .OrderBy(g => GetCategoryOrderKey(g.Key))
                        .ThenBy(g => g.Key, StringComparer.OrdinalIgnoreCase))
                    {                    
                        var cat = SplitCategory(group.Key);
                        <div class="event-cat">
                            <div class="event-cat-hdr">
                                <span class="event-cat-page">@cat.Page</span>
                                <span class="event-cat-sep">›</span>
                                <span class="event-cat-section">@cat.Section</span>
                            </div>

                            <div class="event-list">
                                @foreach (var item in group
                                    .OrderByDescending(x => x.Price)
                                    .ThenBy(x => x.Name, StringComparer.OrdinalIgnoreCase)
                                )
                                {
                                    <div class="event-row @(item.OwnedCount > 0 ? "owned" : "missing")">
                                        <div class="event-line">
                                            <div class="event-name">@item.Name</div>
                                            <div class="event-price">@(item.Price!=0?@item.Price:"Unknown") CVx</div>
                                            <span class="event-owned-badge" title="How many of this item you have">@item.OwnedCount</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
    </div> 
    
    </div> @* Middle pane *@
    <div class="bottom-pane">    

    @if (_rows.Count == 0)
    {  
    }
    else
    {   
    <div class="grid-wrap" @ref="_scrollRef" style="--overlay-height:@($"{_overlayHeightPx}px")">
       <div class="overlay-layer" aria-hidden="true">
        @if (_characterPanel is not null)
        {
           @foreach (var e in _characterPanel.EquippedItems)
           {
                <div class="row-highlight" @key=@($"{e.Key}")
                    style="transform: translateY(@($"{e.Value.CachedY}px")); height: @($"{e.Value.CachedHeight}px"); opacity: 1;">
                </div>         
           }
        }
        </div>
        <table class="grid" @ref="_tableRef">
            <colgroup>
                <col style="width:80px" />   @* Rating *@
                <col style="width:75px" />   @* Value *@
                <col style="width:65px" />   @* BestFor *@
                <col style="width:70px" />   @* Type *@
                <col style="width:70px" />   @* Position *@

                <col style="width:15%" />    @* Name (2*) *@
                <col style="width:10%" />    @* Location (2*) *@
                <col style="width:80px" />   @* Quality *@
            
                <col style="width:55px" />   @* Lvl *@
                <col style="width:55px" />   @* MaxLvl *@

                <col style="width:60px" />   @* HHP *@
                <col style="width:60px" />   @* HDmg *@
                <col style="width:60px" />   @* HSpd *@
                <col style="width:60px" />   @* HRate *@
                <col style="width:60px" />   @* Ab1 *@
                <col style="width:60px" />   @* Ab2 *@
                <col style="width:60px" />   @* THP *@
                <col style="width:60px" />   @* TDmg *@
                <col style="width:60px" />   @* TRange *@
                <col style="width:60px" />   @* TRate *@

                <col style="width:60px" />   @* RG *@
            </colgroup>
  
            <thead>
                <tr class="rating-row">                
                    <th colspan="10">       
                
                        <span class="hint-text">
                            <span class="hint-left">
                                @VisibleCount / @TotalCount items visible
                            </span>

                            <span class="hint-right">
                                Click names to sort, or stars to adjust the rating calculation →
                            </span>
                        </span>
                    </th>
                    <th class="importance-cell">
                        <div class="th-center">
                        <button type="button" 
                                @onclick="() => ChangeImportance(DDStat.HeroHealth)">
                            <img src="@GetImportanceImage(DDStat.HeroHealth)" />
                        </button>
                        </div>
                    </th>

                        <th class="importance-cell">
                        <div class="th-center">
                       <button type="button" 
                                @onclick="() => ChangeImportance(DDStat.HeroDamage)">
                                <img src="@GetImportanceImage(DDStat.HeroDamage)" />
                        </button>
                        </div>
                    </th>
                         <th class="importance-cell">
                        <div class="th-center">
                   <button type="button" 
                                @onclick="() => ChangeImportance(DDStat.HeroSpeed)">
                                <img  src="@GetImportanceImage(DDStat.HeroSpeed)" />
                        </button>
                         </div>
                    </th>

                    <th class="importance-cell">
                        <div class="th-center">
                            <button type="button" 
                                @onclick="() => ChangeImportance(DDStat.HeroCastRate)">
                                <img  src="@GetImportanceImage(DDStat.HeroCastRate)" />
                            </button>
                        </div>                    
                    </th>

                    <th class="importance-cell">
                        <div class="th-center">
                        <button type="button" 
                                @onclick="() => ChangeImportance(DDStat.HeroAbility1)">
                                <img  src="@GetImportanceImage(DDStat.HeroAbility1)" />
                        </button>
                        </div>
                    </th>

                    <th class="importance-cell">
                        <div class="th-center">
                        <button type="button" 
                                @onclick="() => ChangeImportance(DDStat.HeroAbility2)">
                                <img  src="@GetImportanceImage(DDStat.HeroAbility2)" />
                        </button>
                        </div>
                    </th>

                    <th class="importance-cell">
                        <div class="th-center">
                        <button type="button" 
                                @onclick="() => ChangeImportance(DDStat.TowerHealth)">
                                <img  src="@GetImportanceImage(DDStat.TowerHealth)" />
                        </button>
                        </div>
                    </th>

                    <th class="importance-cell">
                        <div class="th-center">
                        <button type="button" 
                                @onclick="() => ChangeImportance(DDStat.TowerDamage)">
                                <img  src="@GetImportanceImage(DDStat.TowerDamage)" />
                        </button>
                        </div>
                    </th>

                    <th class="importance-cell">
                        <div class="th-center">
                        <button type="button" 
                                @onclick="() => ChangeImportance(DDStat.TowerRange)">
                                <img  src="@GetImportanceImage(DDStat.TowerRange)" />
                        </button>
                        </div>
                    </th>

                    <th class="importance-cell">
                        <div class="th-center">
                        <button type="button" 
                                @onclick="() => ChangeImportance(DDStat.TowerRate)">
                                <img  src="@GetImportanceImage(DDStat.TowerRate)" />
                        </button>
                        </div>

                    </th>

                    <!-- Resists (all toggle the same flag, but still distinct columns) -->

                    <th class="importance-cell">
                        <div class="th-center">
                        <button type="button"
                                @onclick="() => ChangeImportance(DDStat.HeroResistance)">
                                <img  src="@GetImportanceImage(DDStat.HeroResistance)" />
                        </button>
                        </div>
                    </th>

                </tr>
                <tr class="header-row" >
                    <th class="sortable" data-tooltip=@Tips["Rating"]>
                        <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.Rating))">
                            Rating <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Rating))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable" data-tooltip=@Tips["Value"]>
                        <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.Value))">
                             Est. Value* <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Value))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>
                
                    <th class="sortable">
                        <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.BestFor))">
                             Best For<span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.BestFor))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable">
                        <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.Type))">
                            Type <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Type))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable">
                        <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.Set))">
                            Set <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Set))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>
                    <th class="sortable">
                        <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.Name))">
                            Name <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Name))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable"  data-tooltip="@Tips["Location"]">
                        <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.Location))">
                            Location <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Location))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable">
                        <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.Quality))">
                            Quality <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Quality))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>


                    <th class="sortable">
                        <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.Level))">
                            Lvl <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.Level))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable">
                        <button type="button" class="th-btn" @onclick="() => SortBy(nameof(ItemViewRow.MaxLevel))">
                            MaxLvl <span class="sort-glyph">@SortGlyph(nameof(ItemViewRow.MaxLevel))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable icon-header @HeaderShadingStyle(DDStat.HeroHealth)">
                        <button type="button" class="th-btn th-icon" title="Hero Health" @onclick="() => SortBy(nameof(DDStat.HeroHealth))">
                            <img src="png/Hero Health.png" alt="HHP" />
                            <span class="hdr-text">Hero<br />Health</span>
                            <span class="sort-glyph">@SortGlyph(nameof(DDStat.HeroHealth))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable icon-header @HeaderShadingStyle(DDStat.HeroDamage)">
                        <button type="button" class="th-btn th-icon" title="Hero Damage" @onclick="() => SortBy(nameof(DDStat.HeroDamage))">
                            <img src="png/Hero Damage.png" alt="HDmg" />
                            <span class="hdr-text">Hero<br />Damage</span>
                            <span class="sort-glyph">@SortGlyph(nameof(DDStat.HeroDamage))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable icon-header @HeaderShadingStyle(DDStat.HeroSpeed)">
                        <button type="button" class="th-btn th-icon" title="Hero Speed" @onclick="() => SortBy(nameof(DDStat.HeroSpeed))">
                            <img src="png/Move Speed.png" alt="HSpd" />
                            <span class="hdr-text">Hero<br />Speed</span>
                            <span class="sort-glyph">@SortGlyph(nameof(DDStat.HeroSpeed))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable icon-header @HeaderShadingStyle(DDStat.HeroCastRate)">
                        <button type="button" class="th-btn th-icon" title="Hero Casting Rate" @onclick="() => SortBy(nameof(DDStat.HeroCastRate))">
                            <img src="png/Cast Rate.png" alt="HRate" />
                            <span class="hdr-text">Hero<br />Cast Rate</span>
                            <span class="sort-glyph">@SortGlyph(nameof(DDStat.HeroCastRate))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable icon-header @HeaderShadingStyle(DDStat.HeroAbility1)">
                        <button type="button" class="th-btn th-icon" title="Ability 1" @onclick="() => SortBy(nameof(DDStat.HeroAbility1))">
                            <img src="png/AB1/Monk AB1.png" alt="Ab1" />
                            <span class="hdr-text">Hero<br />Ability 1</span>
                            <span class="sort-glyph">@SortGlyph(nameof(DDStat.HeroAbility1))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable icon-header @HeaderShadingStyle(DDStat.HeroAbility2)">
                        <button type="button" class="th-btn th-icon" title="Ability 2" @onclick="() => SortBy(nameof(DDStat.HeroAbility2))">
                            <img src="png/AB2/Hero Boost Monk AB2.png" alt="Ab2" />
                            <span class="hdr-text">Hero<br />Ability 2</span>
                            <span class="sort-glyph">@SortGlyph(nameof(DDStat.HeroAbility2))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable icon-header @HeaderShadingStyle(DDStat.TowerHealth)">
                        <button type="button" class="th-btn th-icon" title="Tower Health" @onclick="() => SortBy(nameof(DDStat.TowerHealth))">
                            <img src="png/Tower Health.png" alt="THP" />
                            <span class="hdr-text">Tower<br /> Health</span>
                            <span class="sort-glyph">@SortGlyph(nameof(DDStat.TowerHealth))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable icon-header  @HeaderShadingStyle(DDStat.TowerDamage)">
                        <button type="button" class="th-btn th-icon" title="Tower Damage" @onclick="() => SortBy(nameof(DDStat.TowerDamage))">
                            <img src="png/Tower Damage.png" alt="TDmg" />
                            <span class="hdr-text">Tower<br />Damage</span>
                            <span class="sort-glyph">@SortGlyph(nameof(DDStat.TowerDamage))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable icon-header  @HeaderShadingStyle(DDStat.TowerRange)">
                        <button type="button" class="th-btn th-icon" title="Tower Range" @onclick="() => SortBy(nameof(DDStat.TowerRange))">
                            <img src="png/Tower Range.png" alt="TRng" />
                            <span class="hdr-text">Tower<br />Range</span>
                            <span class="sort-glyph">@SortGlyph(nameof(DDStat.TowerRange))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable icon-header @HeaderShadingStyle(DDStat.TowerRate)">
                        <button type="button" class="th-btn th-icon" title="Tower Rate" @onclick="() => SortBy(nameof(DDStat.TowerRate))">
                            <img src="png/Tower Rate.png" alt="TRate" />
                            <span class="hdr-text">Tower<br />Rate</span>
                            <span class="sort-glyph">@SortGlyph(nameof(DDStat.TowerRate))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>

                    <th class="sortable icon-header @HeaderShadingStyle(DDStat.HeroResistance)">
                        <button type="button" class="th-btn th-icon" title="Generic Resist" @onclick="() => SortBy(nameof(DDStat.HeroResistance))">
                            <img src="png/all_resistances.png" alt="Res" />
                            <span class="hdr-text">Average Resistance</span>
                            <span class="sort-glyph">@SortGlyph(nameof(DDStat.HeroResistance))</span>
                        </button>
                        <div class="col-resizer"></div>
                    </th>            
                </tr>
            </thead>


            <tbody>
                @foreach (var r in _rows)
                {
                    <tr @key="@r.Idx" data-key="@r.Idx" class="data-row @GetRowClass(r.IsHidden)" @onclick="()=>OnRowClicked(r)">
                        <td class="cell-rating">
                            <span class="rating-primary">@r.Rating</span>
                            <span class="rating-sides">@r.Sides</span>
                        </td>
                        <td>
                            @{
                                var (text, icon, tooltip) = GetValueDisplay(r);
                                bool hasText = !string.IsNullOrWhiteSpace(text);
                                bool hasIcon = !string.IsNullOrWhiteSpace(icon);
                            }
                            <span class="value-icon @(hasText? "" : "value-icon-only")" data-tooltip="@tooltip">
                                @if (hasIcon)
                                {
                                    <img class="icon" src="@icon"/>
                                }
                                @if (hasText)
                                {
                                    <span class="label">@text</span>
                                }
                            </span>
                        </td>
                        <td class="text bestfor">@r.BestFor</td>
                        <td class="text cell-type">@r.Type</td>
                        <td class="text cell-type">@r.Set</td>
                        <td class="text cell-name" h-tooltip="@GetFunHash(r)">
                            <span class="name-row">
                                    <img class="atlas-icon"
                                        alt=""
                                        width="32" height="32"
                                        data-size="64"
                                        data-l1x="@r.IconX" data-l1y="@r.IconY"
                                        data-l2x="@r.IconX1" data-l2y="@r.IconY1" data-l2t="@r.Color1"
                                        data-l3x="@r.IconX2" data-l3y="@r.IconY2" data-l3t="@r.Color2" />
                                    <span class="name-name">
                                    @r.Name 
                                </span>
                                @{
                                    bool IsBlack(string? c)
                                    {
                                        if (string.IsNullOrWhiteSpace(c)) return true; // treat empty as "no color"
                                        var s = c.Trim().ToLowerInvariant();
                                        return s == "#000" || s == "#000000" ||
                                               s == "rgb(0,0,0)" || s == "rgb(0, 0, 0)" ||
                                               s == "rgba(0,0,0,1)" || s == "rgba(0, 0, 0, 1)";
                                    }

                                    var show = !IsBlack(r.Color1) || !IsBlack(r.Color2);
                                }

                                @if (show)
                                {
                                    <span class="name-colors">
                                        <ColorSwatches Name="" Color1="@r.Color1" Color2="@r.Color2" />
                                    </span>
                                }                      
                            </span> 
                        </td>
                        <td class="text location">@GetLocation(r)</td>
                        <td class="text @QualityClass(r.Quality)">@r.Quality</td>
                
                        <td class="num">@r.Level</td>
                        <td class="num">@r.MaxLevel</td>

                        <td class="num cell-health @CellShadingStyle(DDStat.HeroHealth)">@GetValue(DDStat.HeroHealth, r)</td>
                        <td class="num cell-damage @CellShadingStyle(DDStat.HeroDamage)">@GetValue(DDStat.HeroDamage, r)</td>
                        <td class="num cell-range @CellShadingStyle(DDStat.HeroSpeed)">@GetValue(DDStat.HeroSpeed, r)</td>
                        <td class="num cell-rate @CellShadingStyle(DDStat.HeroCastRate)">@GetValue(DDStat.HeroCastRate, r)</td>
                        <td class="num cell-ab1 @CellShadingStyle(DDStat.HeroAbility1)">@GetValue(DDStat.HeroAbility1, r)</td>
                        <td class="num cell-ab2 @CellShadingStyle(DDStat.HeroAbility2)">@GetValue(DDStat.HeroAbility2, r)</td>
                        <td class="num cell-health @CellShadingStyle(DDStat.TowerHealth)">@GetValue(DDStat.TowerHealth, r)</td>
                        <td class="num cell-damage @CellShadingStyle(DDStat.TowerDamage)">@GetValue(DDStat.TowerDamage, r)</td>
                        <td class="num cell-range @CellShadingStyle(DDStat.TowerRange)">@GetValue(DDStat.TowerRange, r)</td>
                        <td class="num cell-rate @CellShadingStyle(DDStat.TowerRate)">@GetValue(DDStat.TowerRate, r)</td>

                        <td class="resist @CellShadingStyle(DDStat.HeroResistance)" 
                            data-tooltip=@(
                              $"<div class='resist-container'>" +
                                $"<img class='resist-icon' src='png/Generic Resistance.png' alt='G' /><span class='resist-val'>{r.Resists[0]}</span>" +
                                $"<img class='resist-icon' src='png/Poison Resistance.png'  class='resist-icon' alt='P' /><span class='resist-val'>{r.Resists[1]}</span>" +
                                $"<img class='resist-icon' src='png/Fire Resistance.png'    class='resist-icon' alt='F' /><span class='resist-val'>{r.Resists[2]}</span>" +
                                $"<img class='resist-icon' src='png/Lightning Resistance.png' class='resist-icon' alt='L' /><span class='resist-val'>{r.Resists[3]}</span>" +
                                $"</div><br>{ShowUpgradesToMaxResist(r)}")>
                            @(GetResistValue(r))
                    </td>
                </tr>
                }
            </tbody>
        </table>
        </div>        
    }        
    </div>
}

@code {
    [Inject] private IJSRuntime JS { get; set; } = default!;

    private int CurrentUIOptionsVersion = 1;
    private readonly string _dropZoneId = "dropzone";
    private DotNetObjectReference<Index>? _dotNetRef;
    private bool _needsAtlasRender;
    private bool _isDragOver;
    private bool _isLoading;
    private bool _hideDropzoneHelp;
    private bool _atlasReady;
    private string _summary = "";
    private string _status = "";
    private string _status2 = "";
    private bool _showLivePrices = true;
    private string? _error;
    private DDDatabase db = new();
    private List<ItemViewRow> _rows = new();
    private record ModeOption(string Value, string Label);
    private string _sortColumn = nameof(ItemViewRow.Rating);
    private bool _sortDesc = true;
    private bool _censor = true;    
    private bool _livePrices = false;
    private string _itemboxSize = "5x3";
    private bool _showContent = false;
    private bool _canLoadLast = false;
    private ElementReference _tableRef;
    private string? _loadedFileName;
    private DateTime? _lastLoadedAt;
    private UiState _ui = DefaultState();
    private string _searchText = "";
    private int CollectedEventCount = 0;
    private int TotalEventCount = 0;
    private CharacterPanel? _characterPanel;    
    private bool _showEventCollection = false;
    private bool _showUpgradedStats = false;
    private bool _assumeSetBonuses = false;
    private string _eventSearch = "";
    private double _overlayHeightPx = 0;
    private ElementReference _scrollRef;
    private bool _overlayObserversStarted;


    // Current sorting criteria
    private bool _bRequireResists = false;    
    private List<DDStat> _RatingStatsPriority = new();
    private List<DDStat> _SidesStatsPriority = new();


    // ======= selection ==========    
    public sealed class OverlayMeasure
    {
        public double overlayHeight { get; set; }
        public List<RowMeasure> rows { get; set; } = new();
    }
    public sealed class RowMeasure
    {
        public string? key { get; set; }
        public double y { get; set; }
        public double h { get; set; }
    }

    [JSInvokable]
    public void OnGridLayoutChanged(OverlayMeasure m)
    {
        _overlayHeightPx = m.overlayHeight;

        // Map measurements back into your model
        // Example: dictionary by row.Id or whatever your key is
        var map = m.rows
            .Where(r => r.key is not null)
            .ToDictionary(r => r.key!, r => (r.y, r.h));

        foreach (var row in _rows)
        {
            var key = row.Idx.ToString();
            if (map.TryGetValue(key, out var v))
            {
                row.CachedY = v.y;
                row.CachedHeight = v.h;
            }
        }

        InvokeAsync(StateHasChanged);
    }

    // this should be updated for new characters
    private string GetTypeOfExtraSlot()
    {
        string? Template = _characterPanel?.SelectedHeroInfo?.Template;
        if (Template != null && HeroTemplateData.Map.ContainsKey(Template))
        {
            return (HeroTemplateData.Map[Template].ExtraType);
        }

        return "None";
    }

    private bool IsWeaponSetValid(string set)
    {
        string? Template = _characterPanel?.SelectedHeroInfo?.Template;
        if (Template != null && HeroTemplateData.Map.ContainsKey(Template))
        {
            string ValidWeapons = HeroTemplateData.Map[Template].WeaponType;
            return ValidWeapons.Contains(set);
        }
        return false;
    }


    private void ClearAllSelections()
    {

        List<ItemViewRow>? equippedItems = _characterPanel?.EquippedItems.Values.ToList();
        if (equippedItems is null)
            return;

        foreach ( var v in equippedItems )
            DeselectRow(v);       
    }

    private void DeselectRow( ItemViewRow row )
    {
        if (row.CurrentEquippedSlot == "") return;

        _characterPanel?.ChangeEquipment(row.CurrentEquippedSlot, null);
        row.CurrentEquippedSlot = "";        
        UpdateEquipmentRatingAndType();        
    }

    private void SelectRow( ItemViewRow row )
    {
        if (row.CurrentEquippedSlot != "") return;
        if (_characterPanel == null) return;

        string extra = GetTypeOfExtraSlot();
        string itemType = row.Type;

        // can't select weapons that you can't equip
        if (itemType == "Weapon" && !IsWeaponSetValid(row.Set))
            return;

        if ((itemType == "Unknown") || (itemType == "") || (itemType == "Currency")) return;
        if ((itemType == "Shield") && (extra != "Shield")) return;
        if (itemType == "Shield") { itemType = "Extra"; }

        if (_characterPanel.EquippedItems.ContainsKey(itemType) && (itemType == extra ))
            itemType = "Extra";



        if (_characterPanel.EquippedItems.ContainsKey(itemType))
            DeselectRow(_characterPanel.EquippedItems[itemType]);

        _characterPanel?.ChangeEquipment(itemType, row);        
        row.CurrentEquippedSlot = itemType;
        UpdateEquipmentRatingAndType();
    }

    private bool IsSelected( ItemViewRow row)
    {
        return (row.CurrentEquippedSlot != "");
    }

    private void OnRowClicked( ItemViewRow row )
    {
        if (IsSelected(row))
            DeselectRow(row);
        else
            SelectRow(row);        
    }

    // ======= search filter ==========
    private string SearchHelp =
            @"Search syntax
    • Simple Usage (Direct search)
        Dragon → Name must contain ""Dragon""

    • Advanced Usage (Fields) 
        Ab1>=500 → Ab1 is larger or equal to 500 (must not have spaces)
        Location:ItemBox  → Location contains ""ItemBox""
        -Best:Hermit → Exclude items that are best for hermit (dash negates)

    Fields
    <i>THP, TDmg, TRate, TRange, HHP, HDmg, HRate, HSpeed,
    Ab1, Ab2, ResG, ResP, ResF, ResL, Location, Quality, 
    Rating, Sides, Lvl, MaxLvl, ResSum, ResAvg, Value, Name</i>";

    private string[] ValidTags =
 {
    "location", "value", "quality", "rating", "lvl", "maxlvl", "set", "type", "best", "sides",
    "thp", "tdmg", "trate", "trange", "hhp", "hdmg", "hrate", "hspd", "ab1", "ab2",
    "ressum", "resavg", "resg", "resp", "resf", "resl", "name"
};

    static string[] Tokenize(string input)
    {
        var tokens = new List<string>();

        var regex = new Regex(
            @"(?<token>-?\w+(?:<=|>=|!=|==|<|>|:)=?""[^""]*"")|""[^""]*""|\S+",
            RegexOptions.Compiled);

        foreach (Match m in regex.Matches(input))
        {
            string token = m.Value;

            // Strip quotes ONLY around the value, not the whole token
            if (token.Contains(":\""))
            {
                int i = token.IndexOf(":\"", StringComparison.Ordinal);
                token = token.Substring(0, i + 1) + token.Substring(i + 2, token.Length - i - 3);
            }
            else if (token.StartsWith("\"") && token.EndsWith("\""))
            {
                token = token.Substring(1, token.Length - 2);
            }

            tokens.Add(token);
        }

        return tokens.ToArray();
    }

    private sealed class SearchCondition
    {
        public string GroupKey = "";   // used for grouping (same tag => OR)
        public string Tag = "";        // actual normalized tag
        public string Op = ":";        // operator found
        public string DefaultOp = "="; // default when Op is ":"
        public bool Negate;
        public string ValueString = "";
        public int ValueNum;
    }

    private string NormalizeTag(string rawTag)
    {
        string t = rawTag.ToLowerInvariant();

        // IMPORTANT: string.Replace returns a new string; you must assign it back.
        t = t.Replace("damage", "dmg");
        t = t.Replace("tower", "t");
        t = t.Replace("hero", "h");
        t = t.Replace("ability", "ab");
        t = t.Replace("health", "hp");
        t = t.Replace("level", "lvl");
        t = t.Replace("resistance", "res");
        t = t.Replace("resist", "res");
        t = t.Replace("speed", "spd");

        // find actual tag (exact match preferred; fallback to contains for short aliases)
        for (int i = 0; i < ValidTags.Length; i++)
        {
            if (ValidTags[i].Equals(t, StringComparison.OrdinalIgnoreCase))
                return ValidTags[i];
        }
        for (int i = 0; i < ValidTags.Length; i++)
        {
            if (ValidTags[i].Contains(t, StringComparison.OrdinalIgnoreCase))
                return ValidTags[i];
        }

        return "";
    }

    private static bool CompareOp(int compareValue, string op, string defaultOp)
    {
        if (op == ":") op = defaultOp;

        return op switch
        {
            ">=" => compareValue >= 0,
            "<=" => compareValue <= 0,
            ">" => compareValue > 0,
            "<" => compareValue < 0,
            "=" => compareValue == 0,
            "==" => compareValue == 0,
            "!=" => compareValue != 0,
            _ => true
        };
    }

    private bool EvaluateString(string itemValue, SearchCondition c)
    {
        bool isMatch;

        // Use : for partial (Contains), = or == for exact
        if (c.Op == ":")
        {
            isMatch = itemValue.Contains(c.ValueString, StringComparison.InvariantCultureIgnoreCase);
        }
        else // Handles =, ==, and default
        {
            isMatch = itemValue.Equals(c.ValueString, StringComparison.InvariantCultureIgnoreCase);
        }

        return c.Negate ? !isMatch : isMatch;
    }

    private bool EvaluateCondition(ItemViewRow r, SearchCondition c)
    {
        int cmp;

        switch (c.Tag)
        {
            case "thp": cmp = r.Stats[(int)DDStat.TowerHealth].CompareTo(c.ValueNum); break;
            case "tdmg": cmp = r.Stats[(int)DDStat.TowerDamage].CompareTo(c.ValueNum); break;
            case "trate": cmp = r.Stats[(int)DDStat.TowerRate].CompareTo(c.ValueNum); break;
            case "trange": cmp = r.Stats[(int)DDStat.TowerRange].CompareTo(c.ValueNum); break;

            case "hhp": cmp = r.Stats[(int)DDStat.HeroHealth].CompareTo(c.ValueNum); break;
            case "hdmg": cmp = r.Stats[(int)DDStat.HeroDamage].CompareTo(c.ValueNum); break;
            case "hrate": cmp = r.Stats[(int)DDStat.HeroCastRate].CompareTo(c.ValueNum); break;
            case "hspd": cmp = r.Stats[(int)DDStat.HeroSpeed].CompareTo(c.ValueNum); break;

            case "ab1": cmp = r.Stats[(int)DDStat.HeroAbility1].CompareTo(c.ValueNum); break;
            case "ab2": cmp = r.Stats[(int)DDStat.HeroAbility2].CompareTo(c.ValueNum); break;

            case "resg": cmp = r.Resists[0].CompareTo(c.ValueNum); break;
            case "resp": cmp = r.Resists[1].CompareTo(c.ValueNum); break;
            case "resf": cmp = r.Resists[2].CompareTo(c.ValueNum); break;
            case "resl": cmp = r.Resists[3].CompareTo(c.ValueNum); break;

            case "ressum": cmp = (r.Resists[0] + r.Resists[1] + r.Resists[2] + r.Resists[3]).CompareTo(c.ValueNum); break;
            case "resavg": cmp = ((r.Resists[0] + r.Resists[1] + r.Resists[2] + r.Resists[3]) / 4).CompareTo(c.ValueNum); break;

            case "rating": cmp = r.Rating.CompareTo(c.ValueNum); break;
            case "sides": cmp = r.Sides.CompareTo(c.ValueNum); break;
            case "lvl": cmp = r.Level.CompareTo(c.ValueNum); break;
            case "maxlvl": cmp = r.MaxLevel.CompareTo(c.ValueNum); break;
            case "value": cmp = r.Value.CompareTo(c.ValueNum); break;

            case "location": return EvaluateString(r.Location, c);
            case "quality": return EvaluateString(r.Quality, c);
            case "set": return EvaluateString(r.Set, c);
            case "type": return EvaluateString(r.Type, c);
            case "best": return EvaluateString(r.BestFor, c);
            case "name": return EvaluateString(r.Name, c);
            default:
                return true;
        }

        bool ok = CompareOp(cmp, c.Op, c.DefaultOp);
        return c.Negate ? !ok : ok;
    }

    private void ApplySearch(string s)
    {
        _searchText = s;
        // Build conditions first
        var conditions = new List<SearchCondition>();
        string[] tokens = Tokenize(_searchText);

        int freeTokenIndex = 0;

        foreach (string t in tokens)
        {
            string[] parts = Regex.Split(t, @"(<=|>=|<|>|:|=|!=|==)");
            if (parts.Length == 0) continue;

            bool negateTag = false;
            if (!string.IsNullOrEmpty(parts[0]) && parts[0][0] == '-')
            {
                negateTag = true;
                parts[0] = parts[0].Substring(1);
            }

            // No operator: keep legacy behavior (each free token acts like its own AND clause on name)
            if (parts.Length == 1)
            {
                string v = parts[0].Trim();
                if (v.Length == 0) continue;

                conditions.Add(new SearchCondition
                {
                    GroupKey = $"__text__{freeTokenIndex++}", // unique => AND between free tokens (same as before)
                    Tag = "name",
                    Op = ":",
                    DefaultOp = "=",
                    Negate = negateTag,
                    ValueString = v.ToLowerInvariant(),
                    ValueNum = 0
                });

                continue;
            }

            if (parts.Length > 2)
            {
                string tag = NormalizeTag(parts[0]);
                if (string.IsNullOrEmpty(tag)) continue;

                string op = parts[1];
                string valueString = parts[2].Trim().ToLowerInvariant();
                int.TryParse(valueString, out int valueNum);

                // GroupKey is the tag itself => same tag becomes OR
                // (negated conditions are still OR'd within the same tag group)
                conditions.Add(new SearchCondition
                {
                    GroupKey = tag,
                    Tag = tag,
                    Op = op,
                    DefaultOp = (tag is "location" or "quality" or "set" or "type" or "best" or "name") ? "=" : ">",
                    Negate = negateTag,
                    ValueString = valueString,
                    ValueNum = valueNum
                });
            }
        }

        // Evaluate: AND across groups, OR within group
        var groups = conditions.GroupBy(c => c.GroupKey).ToList();

        foreach (var r in _rows)
        {
            bool hide = false;

            foreach (var g in groups)
            {
                bool any = false;
                foreach (var c in g)
                {
                    if (EvaluateCondition(r, c))
                    {
                        any = true;
                        break;
                    }
                }

                if (!any)
                {
                    hide = true; // failed this group => hidden
                    break;
                }
            }

            r.IsHiddenDueToSearch = hide;
        }

        // this will also update our search
        ApplyChipFilters();
    }

    // Equipping! 

    private Task HandleChangedHero()
    {
        // if hero changes, we need to rerun the filters because some are dependent
        ApplyChipFilters();
        return Task.CompletedTask;
    }

    private Task HandleChangedRatingMode()
    {
        string? mode = _characterPanel?.GetRatingMode();
        if ((mode == null) || (mode == ""))
            return Task.CompletedTask;

        SetMode(mode);
        return Task.CompletedTask;
    }

    private Task HandleEquipmentClick( ItemViewRow row )
    {
        // deselect this row
        DeselectRow(row);
        return Task.CompletedTask;
    }

    private Task HandleEquipFromFile()
    {       
        if (_characterPanel == null) 
            return Task.CompletedTask;


        ClearAllSelections();
        if (_characterPanel.SelectedHeroInfo == null)
        {
            return Task.CompletedTask;
        }

        foreach( var v in _characterPanel.SelectedHeroInfo.Equipment)
        {
            if (v.cachedItemRow != null)
                SelectRow(v.cachedItemRow);
        }

        return Task.CompletedTask;
    }

    private Task HandleEquipBest()
    {
        FindAndEquipBestPieces();
        return Task.CompletedTask;
    }

    private Task HandleEquipClear()
    {
        ClearAllSelections();
                
        return Task.CompletedTask;
    }


    // ===== Event Collection Overlay =====


    private sealed record EventCollectionRow(
        string Name,
       string Category,
        int Price,
        int OwnedCount);


    private List<EventCollectionRow> _eventCollection = new();

    private IEnumerable<EventCollectionRow> VisibleEventCollection
    {
        get
        {
            if (_eventCollection.Count == 0)
                return Array.Empty<EventCollectionRow>();

            if (string.IsNullOrWhiteSpace(_eventSearch))
                return _eventCollection;

            var s = _eventSearch.Trim();            
            return _eventCollection.Where(x => ((x.Category != null) && (x.Category.Contains(s, StringComparison.OrdinalIgnoreCase))) || ((x.Name != null) && (x.Name.Contains(s, StringComparison.OrdinalIgnoreCase))));
        }
    }

    // Apply category filter only after the user finishes editing the textbox.
    private void OnEventSearchChanged(ChangeEventArgs e)
    {
        _eventSearch = e.Value?.ToString() ?? "";
        StateHasChanged();
    }

    public void ShowEventCollection()
    {
        RebuildEventCollection();
        _showEventCollection = true;
        StateHasChanged();
    }

    private async void ExportEventCollection()
    {
        if (_eventCollection == null || _eventCollection.Count == 0)
            return;

        // Alphabetical by name
        var lines = _eventCollection
            .OrderBy(x => x.Name, StringComparer.OrdinalIgnoreCase)
            .Select(x => $"{x.Name}\t{x.OwnedCount}");

        var text = string.Join(Environment.NewLine, lines);

        await JS.InvokeVoidAsync("copyToClipboard", text);
    }

    private void CloseEventCollection()
    {
        _showEventCollection = false;
        _eventSearch = "";
        StateHasChanged();
    }


    private string ShowUpgradesToMaxResist( ItemViewRow r )
    {
        int upgradesRequiredForResists = Ratings.GetUpgradesRequired(r.ResistanceTarget, r.Resists[0], r.Resists[1], r.Resists[2], r.Resists[3]);
        int overcappedUpgradesLeft = (r.MaxLevel - r.Level) / 10;
        int overcappedUpgradesNeeded =
            (r.ResistanceTarget - ((r.Resists[0] < 23) ? 23 : r.Resists[0])) +
            (r.ResistanceTarget - ((r.Resists[1] < 23) ? 23 : r.Resists[1])) +
            (r.ResistanceTarget - ((r.Resists[2] < 23) ? 23 : r.Resists[2])) +
            (r.ResistanceTarget - ((r.Resists[3] < 23) ? 23 : r.Resists[3]));

        if ((overcappedUpgradesLeft < overcappedUpgradesNeeded) || ( upgradesRequiredForResists > (r.MaxLevel - r.Level)))        
            return "Can't cap with remaining levels";
        else if (upgradesRequiredForResists == 0)
            return "";        
        return $"{upgradesRequiredForResists} levels required for cap";
    }



    private static (string Page, string Section) SplitCategory(string category)
    {
        if (string.IsNullOrWhiteSpace(category)) return ("Other", "");

        var parts = category.Split('>');
        var page = (parts.Length > 0 ? parts[0] : category).Trim();
        var section = (parts.Length > 1 ? parts[1] : "").Trim();
        if (page.Equals("Unknown", StringComparison.OrdinalIgnoreCase)) page = "Unknown";
        return (string.IsNullOrWhiteSpace(page) ? "Other" : page, section);
    }


    // Desired category ordering for the Event Collection overlay
    private static readonly string[] _eventCategoryOrder = new[]
    {
        "Weapons > Apprentice",
        "Weapons > Huntress",
        "Weapons > Monk",
        "Weapons > Squire",
        "Weapons > Exclusive",

        "Accessories > High End Hats",
        "Accessories > High End Masks",
        "Accessories > High End Bracers",
        "Accessories > Mid End Hats",
        "Accessories > Mid End Masks",
        "Accessories > Mid End Bracers",
        "Accessories > Hats",
        "Accessories > Shields",
        "Accessories > Masks",
        "Accessories > Bracers",
        "Accessories > Armor Pieces",
        "Accessories > Exclusive Armor Pieces",
        "Accessories > Exclusives",

        "Pets > Guardians",
        "Pets > Streamer",
        "Pets > DPS",
        "Pets > Builder",
        "Pets > Collectibles",
        "Pets > Exclusives",

        "Unknown",
    };

    private static readonly Dictionary<string, int> _eventCategoryOrderMap = BuildEventCategoryOrderMap();

    private static Dictionary<string, int> BuildEventCategoryOrderMap()
    {
        var d = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase);
        for (int i = 0; i < _eventCategoryOrder.Length; i++)
            d[_eventCategoryOrder[i]] = i;
        return d;
    }

    private static string NormalizeCategoryKey(string category)
    {
        if (string.IsNullOrWhiteSpace(category)) return "Unknown";

        var s = category.Trim();
        if (s.Equals("unknown", StringComparison.OrdinalIgnoreCase))
            return "Unknown";

        var parts = s.Split('>');
        if (parts.Length == 1)
            return parts[0].Trim();

        var page = parts[0].Trim();
        var section = parts.Length > 1 ? parts[1].Trim() : "";
        if (page.Equals("unknown", StringComparison.OrdinalIgnoreCase)) page = "Unknown";
        return string.IsNullOrWhiteSpace(section) ? page : $"{page} > {section}";
    }

    private static int GetCategoryOrderKey(string category)
    {
        var key = NormalizeCategoryKey(category);
        if (_eventCategoryOrderMap.TryGetValue(key, out var i))
            return i;

        return 10000;
    }

    private void RebuildEventCollection()
    {
        // Total: unique EventItem names in the price guide (guide has duplicates by design)
        var all = EventPriceGuide.HashToEventInfo.Values;

        // Build (unique-name) catalog using the most expensive entry as representative
        var catalog = all
            .GroupBy(x => x.ItemName, StringComparer.OrdinalIgnoreCase)
            .Select(g =>
            {
                var rep = g.OrderByDescending(x => x.Price).First();
                return (Name: rep.ItemName, Category: rep.Category, Price: rep.Price);
            })
            .ToList();

        TotalEventCount = catalog.Count;

        // Owned counts: count how many of your _rows are events, and their hash resolves to an EventItemInfo
        var ownedByName = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase);

        foreach (var r in _rows)
        {
            if (!r.IsEvent) continue;

            if (!ItemHash.TryPhraseToInt30(r.FunHashString, out uint h))
                continue;

            if (!EventPriceGuide.HashToEventInfo.TryGetValue(h, out var info))
                continue;

            ownedByName[info.ItemName] = ownedByName.TryGetValue(info.ItemName, out var c) ? (c + 1) : 1;
        }

        _eventCollection = catalog
            .Select(x => new EventCollectionRow(
                Name: x.Name,
                Category: x.Category,
                Price: x.Price,
                OwnedCount: ownedByName.TryGetValue(x.Name, out var c) ? c : 0))
            .ToList();


/*      var uncollectedEvents = _eventCollection
    .Where(x => x.OwnedCount == 0)
    .ToList();*/
    CollectedEventCount = _eventCollection.Count(x => x.OwnedCount > 0);
    }

    public sealed record UiState(
        int Version = 1,
        string RatingMode = "Builder App",
        string Layout = "5x3",
        bool ShowLivePrices = false,
        bool ShowUpgradedStats = false,
        bool AssumeSetBonuses = false,
        List<string>? SelectedTypes = null,
        List<string>? SelectedSets = null,
        List<string>? SelectedOther = null)
    {
        public List<string> SelectedTypesSafe => SelectedTypes ?? new();
        public List<string> SelectedSetsSafe => SelectedSets ?? new();
        public List<string> SelectedOtherSafe => SelectedOther ?? new();
    }

    static UiState DefaultState() => new(
        Version: 1,
        RatingMode: "Builder App",
        Layout: "5x3",
        ShowLivePrices: false,
        ShowUpgradedStats: false,
        AssumeSetBonuses: false,
        SelectedSets: new() { "Chain", "Mail", "Pristine", "Leather", "Plate" },
        SelectedTypes: new() { "Helmet", "Torso", "Gauntlet", "Boots" },
        SelectedOther: new() { "Exclude Events" }
        );

    private void ApplyUiToFields()
    {
        _selectedMode = _ui.RatingMode;
        _itemboxSize  = _ui.Layout;
        _livePrices   = _ui.ShowLivePrices;

        _selectedTypes = _ui.SelectedTypesSafe.ToList();
        _selectedSets  = _ui.SelectedSetsSafe.ToList();
        _selectedOther = _ui.SelectedOtherSafe.ToList();
        _showUpgradedStats = _ui.ShowUpgradedStats;
        _assumeSetBonuses = _ui.AssumeSetBonuses;

        SetMode(_selectedMode);
        ApplyChipFilters();
    }

    private void SyncFieldsToUi()
    {
        _ui = _ui with
        {
            Version = CurrentUIOptionsVersion,
            RatingMode = _selectedMode,
            Layout = _itemboxSize,
            ShowLivePrices = _livePrices,
            SelectedTypes = _selectedTypes.ToList(),
            SelectedSets = _selectedSets.ToList(),
            SelectedOther = _selectedOther.ToList(),
            ShowUpgradedStats = _showUpgradedStats,
            AssumeSetBonuses = _assumeSetBonuses,
        };

        if (_characterPanel != null) _characterPanel.ShowUpgraded = _showUpgradedStats;
    }

    private string LastLoadedText =>
    _lastLoadedAt is null ? "just now" : Humanize(_lastLoadedAt.Value);

    private static string Humanize(DateTime dt)
    {
        var span = DateTime.Now - dt;
        if (span.TotalSeconds < 30) return "just now";
        if (span.TotalMinutes < 1) return $"{(int)span.TotalSeconds} seconds ago";
        if (span.TotalHours < 1) return $"{(int)span.TotalMinutes} minutes ago";
        if (span.TotalDays < 1) return $"{(int)span.TotalHours} hours ago";
        return $"{(int)span.TotalDays} days ago";
    }

    private void TogglePrepHelp() => _hideDropzoneHelp = !_hideDropzoneHelp;


    private void OnItemboxSizeChanged(ChangeEventArgs e)
    {
        _itemboxSize = e.Value?.ToString() ?? "5x3";
        QueueSaveUiState();
        StateHasChanged(); // This forces the GetLocation() method to re-run for all rows
    }

    public string GetLocation( ItemViewRow viewRow)
    {
        // no folders for tavern or characters
        if (( viewRow.IndexInFolder == -1) || (viewRow.Location[0] == 'T') || (viewRow.Location[0] == 'C'))
            return viewRow.Location;

        int idx = viewRow.IndexInFolder;
        int itemsPerPage = 15;
        if (_itemboxSize == "5x3") itemsPerPage = 15;
        if (_itemboxSize == "4x3") itemsPerPage = 12;
        if (_itemboxSize == "6x4") itemsPerPage = 24;

        int subFolderItems = (db.SubfolderCount.ContainsKey(viewRow.Location)) ? db.SubfolderCount[viewRow.Location] : 0;

        itemsPerPage-= subFolderItems;
        int pageNumber = (int)(viewRow.IndexInFolder / itemsPerPage) + 1;
        return viewRow.Location + " (" + pageNumber.ToString() + ")";

    }


    public void SetPriceStatus(string stat, bool showLivePrices)
    {
        _status2 = stat;
        _showLivePrices = showLivePrices;
        StateHasChanged();        

    }

    // TOOLTIPS GO HERE

    private static readonly Dictionary<string, string> Tips = new()
    {  
        ["Rating"] =    "Rating for the given selected\n stats.  Small number is sides.",
        ["Value"] =     "Stars show how good this item is at what it does best, compared to the rest of your equipment. CV is estimated trade value.",
        ["Location"] =  "Location (and page) of item when sorting by Level."
    };

    // Note: filtering is now driven by FilterChips selections (SelectedTypes/SelectedSets/SelectedOther)
    // instead of a bitflag enum.

    private readonly List<ModeOption> _modeOptions = new()
    {
        new("Builder Stats", "Builder Stats"),
        new("Hero Stats", "Hero Stats"),
        new("Builder App", "Builder App"),
        new("Builder Hermit", "Builder Hermit"),
        new("Builder TRange", "Builder TRange"),
        new("Builder EV", "Builder EV"),
        new("Builder Summoner", "Builder Summoner"),
        new("AB1 Only", "AB1 Only"),
        new("DPS AB1", "DPS AB1"),
        new("DPS AB2", "DPS AB2"),
        new("Pure DPS", "Pure DPS"),        
        new("Gunwitch", "Gunwitch"),        
        new("Guardian Summoner", "Guardian Summoner"),
        //new("Best Rating", "Best Rating")
    };

    private (string text, string icon, string tooltip) GetValueDisplay(ItemViewRow row)
    {
        if (row.IsEvent && (row.Value == 0))
        {
            return ("💎 ???", "", "");
        }

        if (row.Value > 0)
        {
            if (row.Value > 300)
                return ("💰Auction", "", "Estimated " + row.Value.ToString() + "cv");
            else
                return ("💎" + row.Value.ToString() + "cv", "", "");
        }
        else
        {
            if ((row.Type != "Weapon") && (row.Type != "Pet") && (row.Type != "Currency"))
            {
                if (row.Value > -100) return ("⭐️⭐️⭐️", "", "");// "png/ValueHighest.png");
                else if (row.Value > -200) return ("⭐️⭐️", "", "");// "png/ValueHigh.png");
                else if (row.Value > -300) return ("⭐️", "", "");//"png/ValueMid.png");
                else  return ("❌", "", "");// "png/ValueLow.png");               
            }
            return ("", "", "");
        }

    }

    private string _selectedMode = "";

    private bool IsCensorEnabled => _censor;

    private static readonly HashSet<string> ArmorSetNames = new(StringComparer.OrdinalIgnoreCase)
    {
        "Pristine", "Plate", "Chain", "Mail", "Leather", "Zamira"
    };

    private string GetResistValue( ItemViewRow r )
    {
        int value = _showUpgradedStats ?
            (r.UpgradedResists[0] + r.UpgradedResists[1] + r.UpgradedResists[2] + r.UpgradedResists[3]) / 4 :
            (r.Resists[0] + r.Resists[1] + r.Resists[2] + r.Resists[3]) / 4;
        
        if (_assumeSetBonuses)
        {
            value = (value > 0) ? (int)Math.Ceiling(r.SetBonus * value) : value;
        }

        return value.ToString();
    }

    private string GetValue( DDStat stat, ItemViewRow r )
    {
        int value = _showUpgradedStats ? r.UpgradedStats[(int)stat] : r.Stats[(int)stat];

        if (_assumeSetBonuses)
        {
            value = (value > 0) ? (int)Math.Ceiling(r.SetBonus * value) : value;
        }        
       
        string s = value.ToString();

        if ( ((r.Quality == "Ult++") && IsCensorEnabled) ||
            (((r.Quality == "Ult++") || (r.Quality == "Ult+") || (r.Quality == "Ult90") || (r.Quality == "Ult93") || (r.Quality == "Supreme") || (r.Quality == "Transcendent"))
              && ((r.Name == "Unicorn") || (r.Name == "Rainbow Unicorn") || (r.Name == "Propeller Cat"))))
            return s.Substring(0, s.Length - 1) + "x";            
        else
            return s;

    }

    int VisibleCount => _rows.Count(r => !r.IsHidden);
    int TotalCount => _rows.Count;

    private void ApplyChipFilters()
    {
        if (_rows.Count == 0)
            return;

        bool onlyEvents = _selectedOther.Contains("Only Events");
        bool excludeEvents = _selectedOther.Contains("Exclude Events");

        bool excludeEquipped = _selectedOther.Contains("Exclude Other Characters Equipment");

        bool excludeMissingResists = _selectedOther.Contains("Exclude Missing Resists");

        foreach (var v in _rows)
        {
            // ---- Type filtering (OR within the chip group) ----
            bool typeOk;
            if (_selectedTypes.Count == 0)
            {
                typeOk = true; // no selection => include all
            }
            else
            {
                var typeLabel = v.Type switch
                {
                    "Pet" => "Pets",
                    "Weapon" => "Weapons",
                    _ => v.Type
                };

                typeOk = _selectedTypes.Contains(typeLabel);
            }

            // ---- Set filtering (OR within the chip group) ----
            bool setOk;
            if (_selectedSets.Count == 0)
            {
                setOk = true;
            }
            else if (v.IsArmor)
            {
                // Armor: treat Set="Any" as matching any *armor* set selection.
                if (string.Equals(v.Set, "Any", StringComparison.OrdinalIgnoreCase))
                {
                    setOk = _selectedSets.Any(s => ArmorSetNames.Contains(s));
                }
                else
                {
                    setOk = _selectedSets.Contains(v.Set);
                }
            }
            else
            {
                // Non-armor: Set is usually the weapon archetype (Squire/Monk/etc.)
                setOk = _selectedSets.Contains(v.Set) || string.Equals(v.Set, "Any", StringComparison.OrdinalIgnoreCase);
            }

            bool includeItem = typeOk && setOk;

            if (onlyEvents)
                includeItem &= v.IsEvent;
            if (excludeEvents)
                includeItem &= !v.IsEvent;

            if (excludeEquipped && (_characterPanel?.SelectedHeroInfo?.Name != null) && (v.Location != "Character > " + _characterPanel?.SelectedHeroInfo?.Name))
                includeItem &= !v.IsEquipped;

            if (excludeMissingResists)
                includeItem &= !v.IsMissingResists;

            if (v.IsHiddenDueToSearch)
                includeItem = false;

            v.IsHidden = !includeItem;
        }
        QueueSaveUiState();
        RecalculateRatings();
    }

    private string HeaderShadingStyle(DDStat stat)
    {
        // optimize later?
        if (stat == DDStat.HeroResistance)
        {
            return _bRequireResists ? "table-header-primary" : "table-header-none";
        }

        if (_RatingStatsPriority.Contains(stat)) return "table-header-primary";
        if (_SidesStatsPriority.Contains(stat)) return "table-header-secondary";
        return "table-header-none";
    }

    private string CellShadingStyle(DDStat stat)
    {
        if (stat == DDStat.HeroResistance)
        {
            return _bRequireResists ? "cell-stat-primary" : "cell-stat-dimmed";
        }
        if (_RatingStatsPriority.Contains(stat)) return "cell-stat-primary";
        if (_SidesStatsPriority.Contains(stat)) return "cell-stat-side";
        return "cell-stat-dimmed";        
    }

    private void SetMode(string mode)
    {
        if ((mode == null) || (mode == ""))
            return;

        foreach (var v in Ratings.RatingModes)
        {
            if (mode.StartsWith(v.Name))
            {
                _selectedMode = mode;
                _RatingStatsPriority.Clear();
                _RatingStatsPriority.AddRange(v.RatingStatsPriority);
                _SidesStatsPriority.Clear();
                _SidesStatsPriority.AddRange(v.SidesStatsPriority);
                _bRequireResists = v.RequireResists;
            }
        }        

        QueueSaveUiState();
        RecalculateRatings();
    }

    private void TestForBestPiece(string type, string set, int rating, Dictionary<string, int> BestPieces)
    {
        if ( set == "Any" )
        {
            TestForBestPiece(type, "Chain", rating, BestPieces);
            TestForBestPiece(type, "Pristine", rating, BestPieces);
            TestForBestPiece(type, "Plate", rating, BestPieces);
            TestForBestPiece(type, "Mail", rating, BestPieces);
            TestForBestPiece(type, "Leather", rating, BestPieces);
            return;
        }

        string key = set + "_" + type;

        if (BestPieces.ContainsKey(key))
        {
            if (BestPieces[key] < rating)
                BestPieces[key] = rating;
        }
        else
            BestPieces[key] = rating;
    }

    public int EquippedArmorRating = 0;
    public int EquippedArmorSides = 0;
    public string EquippedArmorSet = "";

    private void FindAndEquipBestPieces()
    {
        Dictionary<string, int> BestPieces = new Dictionary<string, int>();

        for (int i = 0; i < _rows.Count; i++)
        {
            var r = _rows[i];       
            if (!r.IsHidden && r.IsEligibleForBest)
                TestForBestPiece(r.Type, r.Set, r.Rating, BestPieces);                            
        }

        // find best armor set
        //-------------------------
        string[] Sets = { "Plate", "Pristine", "Leather", "Mail", "Chain" };
        int[] Scores = new int[5];
        foreach ( var v in BestPieces )
        {
            for (int i = 0; i < 5; i++)
            {
                if (v.Key.StartsWith(Sets[i]))
                {
                    Scores[i] += v.Value;
                }
            }            
        }

        string bestSet = Sets[0];
        int bestScore = Scores[0];
        for (int i = 1; i < 5; i++)
        {
            if (bestScore < Scores[i])
            {
                bestScore = Scores[i];
                bestSet = Sets[i];
            }
        }

        string NameString = "";

        for (int i = 0; i < _rows.Count; i++)
        {
            bool highlight = false;
            var r = _rows[i];
            if (r.IsHidden || !r.IsEligibleForBest) continue;
            if ((r.Set == bestSet) || (r.Set == "Any"))
            {
                string typeString = bestSet + "_" + r.Type;
                if ( BestPieces.ContainsKey(typeString))
                {
                    int rating = BestPieces[typeString];    
                    if (r.Rating == rating)
                    {
                        highlight = true;
                        BestPieces[typeString] = -99999;
                        NameString += r.Name + " ";
                    }
                }                                
            }

            if (highlight)
                SelectRow(_rows[i]);
            else
                DeselectRow(_rows[i]);

        }
        UpdateEquipmentRatingAndType();
    }

    private void UpdateEquipmentRatingAndType()
    {
        if (_characterPanel == null) return;

        string foundSet = "None";
        int totalRating = 0;
        int totalSides = 0;

        foreach( var v in _characterPanel.EquippedItems)
        {
            ItemViewRow row = v.Value;
            if (row == null) continue;

            if ((foundSet == "None") && row.IsArmor)
                foundSet = row.Set;

            if ((foundSet != "None") && row.IsArmor && row.Set != foundSet )
                foundSet = "Mixed";

            totalRating += row.Rating;
            totalSides += row.Sides;
        }

        EquippedArmorRating = totalRating;
        EquippedArmorSides = totalSides;
        EquippedArmorSet = foundSet;
        if (_characterPanel != null)
            _characterPanel.UpdateCharacterTotalStats();
    }

    private void RecalculateRatings()
    {

        for (int i = 0; i < _rows.Count; i++)
        {            
            var r = _rows[i];
            float mult = r.SetBonus;
            int maxR = r.ResistanceTarget;
            int maxStatLevel = r.MaxStat;
            (int rating, int sides) = Ratings.EvalRatingAndUpgrades(r, _RatingStatsPriority, _SidesStatsPriority, _bRequireResists);

            _rows[i].Rating = rating;
            _rows[i].Sides = sides;            
        }


        //_summary = $"Best Armor Set: {bestSet} ({bestScore})";
        //-------------------------
        _sortDesc = true;
        _sortColumn = "";
        SortBy("Rating");
        UpdateEquipmentRatingAndType();
    }



    private void ChangeImportance( DDStat stat )
    {
        if (stat == DDStat.HeroResistance)
            _bRequireResists = !_bRequireResists;
        else  if (_RatingStatsPriority.Contains(stat))
        {
            _RatingStatsPriority.Remove(stat);
            _SidesStatsPriority.Add(stat);
        }
        else if (_SidesStatsPriority.Contains(stat))
        {
            _SidesStatsPriority.Remove(stat);
        }
        else
        {
            _RatingStatsPriority.Add(stat);
        }

        // tie breaker of order in table
        _RatingStatsPriority.Sort();


        RecalculateRatings();

    }

    private string GetImportanceImage( DDStat stat )
    {       
        if (stat == DDStat.HeroResistance)
        {
            return _bRequireResists ? "png/importance-rating.png" : "png/importance-none.png";
        }

        if (_RatingStatsPriority.Contains(stat))
            return "png/importance-rating.png";
        if (_SidesStatsPriority.Contains(stat))
            return "png/importance-side.png";

        return "png/importance-none.png";
    }

    private void SortBy(string column)
    {
        if (_sortColumn == column)
            _sortDesc = !_sortDesc;      // toggle
        else
        {
            _sortColumn = column;
            _sortDesc = true;            // default: desc like WPF “largest first”
        }

        ApplySort();
    }
    private static readonly StringComparer Ci = StringComparer.OrdinalIgnoreCase;

    private void ApplySort()
    {
        int dir = _sortDesc ? -1 : 1;

        int Cmp(int a, int b) => a.CompareTo(b);
        int CmpStr(string? a, string? b) => Ci.Compare(a ?? "", b ?? "");

        int Compare(ItemViewRow a, ItemViewRow b)
        {
            int loc = 0;
            if ( _sortColumn == nameof(ItemViewRow.Location))
            {
                loc = CmpStr(a.Location, b.Location); 
                if ( loc == 0) loc = Cmp(a.IndexInFolder, b.IndexInFolder);                
            } 

            int c = _sortColumn switch
            {
                nameof(ItemViewRow.Rating)   => Cmp(a.Rating, b.Rating),
                nameof(ItemViewRow.Value)    => Cmp(a.Value, b.Value),
                nameof(ItemViewRow.BestFor)  => CmpStr(a.BestFor, b.BestFor),
                nameof(ItemViewRow.Level)    => Cmp(a.Level, b.Level),
                nameof(ItemViewRow.MaxLevel) => Cmp(a.MaxLevel, b.MaxLevel),

               nameof(DDStat.HeroHealth) => Cmp(a.Stats[(int)DDStat.HeroHealth], b.Stats[(int)DDStat.HeroHealth]),
               nameof(DDStat.HeroDamage) => Cmp(a.Stats[(int)DDStat.HeroDamage], b.Stats[(int)DDStat.HeroDamage]),
               nameof(DDStat.HeroSpeed) => Cmp(a.Stats[(int)DDStat.HeroSpeed], b.Stats[(int)DDStat.HeroSpeed]),
               nameof(DDStat.HeroCastRate)  => Cmp(a.Stats[(int)DDStat.HeroCastRate], b.Stats[(int)DDStat.HeroCastRate]),
               nameof(DDStat.HeroAbility1)   => Cmp(a.Stats[(int)DDStat.HeroAbility1], b.Stats[(int)DDStat.HeroAbility1]),
               nameof(DDStat.HeroAbility2)   => Cmp(a.Stats[(int)DDStat.HeroAbility2], b.Stats[(int)DDStat.HeroAbility2]),
               nameof(DDStat.TowerHealth)   => Cmp(a.Stats[(int)DDStat.TowerHealth], b.Stats[(int)DDStat.TowerHealth]),
               nameof(DDStat.TowerDamage)  => Cmp(a.Stats[(int)DDStat.TowerDamage], b.Stats[(int)DDStat.TowerDamage]),
               nameof(DDStat.TowerRange) => Cmp(a.Stats[(int)DDStat.TowerRange], b.Stats[(int)DDStat.TowerRange]),
               nameof(DDStat.TowerRate) => Cmp(a.Stats[(int)DDStat.TowerRate], b.Stats[(int)DDStat.TowerRate]),

                nameof(DDStat.HeroResistance) => Cmp(a.Resists[0]+a.Resists[1]+a.Resists[2]+a.Resists[3], b.Resists[0]+b.Resists[1]+b.Resists[2]+b.Resists[3]),

                nameof(ItemViewRow.Name)     => CmpStr(a.Name, b.Name),
                nameof(ItemViewRow.Location) => loc,

                nameof(ItemViewRow.Type)     => CmpStr(a.Type, b.Type),
                nameof(ItemViewRow.Set )    => CmpStr(a.Set, b.Set),

                nameof(ItemViewRow.Quality)  => Cmp(QualityRank(a.Quality), QualityRank(b.Quality)),
                _ => Cmp(a.Rating, b.Rating),
            };

            // primary sort direction
            c *= dir;
            if (c != 0) return c;

            // tie-breakers (desc, like you were doing)
            c = b.Rating.CompareTo(a.Rating);
            if (c != 0) return c;
            c = b.Sides.CompareTo(a.Sides);
            if (c != 0) return c;
            return b.Name.CompareTo(a.Name);
        }

        _rows.Sort(Compare);
    }

    private static int QualityRank(string? q)
    {
        q = (q ?? "").Trim();


        return q switch
        {
            "Ult++" => 7,
            "Ult+" => 6, 
            "Ult93" => 5,
            "Ult90" => 4,
            "Supreme" => 3,
            "Transcendent" => 2,
            "Mythical" => 1,
            _ => 0
        };
    }

    //r.CurrentEquippedSlot, 
    //string currentSelectedSlot, 
    private string GetRowClass(bool h)
    {
        if (h) return "hidden-row";
        //if (currentSelectedSlot != "") return "selected";
        return "";
    }


    private static string QualityClass(string quality)
    {
        if (quality == "Ult++") return "cell-quality-ultplusplus";
        else if (quality == "Ult+") return "cell-quality-ultplus";
        else if (quality == "Ult93") return "cell-quality-ult93";
        else if (quality == "Ult90") return "cell-quality-ult90";
        else if (quality == "Supreme") return "cell-quality-supreme";
        else if (quality == "Transcendent") return "cell-quality-transcendent";
        else if (quality == "Mythical") return "cell-quality-mythical";
        else return "cell-quality-default";
    }
    const string UiStateKey = "ddgo.uiState.v1";

    CancellationTokenSource? _saveCts;

    void QueueSaveUiState()
    {
        _saveCts?.Cancel();
        _saveCts = new CancellationTokenSource();
        var token = _saveCts.Token;

        _ = DebouncedSaveAsync(token);
    }

    private async Task DebouncedSaveAsync(CancellationToken token)
    {
        try
        {
            await Task.Delay(500, token);

            // Make sure _ui reflects the latest UI fields
            SyncFieldsToUi();

            var json = JsonSerializer.Serialize(_ui);
            await InvokeAsync(() => JS.InvokeVoidAsync("appState.set", UiStateKey, json));
        }
        catch (OperationCanceledException) { }
        catch (Exception ex)
        {
            // Don’t swallow silently while debugging:
            Console.WriteLine("Save UI state failed: " + ex);
        }
    }
    protected override async Task OnInitializedAsync()
    {
        _dotNetRef = DotNetObjectReference.Create(this);
        // 1) UI state
        var json = await JS.InvokeAsync<string?>("appState.get", UiStateKey);
        if (!string.IsNullOrWhiteSpace(json))
        {
            try { _ui = MigrateAndNormalize(json) ?? DefaultState(); }
            catch { _ui = DefaultState(); }
        }
        else _ui = DefaultState();

        ApplyUiToFields();

        if (await JS.InvokeAsync<bool>("dropzone.supportsHandles"))
        {
            var ok = await JS.InvokeAsync<bool>("dropzone.tryLoadLastHandleAndRead", _dotNetRef); // returns true if it loaded bytes & called into .NET or returned bytes
            if (ok) return;
        }

        var oldFileName = await JS.InvokeAsync<string?>("dropzone.tryLoadCachedFilename"); // from IndexedDB
        var cachedList = await JS.InvokeAsync<int[]?>("dropzone.tryLoadCachedDunBytes");
        var cached = cachedList?.Select(i => (byte)i).ToArray();
        if (cached is { Length: > 0 })
            await LoadDunBytesAsync(oldFileName ??"", cached);
    }


    static UiState NormalizeV1(UiState s)   
    {
        return s with
        {
            SelectedTypes = s.SelectedTypes ?? new(),
            SelectedSets = s.SelectedSets ?? new(),
            SelectedOther = s.SelectedOther ?? new(),
            RatingMode = string.IsNullOrWhiteSpace(s.RatingMode)
                ? "Builder App"
                : s.RatingMode,
            Layout = string.IsNullOrWhiteSpace(s.Layout)
                ? "5x3"
                : s.Layout
        };
    }

    static UiState MigrateAndNormalize(string json)
    {
        UiState? state;

        try
        {
            state = JsonSerializer.Deserialize<UiState>(json);
        }
        catch
        {
            return DefaultState();
        }

        if (state is null)
            return DefaultState();

        return state.Version switch
        {
            1 => NormalizeV1(state),
            _ => DefaultState() // unknown future version
        };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        _dotNetRef = DotNetObjectReference.Create(this);

        if (firstRender)
        {
            await JS.InvokeVoidAsync("dropzone.init", _dropZoneId, _dotNetRef);            
            var supports = await JS.InvokeAsync<bool>("dropzone.supportsHandles");
            _canLoadLast = supports && await JS.InvokeAsync<bool>("dropzone.hasLast");
            StateHasChanged();
            await JS.InvokeVoidAsync("atlasIcons.init", "png/HeroEquipment_Atlas.png"); // set your atlas path
            await JS.InvokeVoidAsync("atlasIcons.startAutoRender");
            _atlasReady = true;

            StateHasChanged();
        }

        if (_showContent && !_overlayObserversStarted)
        {
            _overlayObserversStarted = true;
            await JS.InvokeVoidAsync("gridOverlayObservers.start", _scrollRef, _tableRef, _dotNetRef);
        }

        if (_needsAtlasRender && _showContent && _atlasReady )
        {
            _needsAtlasRender = false;
            await JS.InvokeVoidAsync("atlasIcons.renderAllCached");
        }   

    }

    public async ValueTask DisposeAsync()
    {
        try { await JS.InvokeVoidAsync("gridOverlayObservers.stop", _scrollRef); } catch { }
        _dotNetRef?.Dispose();
    }

    // Called by JS when user drags over / leaves to let us style the dropzone
    [JSInvokable]
    public void SetDragOver(bool isOver)
    {
        if (_isDragOver == isOver) return;
        _isDragOver = isOver;
        StateHasChanged();
    }


    public async Task LoadDunBytesAsync(string fileName, byte[] bytes)
    {
        _loadedFileName = fileName;
        _lastLoadedAt = DateTime.Now;        
        _error = null;
        _isLoading = true;
        _status = $"Reading {fileName}…";
        await db.LoadFromDun(bytes);
        if (!db.IsReady)
        {
            _error = db.Status;               
        }
        else
        {
            _status = db.Status;
            _rows.Clear();
            Ratings.ClearBestRatings();
            for (int i =0; i < db.Items.Count; i++)
            {
                ItemViewRow itemViewRow = db.Items[i].ToItemViewRow();
                _rows.Add(itemViewRow);

                (int value, itemViewRow.BestFor) = Ratings.GetBestValue(true, itemViewRow);

                // don't override set event values
                if ( itemViewRow.Value == 0)
                    itemViewRow.Value = value;
            }            
            // now go through and get relative value
            foreach( var v in _rows )
            {
                // only override if we don't have a value yet
                if (v.Value == 0)
                {
                    // calculate relative rating for value (goes from -1000 to 0)
                    (v.Value, v.BestFor) = Ratings.GetBestValue(false, v);
                }
            }

            // Event collection counts + overlay data (unique names in guide, plus your owned counts)
            RebuildEventCollection();

            CalculateVanityTotals();
            SetPriceStatus("Prices estimated by table", true);
            // don't care about when it gets back              

            _showContent = true;
            _needsAtlasRender = true;
            await InvokeAsync(StateHasChanged);
            if (_characterPanel != null)
                _characterPanel.ShowUpgraded = _showUpgradedStats;
            _characterPanel?.Reload(db.Heroes);
            ApplyChipFilters();
        }
    }

    // Called by JS after it reads the dropped file as base64
    [JSInvokable]
    public async Task OnFileDropped(string fileName, byte[] bytes)
    {
        
        StateHasChanged();

        try
        {
            _status = $"Parsing {fileName} ({bytes.Length:N0} bytes)";
            StateHasChanged();
            await LoadDunBytesAsync(fileName, bytes);
        }
        catch (Exception ex)
        {
            _showContent = false;            
            _error = $"Error: {ex.Message} {db.Status}";
            _isLoading = false;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private string SortGlyph(string col)
    {
        if (_sortColumn != col) return "";
        return _sortDesc ? "▼" : "▲";
    }

    private void OnButtonClicked()
    {
        // Example: you’ll replace with your own action
        _status = $"Button clicked at {DateTime.Now:T}";

    }

    public int ArmorTotalValue = 0;
    public int EventTotalValue = 0;

    public void CalculateVanityTotals()
    {
        int at = 0;
        int et = 0;
        foreach  (var v in _rows)
        {
            if ( v.IsArmor && !v.IsEvent && v.Value > 0)
                at += v.Value;
            if ( v.IsEvent && v.Value > 0)
                et += v.Value;
        }
        ArmorTotalValue = at;
        EventTotalValue = et;
    }


    public string GetFunHash(ItemViewRow ivr)
    {
        return ivr.FunHashString;
    }

    private void GetLivePrices()
    {
        _ = Ratings.AsyncShiroPriceAPICall(this);        
    }
    private async Task LoadLastFile()
    {
        _error = null;
        _status = "";
        _status2 = "";

        // Only returns true in Chrome/Edge *and* if a handle was saved before.
        bool ok = await JS.InvokeAsync<bool>("dropzone.loadLast", _dotNetRef);

        if (!ok)
        {
            _status = "No remembered file yet (or the browser blocked access). Drop the file once, or use the Open button.";
            StateHasChanged();
        }
    }
    private async Task OpenFileDialog()
    {
        _error = null;
        _status = "";
        _status2 = "";
        StateHasChanged();

        // Opens file picker, reads bytes in JS, then calls OnFileDropped(fileName, bytes)
        bool ok = await JS.InvokeAsync<bool>("dropzone.pickFile", _dotNetRef);

        if (!ok)
        {
            _status = "No file selected.";
            StateHasChanged();
        }
    }
}
